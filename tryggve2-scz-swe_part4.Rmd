---
title: "Tryggve2 - Schizophrenia - Sweden - Part 4"
author: "Kaarina Kowalec, kaarina.kowalec@ki.se"
date: "March 2019"
output: 
  html_document: 
    fig_caption: yes
    theme: simplex
    highlight: zenburn
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Motivation and Overview

NOTE: NOT RUN

Examine variables associated with poor outcomes in schizophrenia, using first, the Swedish National Registers. In this report, I will present some initial coding for the analyses.

**Overview**

1. Import data
2. Create a dataframe with all necessary variables including exposures and outcomes
3. Analyses

***

### Step 0: Load R packages
```{r R packages}
library(tidyverse)
library(survival)
library(broom)
library(kableExtra)
library(lubridate)
library(pROC)

Sys.setenv(TZ="Europe/Stockholm")
```

### Step 1: Limit to study cohort
```{r}
# birth cohort & SCZ 2x dx case definition
scz <- scz %>%
  mutate(birthyear = str_extract(dob,"[:digit:]{4}"))

scz$birthyear <- as.numeric(scz$birthyear)

studypop <- scz %>% 
  filter(!is.na(second_scz_date) &
           birth.country == "Sweden" &
           !is.na(swe.birth.county) &
           birthyear %in% c(1958:1993) &
           case.exclu == 0)

#CATEGORICAL VARIABLES - combine psych variables
studypop <- studypop %>%
  mutate(psych_childhood = case_when(bip.childhood == 1 |
                                       anx.childhood == 1 |
                                       ptsd.childhood == 1 |
                                       adhd.childhood == 1 |
                                       ed.childhood == 1 |
                                       sui.childhood == 1 |
                                       ocd.childhood == 1 |
                                       suds.childhood == 1 |
                                       asd.childhood == 1 |
                                       mdd.childhood == 1 ~ 1,
                                     bip.childhood == 0 |
                                       anx.childhood == 0 |
                                       ptsd.childhood == 0 |
                                       adhd.childhood == 0 |
                                       ed.childhood == 0 |
                                       sui.childhood == 0 |
                                       ocd.childhood == 0 |
                                       suds.childhood == 0 |
                                       asd.childhood == 0 |
                                       mdd.childhood == 0 ~ 0,
                                     TRUE ~ 0))

studypop <- studypop %>%
  mutate(psych_pre.scz = case_when(bip.pre.scz == 1 |
                                     anx.pre.scz == 1 |
                                     ptsd.pre.scz == 1 |
                                     adhd.pre.scz == 1 |
                                     ed.pre.scz == 1 |
                                     sui.pre.scz == 1 |
                                     ocd.pre.scz == 1 |
                                     suds.pre.scz == 1 |
                                     asd.pre.scz == 1 |
                                     mdd.pre.scz == 1 ~ 1,
                                   bip.pre.scz == 0 |
                                     anx.pre.scz == 0 |
                                     ptsd.pre.scz == 0 |
                                     adhd.pre.scz == 0 |
                                     ed.pre.scz == 0 |
                                     sui.pre.scz == 0 |
                                     ocd.pre.scz == 0 |
                                     suds.pre.scz == 0 |
                                     asd.pre.scz == 0 |
                                     mdd.pre.scz == 0 ~ 0,
                                   TRUE ~ 0))

studypop <- studypop %>%
  mutate(psych_fhx = case_when(fhx.scz == 1 |
                                 fhx.bp == 1 |
                                 fhx.anx == 1 |
                                 fhx.ptsd == 1 |
                                 fhx.adhd == 1 |
                                 fhx.ed == 1 |
                                 fhx.sui == 1 |
                                 fhx.ocd == 1 |
                                 fhx.suds == 1 |
                                 fhx.asd == 1 |
                                 fhx.mdd == 1 ~ 1,
                               fhx.scz == 0 |
                                 fhx.bp == 0 |
                                 fhx.anx == 0 |
                                 fhx.ptsd == 0 |
                                 fhx.adhd == 0 |
                                 fhx.ed == 0 |
                                 fhx.sui == 0 |
                                 fhx.ocd == 0 |
                                 fhx.suds == 0 |
                                 fhx.asd == 0 |
                                 fhx.mdd == 0 ~ 0,
                               TRUE ~ 0)
  )
```
### Step 2: Derive outcomes for analysis
need a variable indicating which outcome was first reached & time to reach 
need to reshape data such that each individual has multiple rows outcomes dataframe
focus on outcomes #1-5 (clinically relevant for now)

```{r}
## outcome 1 = suicide attempt or completed
suicide <- studypop %>%
  select(-date.outcome3:-outcome9) %>% 
  #removed outcome6-CVD, outcome8=sicknesspension, outcome9-divorce, outcome7-income support-for now
  arrange(id) %>%
  mutate(end.follow = ymd("2014-12-31")) %>%
  gather("date.outcome1","date.outcome2", "dod",
         "first.emigrate.date","end.follow",
         key = "outcome",
         value = "date") %>%
  select(id, outcome1:date, scz:z_edlevel) %>%
  arrange(id,date) %>%
  group_by(id) %>%
  mutate(date.sui.reached = first(date)) %>%
#  select(id, date.outcome.reached, outcome1:outcome2,outcome:first_scz_date) %>%
  slice(1) %>%
  mutate(time_sui = as.numeric(date.sui.reached - first_scz_date)/365.25) %>% # calculate time 
  filter(time_sui >= 0) # remove people who emigrated before reached outcome

suicide$outcome <- as.factor(suicide$outcome)

suicide <- suicide %>%
  mutate(suicide_yn = ifelse(outcome!="end.follow" & outcome!="dod" &
                            outcome!="first.emigrate.date", 1, 0),
         suicide_yn_cat = case_when(outcome=="date.outcome1"~"suicide.attempt",
                             outcome=="date.outcome2"~"suicide.complete",
                            # outcome=="date.outcome3"~"premature.mortality",
                            # outcome=="date.outcome4"~"hospitalised.100days",
                            # outcome=="date.outcome5"~"clozapine.prescrip",
                            # outcome=="date.outcome7"~"income.support",
                            # outcome=="date.outcome9"~"divorce",             
                             outcome=="dod"~"died(not premature)",
                             outcome=="end.follow"~"end.of.follow",
                             outcome=="first.emigrate.date"~"emigrated",
                             TRUE ~ NA_character_)
  ) %>%
  select(id,date.sui.reached,time_sui,suicide_yn,suicide_yn_cat)

# merge back w exposures
analysis <- left_join(suicide,studypop)
```

### Step 2a: Derive individual outcomes for analysis (premature mortality)
```{r}
## outcome 2 = premature.mortality
pdeath <- studypop %>%
  select(-date.outcome4:-outcome9) %>% 
  #removed outcome6-CVD, outcome8=sicknesspension, outcome9-divorce, outcome7-income support-for now
  arrange(id) %>%
  mutate(end.follow = ymd("2014-12-31")) %>%
  gather("date.outcome3", "dod",
         "first.emigrate.date","end.follow",
         key = "outcome",
         value = "date") %>%
  select(id, outcome3:date, scz:z_edlevel) %>%
  arrange(id,date) %>%
  group_by(id) %>%
  mutate(date.pd.reached = first(date)) %>%
#  select(id, date.outcome.reached, outcome1:outcome2,outcome:first_scz_date) %>%
  slice(1) %>%
  mutate(time_pd = as.numeric(date.pd.reached - first_scz_date)/365.25) %>% # calculate time 
  filter(time_pd >= 0) # remove people who emigrated before reached outcome

pdeath$outcome <- as.factor(pdeath$outcome)

pdeath <- pdeath %>%
  mutate(pd_yn = ifelse(outcome!="end.follow" & outcome!="dod" &
                            outcome!="first.emigrate.date", 1, 0),
         pd_yn_cat = case_when(#outcome=="date.outcome1"~"suicide.attempt",
                            # outcome=="date.outcome2"~"suicide.complete",
                             outcome=="date.outcome3"~"premature.mortality",
                            # outcome=="date.outcome4"~"hospitalised.100days",
                            # outcome=="date.outcome5"~"clozapine.prescrip",
                            # outcome=="date.outcome7"~"income.support",
                            # outcome=="date.outcome9"~"divorce",             
                             outcome=="dod"~"died(not premature)",
                             outcome=="end.follow"~"end.of.follow",
                             outcome=="first.emigrate.date"~"emigrated",
                             TRUE ~ NA_character_)
  ) %>%
  select(id,date.pd.reached,time_pd,pd_yn,pd_yn_cat)

# merge back w exposures
analysis <- left_join(pdeath,analysis)
```

### Step 2b: Derive individual outcomes for analysis (hospitalised 100 days)
```{r}
## outcome 4= hospitalised.100days
hsp <- studypop %>%
  select(-date.outcome5:-outcome9) %>% 
  #removed outcome6-CVD, outcome8=sicknesspension, outcome9-divorce, outcome7-income support-for now
  arrange(id) %>%
  mutate(end.follow = ymd("2014-12-31")) %>%
  gather("date.outcome4", "dod",
         "first.emigrate.date","end.follow",
         key = "outcome",
         value = "date") %>%
  select(id, outcome4:date, scz:z_edlevel) %>%
  arrange(id,date) %>%
  group_by(id) %>%
  mutate(date.hsp.reached = first(date)) %>%
#  select(id, date.outcome.reached, outcome1:outcome2,outcome:first_scz_date) %>%
  slice(1) %>%
  mutate(time_hsp = as.numeric(date.hsp.reached - first_scz_date)/365.25) %>% # calculate time 
  filter(time_hsp >= 0) # remove people who emigrated before reached outcome

hsp$outcome <- as.factor(hsp$outcome)

hsp <- hsp %>%
  mutate(hsp_yn = ifelse(outcome!="end.follow" & outcome!="dod" &
                            outcome!="first.emigrate.date", 1, 0),
         hsp_yn_cat = case_when(#outcome=="date.outcome1"~"suicide.attempt",
                            # outcome=="date.outcome2"~"suicide.complete",
                             #outcome=="date.outcome3"~"premature.mortality",
                            outcome=="date.outcome4"~"hospitalised.100days",
                            # outcome=="date.outcome5"~"clozapine.prescrip",
                            # outcome=="date.outcome7"~"income.support",
                            # outcome=="date.outcome9"~"divorce",             
                             outcome=="dod"~"died(not premature)",
                             outcome=="end.follow"~"end.of.follow",
                             outcome=="first.emigrate.date"~"emigrated",
                             TRUE ~ NA_character_)
  ) %>%
  select(id,date.hsp.reached,time_hsp,hsp_yn,hsp_yn_cat)

# merge back w exposures
analysis <- left_join(hsp,analysis)
```
### Step 2c: Derive individual outcomes for analysis (clozapine.prescrip)
```{r}
## outcome 5= clozapine.prescrip
trs <- studypop %>%
  select(-date.outcome6:-outcome9) %>% 
  #removed outcome6-CVD, outcome8=sicknesspension, outcome9-divorce, outcome7-income support-for now
  arrange(id) %>%
  mutate(end.follow = ymd("2014-12-31")) %>%
  gather("date.outcome5", "dod",
         "first.emigrate.date","end.follow",
         key = "outcome",
         value = "date") %>%
  select(id, outcome5:date, scz:z_edlevel) %>%
  arrange(id,date) %>%
  group_by(id) %>%
  mutate(date.trs.reached = first(date)) %>%
#  select(id, date.outcome.reached, outcome1:outcome2,outcome:first_scz_date) %>%
  slice(1) %>%
  mutate(time_trs = as.numeric(date.trs.reached - first_scz_date)/365.25) %>% # calculate time 
  filter(time_trs >= 0) # remove people who emigrated before reached outcome

trs$outcome <- as.factor(trs$outcome)

trs <- trs %>%
  mutate(trs_yn = ifelse(outcome!="end.follow" & outcome!="dod" &
                            outcome!="first.emigrate.date", 1, 0),
         trs_yn_cat = case_when(#outcome=="date.outcome1"~"suicide.attempt",
                            # outcome=="date.outcome2"~"suicide.complete",
                             #outcome=="date.outcome3"~"premature.mortality",
                            #outcome=="date.outcome4"~"hospitalised.100days",
                             outcome=="date.outcome5"~"clozapine.prescrip",
                            # outcome=="date.outcome7"~"income.support",
                            # outcome=="date.outcome9"~"divorce",             
                             outcome=="dod"~"died(not premature)",
                             outcome=="end.follow"~"end.of.follow",
                             outcome=="first.emigrate.date"~"emigrated",
                             TRUE ~ NA_character_)
  ) %>%
  select(id,date.trs.reached,time_trs,trs_yn,trs_yn_cat)

# merge back w exposures
analysis <- left_join(trs,analysis)

```


### Step 2: Descriptive tables
```{r}
        
###############################
#CONTINUOUS VARIABLES
studypop.sum.continuous <- analysis %>% 
  group_by(outcome_cat) %>% 
  summarise(
    N=n(), 
    Follow.up.time = round(mean(fu.time),digits=2),
    Number.of.SCZ.contacts = round(mean(nsczcontacts, na.rm=T), digits = 2),
    Number.of.SCZ.inpatient = round(mean(nsczinpt, na.rm=T), digits = 2),
    Number.of.SCZ.outpatient = round(mean(nsczoutpt, na.rm=T), digits = 2),
    Age.at.SCZ.dx = round(mean(age.first.scz, na.rm=T), digits = 2),
    Year9.Grade = round(mean(std.grade, na.rm=T), digits = 2),
    EducationalAttain = round(mean(z_edlevel, na.rm=T), digits = 2),
    Paternal.age = round(mean(paternal_age, na.rm=T), digits = 2),
    Maternal.age = round(mean(maternal_age, na.rm=T), digits = 2)
  ) %>%
  arrange(desc(N)) %>%
  mutate("%" = round((N/13561)*100,digits=2)) %>%
  select(outcome_cat,N,"%","Follow.up.time","Number.of.SCZ.contacts":"Maternal.age")

studypop.sum.continuous <- as.data.frame(t(studypop.sum.continuous))

studypop.sum.continuous <- studypop.sum.continuous %>%
  rename("End of Follow Up"="V1",
         "Long Hospitalisation"="V2",
         "Income support"="V3",
         "Treatment-Resistance"="V4",
         "Suicide attempt"="V5",
         "Premature death"="V6",
         "Divorce"="V7",
         "Suicide completed"="V8",
         "Emigrated"="V9",
         "Died, not premature"="V10")

studypop.sum.continuous = studypop.sum.continuous[-1, ]

studypop.sum.continuous <- studypop.sum.continuous[,c(2,4,5,6,8,3,7,1,9,10)]

kable(studypop.sum.continuous, align = "c", "html") %>%
  kable_styling("striped", full_width = F) %>%
  add_header_above(c(" " = 1, "Outcome reached" = 7, "Did not reach outcomes" = 3)) %>%
  group_rows(" ", 1, 2) %>%
  group_rows("Continuous variables", 3, 8) %>%
  footnote("Based on 13,561 individuals born in Sweden between 1958 and 1993 with schizophrenia or schizoaffective disorder"
  ) 


outcomeN <- analysis %>% 
  group_by(outcome_cat) %>% 
  summarise(
    grpN=n())

sex <- analysis %>%
  filter(sex==1) %>%
  group_by(outcome_cat) %>%
  summarise(Males=n()) 
sex <- left_join(sex,outcomeN)
sex <- sex %>%
  mutate(Males_percent = round((Males/grpN)*100,digits=2),
         Males_percent = sapply(Males_percent,paste0, "%"),
         Males=str_c(Males,Males_percent,sep=", ",collapse = NULL))
         
ai.childhood <- analysis %>%
  filter(ai.childhood==1) %>%
  group_by(outcome_cat) %>%
  summarise(autoimmune.childhood=n()) 
ai.childhood <- left_join(ai.childhood,outcomeN)
ai.childhood <- ai.childhood %>%
  mutate(autoimmune.childhood_percent = round((autoimmune.childhood/grpN)*100,digits=2),
         autoimmune.childhood_percent = sapply(autoimmune.childhood_percent,paste0, "%"),
         autoimmune.childhood=str_c(autoimmune.childhood,autoimmune.childhood_percent,sep=", ",collapse = NULL)
  )

ai.pre.scz <- analysis %>%
  filter(ai.pre.scz==1) %>%
  group_by(outcome_cat) %>%
  summarise(ai.pre.scz=n())
ai.pre.scz <- left_join(ai.pre.scz,outcomeN)
ai.pre.scz <- ai.pre.scz %>%
  mutate(ai.pre.scz_percent = round((ai.pre.scz/grpN)*100,digits=2),
         ai.pre.scz_percent = sapply(ai.pre.scz_percent,paste0, "%"),
         ai.pre.scz=str_c(ai.pre.scz,ai.pre.scz_percent,sep=", ",collapse = NULL)
  )

cvd.childhood <- analysis %>%
  filter(cvd.childhood==1) %>%
  group_by(outcome_cat) %>%
  summarise(cvd.childhood=n()) 
cvd.childhood <- left_join(cvd.childhood,outcomeN)
cvd.childhood <- cvd.childhood %>%
  mutate(cvd.childhood_percent = round((cvd.childhood/grpN)*100,digits=2),
         cvd.childhood_percent = sapply(cvd.childhood_percent,paste0, "%"),
         cvd.childhood=str_c(cvd.childhood,cvd.childhood_percent,sep=", ",collapse = NULL)
  )

cvd.pre.scz <- analysis %>%
  filter(cvd.pre.scz==1) %>%
  group_by(outcome_cat) %>%
  summarise(cvd.pre.scz=n())
cvd.pre.scz <- left_join(cvd.pre.scz,outcomeN)
cvd.pre.scz <- cvd.pre.scz %>%
  mutate(cvd.pre.scz_percent = round((cvd.pre.scz/grpN)*100,digits=2),
         cvd.pre.scz_percent = sapply(cvd.pre.scz_percent,paste0, "%"),
         cvd.pre.scz=str_c(cvd.pre.scz,cvd.pre.scz_percent,sep=", ",collapse = NULL)
  )

#strk.childhood <- analysis %>%
#  filter(strk.childhood==1) %>%
 # group_by(outcome_cat) %>%
#  summarise(strk.childhood=n()) 
#strk.childhood <- left_join(strk.childhood,outcomeN)
#strk.childhood <- strk.childhood %>%
 # mutate(strk.childhood_percent = round((strk.childhood/grpN)*100,digits=2),
   #      strk.childhood_percent = sapply(strk.childhood_percent,paste0, "%"),
  #       strk.childhood=str_c(strk.childhood,strk.childhood_percent,sep=", ",collapse = NULL)
  #)

#strk.pre.scz <- analysis %>%
 # filter(strk.pre.scz==1) %>%
  #group_by(outcome_cat) %>%
  #summarise(strk.pre.scz=n()) 
#strk.pre.scz <- left_join(strk.pre.scz,outcomeN)
#strk.pre.scz <- strk.pre.scz %>%
 # mutate(strk.pre.scz_percent = round((strk.pre.scz/grpN)*100,digits=2),
  #       strk.pre.scz_percent = sapply(strk.pre.scz_percent,paste0, "%"),
   #      strk.pre.scz=str_c(strk.pre.scz,strk.pre.scz_percent,sep=", ",collapse = NULL)
  #)

cancer.childhood <- analysis %>%
  filter(cancer.childhood==1) %>%
  group_by(outcome_cat) %>%
  summarise(cancer.childhood=n()) 
cancer.childhood <- left_join(cancer.childhood,outcomeN)
cancer.childhood <- cancer.childhood %>%
  mutate(cancer.childhood_percent = round((cancer.childhood/grpN)*100,digits=2),
         cancer.childhood_percent = sapply(cancer.childhood_percent,paste0, "%"),
         cancer.childhood=str_c(cancer.childhood,cancer.childhood_percent,sep=", ",collapse = NULL)
  )

cancer.pre.scz <- analysis %>%
  filter(cancer.pre.scz==1) %>%
  group_by(outcome_cat) %>%
  summarise(cancer.pre.scz=n())
cancer.pre.scz <- left_join(cancer.pre.scz,outcomeN)
cancer.pre.scz <- cancer.pre.scz %>%
  mutate(cancer.pre.scz_percent = round((cancer.pre.scz/grpN)*100,digits=2),
         cancer.pre.scz_percent = sapply(cancer.pre.scz_percent,paste0, "%"),
         cancer.pre.scz=str_c(cancer.pre.scz,cancer.pre.scz_percent,sep=", ",collapse = NULL)
  )

infect.childhood <- analysis %>%
  filter(infect.childhood==1) %>%
  group_by(outcome_cat) %>%
  summarise(infect.childhood=n())
infect.childhood <- left_join(infect.childhood,outcomeN)
infect.childhood <- infect.childhood %>%
  mutate(infect.childhood_percent = round((infect.childhood/grpN)*100,digits=2),
         infect.childhood_percent = sapply(infect.childhood_percent,paste0, "%"),
         infect.childhood=str_c(infect.childhood,infect.childhood_percent,sep=", ",collapse = NULL)
  )

infect.pre.scz <- analysis %>%
  filter(infect.pre.scz==1) %>%
  group_by(outcome_cat) %>%
  summarise(infect.pre.scz=n())
infect.pre.scz <- left_join(infect.pre.scz,outcomeN)
infect.pre.scz <- infect.pre.scz %>%
  mutate(infect.pre.scz_percent = round((infect.pre.scz/grpN)*100,digits=2),
         infect.pre.scz_percent = sapply(infect.pre.scz_percent,paste0, "%"),
         infect.pre.scz=str_c(infect.pre.scz,infect.pre.scz_percent,sep=", ",collapse = NULL)
  )

parental.breavement <- analysis %>%
  filter(parental.breavement==1) %>%
  group_by(outcome_cat) %>%
  summarise(parental.bereavement=n())
parental.breavement <- left_join(parental.breavement,outcomeN)
parental.breavement <- parental.breavement %>%
  mutate(parental.breavement_percent = round((parental.bereavement/grpN)*100,digits=2),
         parental.breavement_percent = sapply(parental.breavement_percent,paste0, "%"),
         parental.bereavement=str_c(parental.bereavement,parental.breavement_percent,sep=", ",collapse = NULL)
  )

psych_childhood <- analysis %>%
  filter(psych_childhood==1) %>%
  group_by(outcome_cat) %>%
  summarise(psych_childhood=n())
psych_childhood <- left_join(psych_childhood,outcomeN)
psych_childhood <- psych_childhood %>%
  mutate(psych_childhood_percent = round((psych_childhood/grpN)*100,digits=2),
         psych_childhood_percent = sapply(psych_childhood_percent,paste0, "%"),
         psych_childhood=str_c(psych_childhood,psych_childhood_percent,sep=", ",collapse = NULL)
  )

psych_pre.scz <- analysis %>%
  filter(psych_pre.scz==1) %>%
  group_by(outcome_cat) %>%
  summarise(psych_pre.scz=n())
psych_pre.scz <- left_join(psych_pre.scz,outcomeN)
psych_pre.scz <- psych_pre.scz %>%
  mutate(psych_pre.scz_percent = round((psych_pre.scz/grpN)*100,digits=2),
         psych_pre.scz_percent = sapply(psych_pre.scz_percent,paste0, "%"),
         psych_pre.scz=str_c(psych_pre.scz,psych_pre.scz_percent,sep=", ",collapse = NULL)
  )

psych_fhx <- analysis %>%
  filter(psych_fhx==1) %>%
  group_by(outcome_cat) %>%
  summarise(psych_fhx=n())
psych_fhx <- left_join(psych_fhx,outcomeN)
psych_fhx <- psych_fhx %>%
  mutate(psych_fhx_percent = round((psych_fhx/grpN)*100,digits=2),
         psych_fhx_percent = sapply(psych_fhx_percent,paste0, "%"),
         psych_fhx=str_c(psych_fhx,psych_fhx_percent,sep=", ",collapse = NULL)
  )

studypop.sum.categorical <- full_join(sex, ai.childhood)
studypop.sum.categorical <- full_join(studypop.sum.categorical, cvd.childhood)
studypop.sum.categorical <- full_join(studypop.sum.categorical, ai.pre.scz)
studypop.sum.categorical <- full_join(studypop.sum.categorical, cvd.pre.scz)
#studypop.sum.categorical <- full_join(studypop.sum.categorical, strk.childhood)
#studypop.sum.categorical <- full_join(studypop.sum.categorical, strk.pre.scz)
studypop.sum.categorical <- full_join(studypop.sum.categorical, cancer.pre.scz)
studypop.sum.categorical <- full_join(studypop.sum.categorical, cancer.childhood)

studypop.sum.categorical <- full_join(studypop.sum.categorical, infect.childhood)
studypop.sum.categorical <- full_join(studypop.sum.categorical, infect.pre.scz)
studypop.sum.categorical <- full_join(studypop.sum.categorical, parental.breavement)
studypop.sum.categorical <- full_join(studypop.sum.categorical, psych_childhood)
studypop.sum.categorical <- full_join(studypop.sum.categorical, psych_pre.scz)
studypop.sum.categorical <- full_join(studypop.sum.categorical, psych_fhx)

studypop.sum.categorical <- studypop.sum.categorical %>%
  select(-contains("_percent"))

rm(sex, ai.childhood, ai.pre.scz, cvd.childhood, cvd.pre.scz, cancer.pre.scz,
   cancer.childhood,infect.childhood,infect.pre.scz,
   parental.breavement, psych_childhood, psych_pre.scz, psych_fhx)  

studypop.sum.categorical <- studypop.sum.categorical %>%
  select(outcome_cat, grpN, Males, psych_pre.scz, psych_fhx, psych_childhood, 
         parental.bereavement, autoimmune.childhood, ai.pre.scz, cvd.childhood,
         cvd.pre.scz, cancer.pre.scz, 
         cancer.childhood, infect.childhood, infect.pre.scz)


studypop.sum.categorical <- as.data.frame(t(studypop.sum.categorical))

studypop.sum.categorical <- studypop.sum.categorical %>%
  select(V5,V9,V6,V7,V10,V1,V8,V3,V4,V2)

studypop.sum.categorical <- studypop.sum.categorical %>%
  rename("End of Follow Up"="V5",
         "Long Hospitalisation"="V6",
         "Income support"="V7",
         "Suicide attempt"="V9",
         "Treatment-Resistance"="V1",
         "Premature death"="V8",
         "Divorce"="V3",
         "Suicide completed"="V10",
         "Emigrated"="V4",
         "Died, not premature"="V2")

studypop.sum.categorical = studypop.sum.categorical[-1, ]

studypop.sum.categorical <- studypop.sum.categorical[,c(2,4,5,6,8,3,7,1,9,10)]

kable(studypop.sum.categorical, align = "c", "html") %>%
  kable_styling("striped", full_width = F) %>%
  add_header_above(c(" " = 1, "Outcome reached (N, %)" = 7, "Did not reach outcomes (N, %)" = 3)) %>%
  group_rows("Psychiatric", 3, 6) %>%
  group_rows("Somatic", 7, 14) %>%
  footnote("Based on 13,561 individuals born in Sweden between 1958 and 1993 with schizophrenia or schizoaffective disorder"
  )
# for meeting 01/2019 - only used to make table summarising # ppl reaching
# each outcome
outcomes$outcome_cat <- as.factor(outcomes$outcome_cat)

df <- outcomes %>%
  group_by(outcome_cat) %>%
  summarise(n=n(),
            median_follow_time = median(fu.time)) %>%
  mutate(percent = (n/13561)*100) %>%
  arrange(desc(n))

```
### Step 3: Logistic regression
```{r}
studypop <- studypop %>%
  mutate(fhx.scz=ifelse(is.na(fhx.scz),0,fhx.scz),
         sex = ifelse(sex==1, "M", "F"),
         outcome1 = ifelse(is.na(outcome1),0,outcome1), # suicide attempt
         outcome2 = ifelse(is.na(outcome2),0,outcome2), # suicide completed
         outcome3 = ifelse(is.na(outcome3),0,outcome3), # premature dead
         outcome4 = ifelse(is.na(outcome4),0,outcome4), # long hospital
         outcome5 = ifelse(is.na(outcome5),0,outcome5)) # TRS
         
studypop$sex <- as.factor(studypop$sex)

# suicides
library(rms)
resLrm <- lrm(formula = outcome1 ~ age.first.scz + sex + psych_pre.scz + infect.pre.scz +
              fhx.scz + z_edlevel + maternal_age + paternal_age,
              data = studypop,
              x = TRUE, y = TRUE)
resLrm

# suicide completed
x <- lrm(formula = outcome2 ~ age.first.scz + sex + psych_pre.scz + infect.pre.scz +
              fhx.scz  + maternal_age + paternal_age,
              data = studypop,
              x = TRUE, y = TRUE)
resLrm

# premature death
resLrm <- lrm(formula = outcome3 ~ age.first.scz + sex + psych_pre.scz + infect.pre.scz +
              fhx.scz + maternal_age + paternal_age,
              data = studypop,
              x = TRUE, y = TRUE)
resLrm
# long hsp
resLrm <- lrm(formula = outcome4 ~ age.first.scz + sex + psych_pre.scz + infect.pre.scz +
              fhx.scz + z_edlevel + maternal_age + paternal_age,
              data = studypop,
              x = TRUE, y = TRUE)
resLrm
# TRS
resLrm <- lrm(formula = outcome5 ~ age.first.scz + sex + psych_pre.scz + infect.pre.scz +
              fhx.scz + z_edlevel + maternal_age + paternal_age,
              data = studypop,
              x = TRUE, y = TRUE)
resLrm

# general outcome composite measure
log.reg <- glm(outcome_di ~ psych_pre.scz + sex + age.first.scz +
                psych_fhx + infect.pre.scz + cancer.pre.scz + ai.pre.scz, family="binomial", data=analysis)
summary(log.reg)
log.reg <- tidy(exp(cbind("Odds ratio" = coef(log.reg), confint.default(log.reg, level = 0.95))))

kable(log.reg, align = "c", "html") %>%
  kable_styling("striped", full_width = F)

library(olsrr)
sub <- analysis %>%
  ungroup() %>%
  select(outcome_di,sex,age.first.scz,bip.pre.scz,anx.pre.scz,ptsd.pre.scz,adhd.pre.scz,ed.pre.scz,sui.pre.scz,suds.pre.scz,ocd.pre.scz,asd.pre.scz,mdd.pre.scz,fhx.scz,ai.pre.scz,cancer.pre.scz,infect.pre.scz,paternal_age,maternal_age,parental.breavement,psych_childhood,psych_pre.scz,psych_fhx,fu.time)

sub$sex <- as.factor(sub$sex)
sub$bip.pre.scz <- as.factor(sub$bip.pre.scz)
sub$anx.pre.scz <- as.factor(sub$anx.pre.scz)
sub$ptsd.pre.scz <- as.factor(sub$ptsd.pre.scz)
sub$adhd.pre.scz <- as.factor(sub$adhd.pre.scz)
sub$ed.pre.scz <- as.factor(sub$ed.pre.scz)
sub$suds.pre.scz <- as.factor(sub$suds.pre.scz)
sub$ocd.pre.scz <- as.factor(sub$ocd.pre.scz)
sub$asd.pre.scz <- as.factor(sub$asd.pre.scz)
sub$sui.pre.scz <- as.factor(sub$sui.pre.scz)
sub$mdd.pre.scz <- as.factor(sub$mdd.pre.scz)
sub$fhx.scz <- as.factor(sub$fhx.scz)
sub$ai.pre.scz <- as.factor(sub$ai.pre.scz)
sub$cancer.pre.scz <- as.factor(sub$cancer.pre.scz)
sub$infect.pre.scz <- as.factor(sub$infect.pre.scz)
sub$parental.breavement <- as.factor(sub$parental.breavement)
sub$psych_childhood <- as.factor(sub$psych_childhood)
sub$psych_pre.scz <- as.factor(sub$psych_pre.scz)
sub$psych_fhx <- as.factor(sub$psych_fhx)

model <- lm(outcome_di ~ ., data = sub)
ols_step_forward_p(model)
```
### Step 4: Cox regression

```{r}
# Cox regression - unadjusted

analysis <- analysis %>%
  mutate(sex = ifelse(sex==1, "M", "F"))
analysis$sex <- as.factor(analysis$sex)

cox1 <- coxph(Surv(fu.time.x, outcome_di.x) ~ psych_pre.scz + sex + age.first.scz +
                infect.pre.scz + z_edlevel +
                paternal_age + maternal_age + fhx.scz, data=analysis)
summary(cox1)
cox1 <- tidy(exp(cbind("HR" = coef(cox1), confint.default(cox1, level = 0.95))))

kable(cox1, align = "c", "html") %>%
  kable_styling("striped", full_width = F)


library(My.stepwise)

predict.list <- c("age.first.scz", "bip.pre.scz", "anx.pre.scz", "adhd.pre.scz", "ptsd.pre.scz","ed.pre.scz","sui.pre.scz","suds.pre.scz","ocd.pre.scz","asd.pre.scz","mdd.pre.scz","ai.pre.scz","cancer.pre.scz","infect.pre.scz","psych_childhood","psych_fhx")
stepmodel <- My.stepwise.coxph(Time = "fu.time", Status = "outcome_di", variable.list = predict.list, data=sub)
```

### Step X: Alternate Cox regression
```{r}


# Suicides
summary(coxph(Surv(time_sui, suicide_yn) ~ sex, data=analysis))$conf.int -> row1 
summary(coxph(Surv(time_sui, suicide_yn) ~ age.first.scz, data=analysis))$conf.int -> row2 
summary(coxph(Surv(time_sui, suicide_yn) ~ infect.pre.scz, data=analysis))$conf.int -> row3
summary(coxph(Surv(time_sui, suicide_yn) ~ psych_pre.scz, data=analysis))$conf.int -> row4
summary(coxph(Surv(time_sui, suicide_yn) ~ z_edlevel, data=analysis))$conf.int -> row6
summary(coxph(Surv(time_sui, suicide_yn) ~ fhx.scz, data=analysis))$conf.int -> row7
summary(coxph(Surv(time_sui, suicide_yn) ~ paternal_age, data=analysis))$conf.int -> row8
summary(coxph(Surv(time_sui, suicide_yn) ~ maternal_age, data=analysis))$conf.int -> row9

rbind(row1,row2,row3,row4,row6,row7,row8,row9) -> cox.univ  

cox.unadj <- as_tibble(cox.univ) %>% 
  mutate(predictors=row.names(cox.univ), adj=0)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)
  
# Cox regression - adjusted
cox.multi <- summary(coxph(Surv(time_sui, suicide_yn) ~ 
                             sex + age.first.scz + infect.pre.scz +
                             psych_pre.scz + z_edlevel + paternal_age + maternal_age +
               fhx.scz, data=analysis))$conf.int

cox.adj <- as_tibble(cox.multi) %>% 
  mutate(predictors=row.names(cox.multi), adj=1)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

res <- rbind(cox.unadj, cox.adj)

# plot OR and 95%CI
# Create labels for plot
                  
res$predictors <- factor(res$predictors, levels=rev(c("age.first.scz",
                                                  "sexM",
                                                  "psych_pre.scz",
                                                  "infect.pre.scz",
                                                  "fhx.scz",
                                                  "z_edlevel",
                                                  "maternal_age",
                                                  "paternal_age")))

# put both unadjusted and adjusted estimates into facets, side by side
labels <- c(`0` = "unadjusted (N=13561)", `1` = "adjusted (N=11679, event=1265)")

fig2 <-ggplot(data=res) + # take away sex for now
        geom_pointrange(aes(x=predictors, y=HR, ymin=HR_95L, ymax=HR_95H, col=as.factor(adj))) +
        facet_grid(cols = vars(adj), labeller = labeller(adj=labels)) + 
        geom_hline(yintercept=1, lty=3) +  # add a dotted line at x=1 after flip
        coord_flip() +  # flip coordinates (puts labels on y axis)
        labs(title = "Predictors of suicide or attempt in SCZ (birth cohort: 1958 to 1993)",
        x="", y="Hazard Ratio (95% CI)") +
        theme_bw() +theme(legend.position="none")

ggsave(file="~/Documents/projects/5.tryggve2/tryggve2/paper1/fig_sui2_18mar19.png",fig2, width=8, height=6)


```
### Outcome 2-premature mortality
```{r}
summary(coxph(Surv(time_pd, pd_yn) ~ sex, data=analysis))$conf.int -> row1 
summary(coxph(Surv(time_pd, pd_yn) ~ age.first.scz, data=analysis))$conf.int -> row2 
summary(coxph(Surv(time_pd, pd_yn) ~ infect.pre.scz, data=analysis))$conf.int -> row3
summary(coxph(Surv(time_pd, pd_yn) ~ psych_pre.scz, data=analysis))$conf.int -> row4
#summary(coxph(Surv(time_pd, pd_yn) ~ z_edlevel, data=analysis))$conf.int -> row6
summary(coxph(Surv(time_pd, pd_yn) ~ fhx.scz, data=analysis))$conf.int -> row7
summary(coxph(Surv(time_pd, pd_yn) ~ paternal_age, data=analysis))$conf.int -> row8
summary(coxph(Surv(time_pd, pd_yn) ~ maternal_age, data=analysis))$conf.int -> row9

rbind(row1,row2,row3,row4,row7,row8,row9) -> cox.univ  
#row6
cox.unadj <- as_tibble(cox.univ) %>% 
  mutate(predictors=row.names(cox.univ), adj=0)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

# Cox regression - adjusted
cox.multi <- summary(coxph(Surv(time_pd, pd_yn) ~ 
                             sex + age.first.scz + infect.pre.scz +
                             psych_pre.scz + paternal_age + maternal_age +
                             fhx.scz, data=analysis))$conf.int
#z_edlevel 
cox.adj <- as_tibble(cox.multi) %>% 
  mutate(predictors=row.names(cox.multi), adj=1)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

res <- rbind(cox.unadj, cox.adj)

# plot OR and 95%CI
# Create labels for plot

res$predictors <- factor(res$predictors, levels=rev(c("age.first.scz",
                                                      "sexM",
                                                      "psych_pre.scz",
                                                      "infect.pre.scz",
                                                      "fhx.scz",
                                                     # "z_edlevel",
                                                      "maternal_age",
                                                      "paternal_age")))

# put both unadjusted and adjusted estimates into facets, side by side
labels <- c(`0` = "unadjusted (N=13561)", `1` = "adjusted (N=13094, event=1176)")

fig2 <-ggplot(data=res) + # take away sex for now
  geom_pointrange(aes(x=predictors, y=HR, ymin=HR_95L, ymax=HR_95H, col=as.factor(adj))) +
  facet_grid(cols = vars(adj), labeller = labeller(adj=labels)) + 
  geom_hline(yintercept=1, lty=3) +  # add a dotted line at x=1 after flip
  coord_flip() +  # flip coordinates (puts labels on y axis)
  labs(title = "Predictors of premature mortality in SCZ (birth cohort: 1958 to 1993)",
       x="", y="Hazard Ratio (95% CI)") +
  theme_bw() +theme(legend.position="none")

ggsave(file="~/Documents/projects/5.tryggve2/tryggve2/paper1/fig_prematuremort_18mar19.png",fig2, width=8, height=6)


```
### Outcome 3-long hospitalisation
```{r}
summary(coxph(Surv(time_hsp, hsp_yn) ~ sex, data=analysis))$conf.int -> row1 
summary(coxph(Surv(time_hsp, hsp_yn) ~ age.first.scz, data=analysis))$conf.int -> row2 
summary(coxph(Surv(time_hsp, hsp_yn) ~ infect.pre.scz, data=analysis))$conf.int -> row3
summary(coxph(Surv(time_hsp, hsp_yn) ~ psych_pre.scz, data=analysis))$conf.int -> row4
summary(coxph(Surv(time_hsp, hsp_yn) ~ z_edlevel, data=analysis))$conf.int -> row6
summary(coxph(Surv(time_hsp, hsp_yn) ~ fhx.scz, data=analysis))$conf.int -> row7
summary(coxph(Surv(time_hsp, hsp_yn) ~ paternal_age, data=analysis))$conf.int -> row8
summary(coxph(Surv(time_hsp, hsp_yn) ~ maternal_age, data=analysis))$conf.int -> row9

rbind(row1,row2,row3,row4,row6, row7,row8,row9) -> cox.univ  

cox.unadj <- as_tibble(cox.univ) %>% 
  mutate(predictors=row.names(cox.univ), adj=0)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

# Cox regression - adjusted
cox.multi <- summary(coxph(Surv(time_hsp, hsp_yn) ~ 
                             sex + age.first.scz + infect.pre.scz +
                             psych_pre.scz + z_edlevel + paternal_age + maternal_age +
                             fhx.scz, data=analysis))$conf.int
#z_edlevel 
cox.adj <- as_tibble(cox.multi) %>% 
  mutate(predictors=row.names(cox.multi), adj=1)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

res <- rbind(cox.unadj, cox.adj)

# plot OR and 95%CI
# Create labels for plot

res$predictors <- factor(res$predictors, levels=rev(c("age.first.scz",
                                                      "sexM",
                                                      "psych_pre.scz",
                                                      "infect.pre.scz",
                                                      "fhx.scz",
                                                       "z_edlevel",
                                                      "maternal_age",
                                                      "paternal_age")))

# put both unadjusted and adjusted estimates into facets, side by side
labels <- c(`0` = "unadjusted (N=13561)", `1` = "adjusted (N=11679, event=3498)")

fig2 <-ggplot(data=res) + # take away sex for now
  geom_pointrange(aes(x=predictors, y=HR, ymin=HR_95L, ymax=HR_95H, col=as.factor(adj))) +
  facet_grid(cols = vars(adj), labeller = labeller(adj=labels)) + 
  geom_hline(yintercept=1, lty=3) +  # add a dotted line at x=1 after flip
  coord_flip() +  # flip coordinates (puts labels on y axis)
  labs(title = "Predictors of long hospitalisation (100 days) in SCZ (birth cohort: 1958 to 1993)",
       x="", y="Hazard Ratio (95% CI)") +
  theme_bw() +theme(legend.position="none")

ggsave(file="~/Documents/projects/5.tryggve2/tryggve2/paper1/fig_longHSP_18mar19.png",fig2, width=8, height=6)


```
### Outcome 4-tx resistance
```{r}

summary(coxph(Surv(time_trs, trs_yn) ~ sex, data=analysis))$conf.int -> row1 
summary(coxph(Surv(time_trs, trs_yn) ~ age.first.scz, data=analysis))$conf.int -> row2 
summary(coxph(Surv(time_trs, trs_yn) ~ infect.pre.scz, data=analysis))$conf.int -> row3
summary(coxph(Surv(time_trs, trs_yn) ~ psych_pre.scz, data=analysis))$conf.int -> row4
summary(coxph(Surv(time_trs, trs_yn) ~ z_edlevel, data=analysis))$conf.int -> row6
summary(coxph(Surv(time_trs, trs_yn) ~ fhx.scz, data=analysis))$conf.int -> row7
summary(coxph(Surv(time_trs, trs_yn) ~ paternal_age, data=analysis))$conf.int -> row8
summary(coxph(Surv(time_trs, trs_yn) ~ maternal_age, data=analysis))$conf.int -> row9

rbind(row1,row2,row3,row4,row6, row7,row8,row9) -> cox.univ  

cox.unadj <- as_tibble(cox.univ) %>% 
  mutate(predictors=row.names(cox.univ), adj=0)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

# Cox regression - adjusted
cox.multi <- summary(coxph(Surv(time_trs, trs_yn) ~ 
                             sex + age.first.scz + infect.pre.scz +
                             psych_pre.scz + z_edlevel + paternal_age + maternal_age +
                             fhx.scz, data=analysis))$conf.int
#z_edlevel 
cox.adj <- as_tibble(cox.multi) %>% 
  mutate(predictors=row.names(cox.multi), adj=1)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

res <- rbind(cox.unadj, cox.adj)

# plot OR and 95%CI
# Create labels for plot

res$predictors <- factor(res$predictors, levels=rev(c("age.first.scz",
                                                      "sexM",
                                                      "psych_pre.scz",
                                                      "infect.pre.scz",
                                                      "fhx.scz",
                                                      "z_edlevel",
                                                      "maternal_age",
                                                      "paternal_age")))

# put both unadjusted and adjusted estimates into facets, side by side
labels <- c(`0` = "unadjusted (N=13561)", `1` = "adjusted (N=11679, event=2445)")

fig2 <-ggplot(data=res) + # take away sex for now
  geom_pointrange(aes(x=predictors, y=HR, ymin=HR_95L, ymax=HR_95H, col=as.factor(adj))) +
  facet_grid(cols = vars(adj), labeller = labeller(adj=labels)) + 
  geom_hline(yintercept=1, lty=3) +  # add a dotted line at x=1 after flip
  coord_flip() +  # flip coordinates (puts labels on y axis)
  labs(title = "Predictors of tx resistance in SCZ (birth cohort: 1958 to 1993)",
       x="", y="Hazard Ratio (95% CI)") +
  theme_bw() +theme(legend.position="none")

ggsave(file="~/Documents/projects/5.tryggve2/tryggve2/paper1/fig_trs_18mar19.png",fig2, width=8, height=6)


```
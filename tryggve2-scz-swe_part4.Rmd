---
title: "Tryggve2 - Schizophrenia - Sweden - Part 4"
author: "Kaarina Kowalec, kaarina.kowalec@ki.se"
date: "March 2019"
output: 
  html_document: 
    fig_caption: yes
    theme: simplex
    highlight: zenburn
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Motivation and Overview

NOTE: NOT RUN

Examine variables associated with poor outcomes in schizophrenia, using first,
the Swedish National Registers. In this report, I will present some initial
coding for the analyses.

**Overview**

1. Import data
2. Create a dataframe with all necessary variables including exposures and 
outcomes
3. Analyses (Covered by this RMD)

***

### Step 0: Load R packages
```{r R packages}
library(tidyverse)
library(survival)
library(broom)
library(kableExtra)
library(lubridate)
library(pROC)

Sys.setenv(TZ="Europe/Stockholm")
```

### Step 1: Limit to study cohort
```{r}
# study cohort = born 1958-1993, meaning age 15 at start of NPR, youngest reaches 
# 20 years of age at end of follow up
#& SCZ 2x dx case definition

scz <- scz %>%
  mutate(birthyear = str_extract(dob,"[:digit:]{4}"))

scz$birthyear <- as.numeric(scz$birthyear)

# variable indicating either died or emigrated before 1973, or dx w SCZ after death or migrated b4 scz
scz <- scz %>%
  mutate(died_before73 = ifelse(dod < ymd(19730101) & !is.na(dod), 1, 0), # add flag for dead b4 1973
         migrated_before73 = ifelse(first.emigrate.date < ymd(19730101) & !is.na(first.emigrate.date), 1, 0), 
         # add flag for migrate b4 1973
         died_beforeSCZ = ifelse(dod < first_scz_date, 1, 0), # add flag for dead b4 scz
         migrated_beforeSCZ = ifelse(first.emigrate.date < ymd(first_scz_date), 1, 0), 
         # add flag for emigrated b4 scz
         died_beforeSCZ = ifelse(is.na(died_beforeSCZ), 0, died_beforeSCZ), # add flag for dead b4 scz
         migrated_beforeSCZ = ifelse(is.na(migrated_beforeSCZ), 0, migrated_beforeSCZ) 
         ) 
         
studypop <- scz %>% 
  filter(!is.na(second_scz_date) &
           birth.country == "Sweden" &
           !is.na(swe.birth.county) &
           birthyear %in% c(1958:1993) &
           case.exclu == 0 & # remove those with high # of BIP or SUDS contacts
           died_before73 == 0 &
           migrated_before73 == 0 & # keep those not dead and not emigrated at 1973
           died_beforeSCZ == 0 & # remove those who died b4 scz
           migrated_beforeSCZ == 0) %>%   # remove those who emigrated b4 scz
  select(-died_before73:-migrated_beforeSCZ) 

#CATEGORICAL VARIABLES - combine psych variables
studypop <- studypop %>%
  mutate(psych_childhood = case_when(bip.childhood == 1 |
                                       anx.childhood == 1 |
                                       ptsd.childhood == 1 |
                                       adhd.childhood == 1 |
                                       ed.childhood == 1 |
                                       sui.childhood == 1 |
                                       ocd.childhood == 1 |
                                       suds.childhood == 1 |
                                       asd.childhood == 1 |
                                       mdd.childhood == 1 ~ 1,
                                     bip.childhood == 0 |
                                       anx.childhood == 0 |
                                       ptsd.childhood == 0 |
                                       adhd.childhood == 0 |
                                       ed.childhood == 0 |
                                       sui.childhood == 0 |
                                       ocd.childhood == 0 |
                                       suds.childhood == 0 |
                                       asd.childhood == 0 |
                                       mdd.childhood == 0 ~ 0,
                                     TRUE ~ 0))

studypop <- studypop %>%
  mutate(psych_pre.scz = case_when(bip.pre.scz == 1 |
                                     anx.pre.scz == 1 |
                                     ptsd.pre.scz == 1 |
                                     adhd.pre.scz == 1 |
                                     ed.pre.scz == 1 |
                                     sui.pre.scz == 1 |
                                     ocd.pre.scz == 1 |
                                     suds.pre.scz == 1 |
                                     asd.pre.scz == 1 |
                                     mdd.pre.scz == 1 ~ 1,
                                   bip.pre.scz == 0 |
                                     anx.pre.scz == 0 |
                                     ptsd.pre.scz == 0 |
                                     adhd.pre.scz == 0 |
                                     ed.pre.scz == 0 |
                                     sui.pre.scz == 0 |
                                     ocd.pre.scz == 0 |
                                     suds.pre.scz == 0 |
                                     asd.pre.scz == 0 |
                                     mdd.pre.scz == 0 ~ 0,
                                   TRUE ~ 0))

#studypop <- studypop %>%
 # mutate(psych_fhx = case_when(fhx.scz == 1 |
        #                         fhx.bp == 1 |
        #                         fhx.anx == 1 |
          #                       fhx.ptsd == 1 |
           #                      fhx.adhd == 1 |
            #                     fhx.ed == 1 |
             #                    fhx.sui == 1 |
              #                   fhx.ocd == 1 |
               #                  fhx.suds == 1 |
                #                 fhx.asd == 1 |
                 #                fhx.mdd == 1 ~ 1,
                  #             fhx.scz == 0 |
                   #              fhx.bp == 0 |
                    #             fhx.anx == 0 |
                     #            fhx.ptsd == 0 |
                      #           fhx.adhd == 0 |
                       #          fhx.ed == 0 |
                        #         fhx.sui == 0 |
                         #        fhx.ocd == 0 |
                          #       fhx.suds == 0 |
                           #      fhx.asd == 0 |
                            #     fhx.mdd == 0 ~ 0,
                             #  TRUE ~ 0)
  #)
```
### Step 2: Derive individual outcomes for analysis (suicide)

+ focus on outcomes #1-5 (clinically relevant for now)

```{r suicide outcomes}
## outcome 1 = suicide attempt or completed
suicide <- studypop %>%
  select(-date.outcome3:-outcome9) %>% 
  #removed outcome6-CVD, outcome8=sicknesspension, outcome9-divorce, outcome7-income support-for now
  arrange(id) %>%
  mutate(end.follow = ymd("2013-12-31")) %>%
  gather("date.outcome1","date.outcome2", "dod",
         "first.emigrate.date","end.follow",
         key = "outcome",
         value = "date") %>%
  select(id, outcome:date, scz:psych_pre.scz) %>%
  arrange(id,date) %>%
  group_by(id) %>%
  mutate(date.sui.reached = first(date)) %>%
#  select(id, date.outcome.reached, outcome1:outcome2,outcome:first_scz_date) %>%
  slice(1) %>%
  mutate(time_sui = as.numeric(date.sui.reached - first_scz_date)/365.25) # calculate time 

suicide$outcome <- as.factor(suicide$outcome)

suicide <- suicide %>%
  mutate(suicide_yn = ifelse(outcome!="end.follow" & outcome!="dod" &
                            outcome!="first.emigrate.date", 1, 0),
         suicide_yn_cat = case_when(outcome=="date.outcome1"~"suicide.attempt",
                             outcome=="date.outcome2"~"suicide.complete",
                            # outcome=="date.outcome3"~"premature.mortality",
                            # outcome=="date.outcome4"~"hospitalised.100days",
                            # outcome=="date.outcome5"~"clozapine.prescrip",
                            # outcome=="date.outcome7"~"income.support",
                            # outcome=="date.outcome9"~"divorce",             
                             outcome=="dod"~"died(not premature)",
                             outcome=="end.follow"~"end.of.follow",
                             outcome=="first.emigrate.date"~"emigrated",
                             TRUE ~ NA_character_)
  ) %>%
  select(id,date.sui.reached,time_sui,suicide_yn,suicide_yn_cat)

# merge back w exposures
analysis <- left_join(studypop,suicide)
```

### Step 3: Derive individual outcomes for analysis (premature mortality)
```{r}
## outcome 2 = premature.mortality
pdeath <- studypop %>%
  select(-date.outcome4:-outcome9) %>% 
  #removed outcome6-CVD, outcome8=sicknesspension, outcome9-divorce, outcome7-income support-for now
  arrange(id) %>%
  mutate(end.follow = ymd("2013-12-31")) %>%
  gather("date.outcome3", "dod",
         "first.emigrate.date","end.follow",
         key = "outcome",
         value = "date") %>%
  select(id, outcome:date, scz:psych_pre.scz) %>%
  arrange(id,date) %>%
  group_by(id) %>%
  mutate(date.pd.reached = first(date)) %>%
#  select(id, date.outcome.reached, outcome1:outcome2,outcome:first_scz_date) %>%
  slice(1) %>%
  mutate(time_pd = as.numeric(date.pd.reached - first_scz_date)/365.25) %>% # calculate time 
  filter(time_pd >= 0) # remove people who emigrated before reached outcome

pdeath$outcome <- as.factor(pdeath$outcome)

pdeath <- pdeath %>%
  mutate(pd_yn = ifelse(outcome!="end.follow" & outcome!="dod" &
                            outcome!="first.emigrate.date", 1, 0),
         pd_yn_cat = case_when(#outcome=="date.outcome1"~"suicide.attempt",
                            # outcome=="date.outcome2"~"suicide.complete",
                             outcome=="date.outcome3"~"premature.mortality",
                            # outcome=="date.outcome4"~"hospitalised.100days",
                            # outcome=="date.outcome5"~"clozapine.prescrip",
                            # outcome=="date.outcome7"~"income.support",
                            # outcome=="date.outcome9"~"divorce",             
                             outcome=="dod"~"died(not premature)",
                             outcome=="end.follow"~"end.of.follow",
                             outcome=="first.emigrate.date"~"emigrated",
                             TRUE ~ NA_character_)
  ) %>%
  select(id,date.pd.reached,time_pd,pd_yn,pd_yn_cat)

# merge back w exposures
analysis <- left_join(analysis,pdeath)
```

### Step 4: Derive individual outcomes for analysis (hospitalised 100 days)
```{r}
## outcome 4= hospitalised.100days
hsp <- studypop %>%
  select(-date.outcome5:-outcome9) %>% 
  #removed outcome6-CVD, outcome8=sicknesspension, outcome9-divorce, outcome7-income support-for now
  arrange(id) %>%
  mutate(end.follow = ymd("2013-12-31")) %>%
  gather("date.outcome4", "dod",
         "first.emigrate.date","end.follow",
         key = "outcome",
         value = "date") %>%
  select(id, outcome:date, scz:psych_pre.scz) %>%
  arrange(id,date) %>%
  group_by(id) %>%
  mutate(date.hsp.reached = first(date)) %>%
#  select(id, date.outcome.reached, outcome1:outcome2,outcome:first_scz_date) %>%
  slice(1) %>%
  mutate(time_hsp = as.numeric(date.hsp.reached - first_scz_date)/365.25) %>% # calculate time 
  filter(time_hsp >= 0) # remove people who emigrated before reached outcome

hsp$outcome <- as.factor(hsp$outcome)

hsp <- hsp %>%
  mutate(hsp_yn = ifelse(outcome!="end.follow" & outcome!="dod" &
                            outcome!="first.emigrate.date", 1, 0),
         hsp_yn_cat = case_when(#outcome=="date.outcome1"~"suicide.attempt",
                            # outcome=="date.outcome2"~"suicide.complete",
                             #outcome=="date.outcome3"~"premature.mortality",
                            outcome=="date.outcome4"~"hospitalised.100days",
                            # outcome=="date.outcome5"~"clozapine.prescrip",
                            # outcome=="date.outcome7"~"income.support",
                            # outcome=="date.outcome9"~"divorce",             
                             outcome=="dod"~"died(not premature)",
                             outcome=="end.follow"~"end.of.follow",
                             outcome=="first.emigrate.date"~"emigrated",
                             TRUE ~ NA_character_)
  ) %>%
  select(id,date.hsp.reached,time_hsp,hsp_yn,hsp_yn_cat)

# merge back w exposures
analysis <- left_join(analysis,hsp)
```
### Step 5: Derive individual outcomes for analysis (clozapine.prescrip)
```{r}
## ERROR IN original script, need to redo
## outcome 5= clozapine.prescrip
trs <- studypop %>%
  select(-date.outcome6:-outcome9) %>% 
  #removed outcome6-CVD, outcome8=sicknesspension, outcome9-divorce, outcome7-income support-for now
  arrange(id) %>%
  mutate(end.follow = ymd("2013-12-31")) %>%
  gather("date.outcome5", "dod",
         "first.emigrate.date","end.follow",
         key = "outcome",
         value = "date") %>%
  select(id, outcome:date, scz:psych_pre.scz) %>%
  arrange(id,date) %>%
  group_by(id) %>%
  mutate(date.trs.reached = first(date)) %>%
#  select(id, date.outcome.reached, outcome1:outcome2,outcome:first_scz_date) %>%
  slice(1) %>%
  mutate(time_trs = as.numeric(date.trs.reached - first_scz_date)/365.25) %>% # calculate time 
  filter(time_trs >= 0) # remove people who emigrated before reached outcome

trs$outcome <- as.factor(trs$outcome)

trs <- trs %>%
  mutate(trs_yn = ifelse(outcome!="end.follow" & outcome!="dod" &
                            outcome!="first.emigrate.date", 1, 0),
         trs_yn_cat = case_when(#outcome=="date.outcome1"~"suicide.attempt",
                            # outcome=="date.outcome2"~"suicide.complete",
                             #outcome=="date.outcome3"~"premature.mortality",
                            #outcome=="date.outcome4"~"hospitalised.100days",
                             outcome=="date.outcome5"~"clozapine.prescrip",
                            # outcome=="date.outcome7"~"income.support",
                            # outcome=="date.outcome9"~"divorce",             
                             outcome=="dod"~"died(not premature)",
                             outcome=="end.follow"~"end.of.follow",
                             outcome=="first.emigrate.date"~"emigrated",
                             TRUE ~ NA_character_)
  ) %>%
  select(id,date.trs.reached,time_trs,trs_yn,trs_yn_cat)

# merge back w exposures
analysis <- left_join(analysis,trs)

```


### Step 5b: Derive composite outcome for analysis (any of suicide, hsp, death)
```{r}

anyout <- studypop %>%
  arrange(id) %>%
  mutate(end.follow = ymd("2013-12-31")) %>%
  gather("date.outcome1","date.outcome2", "date.outcome3", "date.outcome4", "dod", "first.emigrate.date","end.follow",
         key = "outcome",
         value = "date") %>%
 # select(id, outcome:date, scz:psych_pre.scz) %>%
  arrange(id,date) %>%
  group_by(id) %>%
  mutate(date.anyoutcome.reached = first(date)) %>%
  select(id, date.anyoutcome.reached, outcome1:date, first_scz_date) %>%
  slice(1) %>%
  mutate(time_any = as.numeric(date.anyoutcome.reached - first_scz_date)/365.25) %>% # calculate time 
  filter(time_any >= 0) 

anyout$outcome <- as.factor(anyout$outcome)

anyout <- anyout %>%
  mutate(outcome_yn = ifelse(outcome!="end.follow" & outcome!="dod" &
                            outcome!="first.emigrate.date", 1, 0),
        outcome_yn_cat = case_when(outcome=="date.outcome1"~"suicide.attempt",
                            outcome=="date.outcome2"~"suicide.complete",
                            outcome=="date.outcome3"~"premature.mortality",
                            outcome=="date.outcome4"~"hospitalised.100days",
                            outcome=="dod"~"died(not premature)",
                            outcome=="end.follow"~"end.of.follow",
                            outcome=="first.emigrate.date"~"emigrated",
                             TRUE ~ NA_character_)
  ) %>%
  select(id,date.anyoutcome.reached,time_any,outcome_yn,outcome_yn_cat)

# merge back w exposures
analysis <- left_join(analysis,anyout)

```

### Step 6: Descriptive tables
```{r}
# only for composite outcomes, not for specific outcomes        
###############################
#CONTINUOUS VARIABLES
studypop.sum.continuous <- analysis %>% 
  group_by(outcome_cat) %>% 
  summarise(
    N=n(), 
    Follow.up.time = round(mean(fu.time),digits=2),
    Number.of.SCZ.contacts = round(mean(nsczcontacts, na.rm=T), digits = 2),
    Number.of.SCZ.inpatient = round(mean(nsczinpt, na.rm=T), digits = 2),
    Number.of.SCZ.outpatient = round(mean(nsczoutpt, na.rm=T), digits = 2),
    Age.at.SCZ.dx = round(mean(age.first.scz, na.rm=T), digits = 2),
    Year9.Grade = round(mean(std.grade, na.rm=T), digits = 2),
    EducationalAttain = round(mean(z_edlevel, na.rm=T), digits = 2),
    Paternal.age = round(mean(paternal_age, na.rm=T), digits = 2),
    Maternal.age = round(mean(maternal_age, na.rm=T), digits = 2)
  ) %>%
  arrange(desc(N)) %>%
  mutate("%" = round((N/13561)*100,digits=2)) %>%
  select(outcome_cat,N,"%","Follow.up.time","Number.of.SCZ.contacts":"Maternal.age")

studypop.sum.continuous <- as.data.frame(t(studypop.sum.continuous))

studypop.sum.continuous <- studypop.sum.continuous %>%
  rename("End of Follow Up"="V1",
         "Long Hospitalisation"="V2",
         "Income support"="V3",
         "Treatment-Resistance"="V4",
         "Suicide attempt"="V5",
         "Premature death"="V6",
         "Divorce"="V7",
         "Suicide completed"="V8",
         "Emigrated"="V9",
         "Died, not premature"="V10")

studypop.sum.continuous = studypop.sum.continuous[-1, ]

studypop.sum.continuous <- studypop.sum.continuous[,c(2,4,5,6,8,3,7,1,9,10)]

kable(studypop.sum.continuous, align = "c", "html") %>%
  kable_styling("striped", full_width = F) %>%
  add_header_above(c(" " = 1, "Outcome reached" = 7, "Did not reach outcomes" = 3)) %>%
  group_rows(" ", 1, 2) %>%
  group_rows("Continuous variables", 3, 8) %>%
  footnote("Based on 13,561 individuals born in Sweden between 1958 and 1993 with schizophrenia or schizoaffective disorder"
  ) 


outcomeN <- analysis %>% 
  group_by(outcome_cat) %>% 
  summarise(
    grpN=n())

sex <- analysis %>%
  filter(sex==1) %>%
  group_by(outcome_cat) %>%
  summarise(Males=n()) 
sex <- left_join(sex,outcomeN)
sex <- sex %>%
  mutate(Males_percent = round((Males/grpN)*100,digits=2),
         Males_percent = sapply(Males_percent,paste0, "%"),
         Males=str_c(Males,Males_percent,sep=", ",collapse = NULL))
         
ai.childhood <- analysis %>%
  filter(ai.childhood==1) %>%
  group_by(outcome_cat) %>%
  summarise(autoimmune.childhood=n()) 
ai.childhood <- left_join(ai.childhood,outcomeN)
ai.childhood <- ai.childhood %>%
  mutate(autoimmune.childhood_percent = round((autoimmune.childhood/grpN)*100,digits=2),
         autoimmune.childhood_percent = sapply(autoimmune.childhood_percent,paste0, "%"),
         autoimmune.childhood=str_c(autoimmune.childhood,autoimmune.childhood_percent,sep=", ",collapse = NULL)
  )

ai.pre.scz <- analysis %>%
  filter(ai.pre.scz==1) %>%
  group_by(outcome_cat) %>%
  summarise(ai.pre.scz=n())
ai.pre.scz <- left_join(ai.pre.scz,outcomeN)
ai.pre.scz <- ai.pre.scz %>%
  mutate(ai.pre.scz_percent = round((ai.pre.scz/grpN)*100,digits=2),
         ai.pre.scz_percent = sapply(ai.pre.scz_percent,paste0, "%"),
         ai.pre.scz=str_c(ai.pre.scz,ai.pre.scz_percent,sep=", ",collapse = NULL)
  )

cvd.childhood <- analysis %>%
  filter(cvd.childhood==1) %>%
  group_by(outcome_cat) %>%
  summarise(cvd.childhood=n()) 
cvd.childhood <- left_join(cvd.childhood,outcomeN)
cvd.childhood <- cvd.childhood %>%
  mutate(cvd.childhood_percent = round((cvd.childhood/grpN)*100,digits=2),
         cvd.childhood_percent = sapply(cvd.childhood_percent,paste0, "%"),
         cvd.childhood=str_c(cvd.childhood,cvd.childhood_percent,sep=", ",collapse = NULL)
  )

cvd.pre.scz <- analysis %>%
  filter(cvd.pre.scz==1) %>%
  group_by(outcome_cat) %>%
  summarise(cvd.pre.scz=n())
cvd.pre.scz <- left_join(cvd.pre.scz,outcomeN)
cvd.pre.scz <- cvd.pre.scz %>%
  mutate(cvd.pre.scz_percent = round((cvd.pre.scz/grpN)*100,digits=2),
         cvd.pre.scz_percent = sapply(cvd.pre.scz_percent,paste0, "%"),
         cvd.pre.scz=str_c(cvd.pre.scz,cvd.pre.scz_percent,sep=", ",collapse = NULL)
  )

#strk.childhood <- analysis %>%
#  filter(strk.childhood==1) %>%
 # group_by(outcome_cat) %>%
#  summarise(strk.childhood=n()) 
#strk.childhood <- left_join(strk.childhood,outcomeN)
#strk.childhood <- strk.childhood %>%
 # mutate(strk.childhood_percent = round((strk.childhood/grpN)*100,digits=2),
   #      strk.childhood_percent = sapply(strk.childhood_percent,paste0, "%"),
  #       strk.childhood=str_c(strk.childhood,strk.childhood_percent,sep=", ",collapse = NULL)
  #)

#strk.pre.scz <- analysis %>%
 # filter(strk.pre.scz==1) %>%
  #group_by(outcome_cat) %>%
  #summarise(strk.pre.scz=n()) 
#strk.pre.scz <- left_join(strk.pre.scz,outcomeN)
#strk.pre.scz <- strk.pre.scz %>%
 # mutate(strk.pre.scz_percent = round((strk.pre.scz/grpN)*100,digits=2),
  #       strk.pre.scz_percent = sapply(strk.pre.scz_percent,paste0, "%"),
   #      strk.pre.scz=str_c(strk.pre.scz,strk.pre.scz_percent,sep=", ",collapse = NULL)
  #)

cancer.childhood <- analysis %>%
  filter(cancer.childhood==1) %>%
  group_by(outcome_cat) %>%
  summarise(cancer.childhood=n()) 
cancer.childhood <- left_join(cancer.childhood,outcomeN)
cancer.childhood <- cancer.childhood %>%
  mutate(cancer.childhood_percent = round((cancer.childhood/grpN)*100,digits=2),
         cancer.childhood_percent = sapply(cancer.childhood_percent,paste0, "%"),
         cancer.childhood=str_c(cancer.childhood,cancer.childhood_percent,sep=", ",collapse = NULL)
  )

cancer.pre.scz <- analysis %>%
  filter(cancer.pre.scz==1) %>%
  group_by(outcome_cat) %>%
  summarise(cancer.pre.scz=n())
cancer.pre.scz <- left_join(cancer.pre.scz,outcomeN)
cancer.pre.scz <- cancer.pre.scz %>%
  mutate(cancer.pre.scz_percent = round((cancer.pre.scz/grpN)*100,digits=2),
         cancer.pre.scz_percent = sapply(cancer.pre.scz_percent,paste0, "%"),
         cancer.pre.scz=str_c(cancer.pre.scz,cancer.pre.scz_percent,sep=", ",collapse = NULL)
  )

infect.childhood <- analysis %>%
  filter(infect.childhood==1) %>%
  group_by(outcome_cat) %>%
  summarise(infect.childhood=n())
infect.childhood <- left_join(infect.childhood,outcomeN)
infect.childhood <- infect.childhood %>%
  mutate(infect.childhood_percent = round((infect.childhood/grpN)*100,digits=2),
         infect.childhood_percent = sapply(infect.childhood_percent,paste0, "%"),
         infect.childhood=str_c(infect.childhood,infect.childhood_percent,sep=", ",collapse = NULL)
  )

infect.pre.scz <- analysis %>%
  filter(infect.pre.scz==1) %>%
  group_by(outcome_cat) %>%
  summarise(infect.pre.scz=n())
infect.pre.scz <- left_join(infect.pre.scz,outcomeN)
infect.pre.scz <- infect.pre.scz %>%
  mutate(infect.pre.scz_percent = round((infect.pre.scz/grpN)*100,digits=2),
         infect.pre.scz_percent = sapply(infect.pre.scz_percent,paste0, "%"),
         infect.pre.scz=str_c(infect.pre.scz,infect.pre.scz_percent,sep=", ",collapse = NULL)
  )

parental.breavement <- analysis %>%
  filter(parental.breavement==1) %>%
  group_by(outcome_cat) %>%
  summarise(parental.bereavement=n())
parental.breavement <- left_join(parental.breavement,outcomeN)
parental.breavement <- parental.breavement %>%
  mutate(parental.breavement_percent = round((parental.bereavement/grpN)*100,digits=2),
         parental.breavement_percent = sapply(parental.breavement_percent,paste0, "%"),
         parental.bereavement=str_c(parental.bereavement,parental.breavement_percent,sep=", ",collapse = NULL)
  )

psych_childhood <- analysis %>%
  filter(psych_childhood==1) %>%
  group_by(outcome_cat) %>%
  summarise(psych_childhood=n())
psych_childhood <- left_join(psych_childhood,outcomeN)
psych_childhood <- psych_childhood %>%
  mutate(psych_childhood_percent = round((psych_childhood/grpN)*100,digits=2),
         psych_childhood_percent = sapply(psych_childhood_percent,paste0, "%"),
         psych_childhood=str_c(psych_childhood,psych_childhood_percent,sep=", ",collapse = NULL)
  )

psych_pre.scz <- analysis %>%
  filter(psych_pre.scz==1) %>%
  group_by(outcome_cat) %>%
  summarise(psych_pre.scz=n())
psych_pre.scz <- left_join(psych_pre.scz,outcomeN)
psych_pre.scz <- psych_pre.scz %>%
  mutate(psych_pre.scz_percent = round((psych_pre.scz/grpN)*100,digits=2),
         psych_pre.scz_percent = sapply(psych_pre.scz_percent,paste0, "%"),
         psych_pre.scz=str_c(psych_pre.scz,psych_pre.scz_percent,sep=", ",collapse = NULL)
  )

psych_fhx <- analysis %>%
  filter(psych_fhx==1) %>%
  group_by(outcome_cat) %>%
  summarise(psych_fhx=n())
psych_fhx <- left_join(psych_fhx,outcomeN)
psych_fhx <- psych_fhx %>%
  mutate(psych_fhx_percent = round((psych_fhx/grpN)*100,digits=2),
         psych_fhx_percent = sapply(psych_fhx_percent,paste0, "%"),
         psych_fhx=str_c(psych_fhx,psych_fhx_percent,sep=", ",collapse = NULL)
  )

studypop.sum.categorical <- full_join(sex, ai.childhood)
studypop.sum.categorical <- full_join(studypop.sum.categorical, cvd.childhood)
studypop.sum.categorical <- full_join(studypop.sum.categorical, ai.pre.scz)
studypop.sum.categorical <- full_join(studypop.sum.categorical, cvd.pre.scz)
#studypop.sum.categorical <- full_join(studypop.sum.categorical, strk.childhood)
#studypop.sum.categorical <- full_join(studypop.sum.categorical, strk.pre.scz)
studypop.sum.categorical <- full_join(studypop.sum.categorical, cancer.pre.scz)
studypop.sum.categorical <- full_join(studypop.sum.categorical, cancer.childhood)

studypop.sum.categorical <- full_join(studypop.sum.categorical, infect.childhood)
studypop.sum.categorical <- full_join(studypop.sum.categorical, infect.pre.scz)
studypop.sum.categorical <- full_join(studypop.sum.categorical, parental.breavement)
studypop.sum.categorical <- full_join(studypop.sum.categorical, psych_childhood)
studypop.sum.categorical <- full_join(studypop.sum.categorical, psych_pre.scz)
studypop.sum.categorical <- full_join(studypop.sum.categorical, psych_fhx)

studypop.sum.categorical <- studypop.sum.categorical %>%
  select(-contains("_percent"))

rm(sex, ai.childhood, ai.pre.scz, cvd.childhood, cvd.pre.scz, cancer.pre.scz,
   cancer.childhood,infect.childhood,infect.pre.scz,
   parental.breavement, psych_childhood, psych_pre.scz, psych_fhx)  

studypop.sum.categorical <- studypop.sum.categorical %>%
  select(outcome_cat, grpN, Males, psych_pre.scz, psych_fhx, psych_childhood, 
         parental.bereavement, autoimmune.childhood, ai.pre.scz, cvd.childhood,
         cvd.pre.scz, cancer.pre.scz, 
         cancer.childhood, infect.childhood, infect.pre.scz)


studypop.sum.categorical <- as.data.frame(t(studypop.sum.categorical))

studypop.sum.categorical <- studypop.sum.categorical %>%
  select(V5,V9,V6,V7,V10,V1,V8,V3,V4,V2)

studypop.sum.categorical <- studypop.sum.categorical %>%
  rename("End of Follow Up"="V5",
         "Long Hospitalisation"="V6",
         "Income support"="V7",
         "Suicide attempt"="V9",
         "Treatment-Resistance"="V1",
         "Premature death"="V8",
         "Divorce"="V3",
         "Suicide completed"="V10",
         "Emigrated"="V4",
         "Died, not premature"="V2")

studypop.sum.categorical = studypop.sum.categorical[-1, ]

studypop.sum.categorical <- studypop.sum.categorical[,c(2,4,5,6,8,3,7,1,9,10)]

kable(studypop.sum.categorical, align = "c", "html") %>%
  kable_styling("striped", full_width = F) %>%
  add_header_above(c(" " = 1, "Outcome reached (N, %)" = 7, "Did not reach outcomes (N, %)" = 3)) %>%
  group_rows("Psychiatric", 3, 6) %>%
  group_rows("Somatic", 7, 14) %>%
  footnote("Based on 13,561 individuals born in Sweden between 1958 and 1993 with schizophrenia or schizoaffective disorder"
  )
# for meeting 01/2019 - only used to make table summarising # ppl reaching
# each outcome
outcomes$outcome_cat <- as.factor(outcomes$outcome_cat)

df <- outcomes %>%
  group_by(outcome_cat) %>%
  summarise(n=n(),
            median_follow_time = median(fu.time)) %>%
  mutate(percent = (n/13561)*100) %>%
  arrange(desc(n))

```
### Step 7: Logistic regression-specific outcomes
```{r}
analysis <- analysis %>%
  mutate(fhx.scz=ifelse(is.na(fhx.scz),0,fhx.scz),
         sex = ifelse(sex==1, "M", "F"),
         sui.pre.scz=ifelse(is.na(sui.pre.scz),0,sui.pre.scz),
         sui.childhood=ifelse(is.na(sui.childhood),0,sui.childhood),
         intdis.pre.scz=ifelse(is.na(intdis.pre.scz),0,intdis.pre.scz),
         intdis.childhood=ifelse(is.na(intdis.childhood),0,intdis.childhood),
         infect.type=ifelse(is.na(infect.type),"no infect",infect.type))

analysis$sex <- as.factor(analysis$sex)
analysis$infect.type <- as.factor(analysis$infect.type)

# Multivariable model - suicide
suicide <- glm(suicide_yn ~ sex + age.first.scz + infect.pre.scz +
                  psych_pre.scz + EduYr.id + fhx.scz,
               data = analysis, family = "binomial")
summary(suicide)
exp(cbind("Odds ratio" = coef(suicide), confint.default(suicide, level = 0.95)))

# Multivariable model - premature death
pdeath <- glm(pd_yn ~ sex + age.first.scz + infect.pre.scz +
                  psych_pre.scz + EduYr.id + fhx.scz,
               data = analysis, family = "binomial")
summary(pdeath)
exp(cbind("Odds ratio" = coef(pdeath), confint.default(pdeath, level = 0.95)))

# Multivariable model - hsp
hsp <- glm(hsp_yn ~ sex + age.first.scz + infect.pre.scz +
                  psych_pre.scz + EduYr.id + fhx.scz + birthyear,
               data = analysis, family = "binomial")
summary(hsp)
exp(cbind("Odds ratio" = coef(hsp), confint.default(hsp, level = 0.95)))



```
### Step 8: Cox regression-Suicides
```{r}
# Suicides
summary(coxph(Surv(time_sui, suicide_yn) ~ sex, data=analysis))$conf.int -> row1 
summary(coxph(Surv(time_sui, suicide_yn) ~ age.first.scz, data=analysis))$conf.int -> row2 
summary(coxph(Surv(time_sui, suicide_yn) ~ bip.pre.scz, data=analysis))$conf.int -> row3
summary(coxph(Surv(time_sui, suicide_yn) ~ anx.pre.scz, data=analysis))$conf.int -> row4
summary(coxph(Surv(time_sui, suicide_yn) ~ ptsd.pre.scz, data=analysis))$conf.int -> row5
summary(coxph(Surv(time_sui, suicide_yn) ~ adhd.pre.scz, data=analysis))$conf.int -> row6
summary(coxph(Surv(time_sui, suicide_yn) ~ ed.pre.scz, data=analysis))$conf.int -> row7
summary(coxph(Surv(time_sui, suicide_yn) ~ sui.pre.scz, data=analysis))$conf.int -> row8
summary(coxph(Surv(time_sui, suicide_yn) ~ suds.pre.scz, data=analysis))$conf.int -> row9
summary(coxph(Surv(time_sui, suicide_yn) ~ ocd.pre.scz, data=analysis))$conf.int -> row10
summary(coxph(Surv(time_sui, suicide_yn) ~ asd.pre.scz, data=analysis))$conf.int -> row11
summary(coxph(Surv(time_sui, suicide_yn) ~ mdd.pre.scz, data=analysis))$conf.int -> row12
summary(coxph(Surv(time_sui, suicide_yn) ~ ai.pre.scz, data=analysis))$conf.int -> row13
summary(coxph(Surv(time_sui, suicide_yn) ~ cancer.pre.scz, data=analysis))$conf.int -> row14
#summary(coxph(Surv(time_sui, suicide_yn) ~ infect.pre.scz, data=analysis))$conf.int -> row15
summary(coxph(Surv(time_sui, suicide_yn) ~ congen.malform, data=analysis))$conf.int -> row16
summary(coxph(Surv(time_sui, suicide_yn) ~ intdis.pre.scz, data=analysis))$conf.int -> row17
summary(coxph(Surv(time_sui, suicide_yn) ~ large_munc_sczdx, data=analysis))$conf.int -> row18
summary(coxph(Surv(time_sui, suicide_yn) ~ relevel(infect.type,5), data=analysis))$conf.int -> row19 
summary(coxph(Surv(time_sui, suicide_yn) ~ EduYr.id, data=analysis))$conf.int -> row20
summary(coxph(Surv(time_sui, suicide_yn) ~ fhx.scz, data=analysis))$conf.int -> row21

#summary(coxph(Surv(time_sui, suicide_yn) ~ std.grade, data=analysis))$conf.int -> row7
#summary(coxph(Surv(time_sui, suicide_yn) ~ EduYr.mom, data=analysis))$conf.int -> row8
#summary(coxph(Surv(time_sui, suicide_yn) ~ EduYr.dad, data=analysis))$conf.int -> row9

rbind(row1,row2,row3,row4,row5,row6,row7,row8,row9,row10,row11,row12,row13,row14,
      row16,row17,row18,row19,row20,row21) -> cox.univ  
#row15
rm(row1,row2,row3,row4,row5,row6,row7,row8,row9,row10,row11,row12,row13,row14,
      row16,row17,row18,row19,row20,row21)
#row15
cox.unadj <- as_tibble(cox.univ) %>% 
  mutate(predictors=row.names(cox.univ), adj=0)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)
  
# Cox regression - adjusted
cox.multi <- summary(coxph(Surv(time_sui, suicide_yn) ~ sex + age.first.scz +
                             bip.pre.scz + anx.pre.scz + ptsd.pre.scz + adhd.pre.scz +
                             ed.pre.scz + sui.pre.scz + suds.pre.scz + ocd.pre.scz +
                             asd.pre.scz + mdd.pre.scz + ai.pre.scz + cancer.pre.scz +
                             congen.malform + intdis.pre.scz + 
                             large_munc_sczdx + relevel(infect.type,5) + EduYr.id + fhx.scz,
                           data=analysis))$conf.int
#infect.pre.scz
cox.adj <- as_tibble(cox.multi) %>% 
  mutate(predictors=row.names(cox.multi), adj=1)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

res <- rbind(cox.unadj, cox.adj)

res <- res %>%
  mutate(predictors = case_when(predictors=="sexM" ~ "Male sex",
                                predictors=="EduYr.id" ~ "EduYears",
                              predictors=="relevel(infect.type, 5)gastrointestinal"~"gastrointestinfect.pre.scz",
    predictors=="relevel(infect.type, 5)genital"~"genitalinfect.pre.scz",
                        predictors=="relevel(infect.type, 5)hepatitis"~"hepatitis.pre.scz",
                        predictors=="relevel(infect.type, 5)CNS"~"CNVinfect.pre.scz",
                        predictors=="relevel(infect.type, 5)otitis media"~"earinfect.pre.scz",
                       predictors== "relevel(infect.type, 5)respiratory"~"respiratoryinfec.pre.scz",
                        predictors=="relevel(infect.type, 5)sepsis"~"sepsis.pre.scz",
                       predictors== "relevel(infect.type, 5)skin"~"skininfect.pre.scz",
                       predictors== "relevel(infect.type, 5)urological"~"urologicalinfect.pre.scz",
    predictors=="large_munc_sczdx"~"urban.first.scz",
    predictors=="ai.pre.scz"~"autoimmune.pre.scz",
    TRUE~predictors))
 
                                                     
# plot OR and 95%CI
# Create labels for plot
                  
res$predictors <- factor(res$predictors, levels=rev(c("Male sex",
                                                      "age.first.scz",
                                                      "urban.first.scz",
                                                      "EduYears",
                                                      "fhx.scz",
                                                      "bip.pre.scz",
                                                      "mdd.pre.scz",
                                                      "anx.pre.scz",
                                                      "ptsd.pre.scz",
                                                      "adhd.pre.scz",
                                                      "asd.pre.scz",
                                                      "ed.pre.scz",
                                                      "sui.pre.scz",
                                                      "suds.pre.scz",
                                                      "ocd.pre.scz",
                                                      "congen.malform",
                                                      "intdis.pre.scz",
                                                      "autoimmune.pre.scz",
                                                      "cancer.pre.scz",
                                                      "gastrointestinfect.pre.scz",
                                                      "genitalinfect.pre.scz",
                                                      "hepatitis.pre.scz",
                                                      "CNVinfect.pre.scz",
                                                      "earinfect.pre.scz",
                                                      "respiratoryinfec.pre.scz",
                                                      "skininfect.pre.scz",
                                                      "sepsis.pre.scz",
                                                      "urologicalinfect.pre.scz"
                                                  )))

# put both unadjusted and adjusted estimates into facets, side by side
labels <- c(`0` = "unadjusted (N=13806, event=1795)", `1` = "adjusted (N=13157, event=1685)")

fig2 <-ggplot(data=res) +
        geom_pointrange(aes(x=predictors, y=HR, ymin=HR_95L, ymax=HR_95H, col=as.factor(adj))) +
        facet_grid(cols = vars(adj), labeller = labeller(adj=labels)) + 
        geom_hline(yintercept=1, lty=3) +  # add a dotted line at x=1 after flip
        coord_flip() +  # flip coordinates (puts labels on y axis)
        labs(title = "Predictors of suicide or attempt in SCZ (birth cohort: 1958 to 1993)",
        x="", y="Hazard Ratio (95% CI)") +
        theme_bw() +
        theme(legend.position="none") +
        scale_y_continuous(limits=c(0,8))

ggsave(file="~/Documents/projects/5.tryggve2/tryggve2/paper1/fig_sui2_24apr19.png",fig2, width=8, height=6)


```
### Step 9: Cox regression-Premature mortality
```{r}

summary(coxph(Surv(time_pd, pd_yn) ~ sex, data=analysis))$conf.int -> row1 
summary(coxph(Surv(time_pd, pd_yn) ~ age.first.scz, data=analysis))$conf.int -> row2 
summary(coxph(Surv(time_pd, pd_yn) ~ bip.pre.scz, data=analysis))$conf.int -> row3
summary(coxph(Surv(time_pd, pd_yn) ~ anx.pre.scz, data=analysis))$conf.int -> row4
summary(coxph(Surv(time_pd, pd_yn) ~ ptsd.pre.scz, data=analysis))$conf.int -> row5
summary(coxph(Surv(time_pd, pd_yn) ~ adhd.pre.scz, data=analysis))$conf.int -> row6
summary(coxph(Surv(time_pd, pd_yn) ~ ed.pre.scz, data=analysis))$conf.int -> row7
summary(coxph(Surv(time_pd, pd_yn) ~ sui.pre.scz, data=analysis))$conf.int -> row8
summary(coxph(Surv(time_pd, pd_yn) ~ suds.pre.scz, data=analysis))$conf.int -> row9
summary(coxph(Surv(time_pd, pd_yn) ~ ocd.pre.scz, data=analysis))$conf.int -> row10
summary(coxph(Surv(time_pd, pd_yn) ~ asd.pre.scz, data=analysis))$conf.int -> row11
summary(coxph(Surv(time_pd, pd_yn) ~ mdd.pre.scz, data=analysis))$conf.int -> row12
summary(coxph(Surv(time_pd, pd_yn) ~ ai.pre.scz, data=analysis))$conf.int -> row13
summary(coxph(Surv(time_pd, pd_yn) ~ cancer.pre.scz, data=analysis))$conf.int -> row14
summary(coxph(Surv(time_pd, pd_yn) ~ congen.malform, data=analysis))$conf.int -> row16
summary(coxph(Surv(time_pd, pd_yn) ~ intdis.pre.scz, data=analysis))$conf.int -> row17
summary(coxph(Surv(time_pd, pd_yn) ~ large_munc_sczdx, data=analysis))$conf.int -> row18
summary(coxph(Surv(time_pd, pd_yn) ~ relevel(infect.type,5), data=analysis))$conf.int -> row19 
summary(coxph(Surv(time_pd, pd_yn) ~ EduYr.id, data=analysis))$conf.int -> row20
summary(coxph(Surv(time_pd, pd_yn) ~ fhx.scz, data=analysis))$conf.int -> row21
#summary(coxph(Surv(time_pd, pd_yn) ~ infect.pre.scz, data=analysis))$conf.int -> row15

#summary(coxph(Surv(time_pd, pd_yn) ~ std.grade, data=analysis))$conf.int -> row7
#summary(coxph(Surv(time_pd, pd_yn) ~ EduYr.mom, data=analysis))$conf.int -> row8
#summary(coxph(Surv(time_pd, pd_yn) ~ EduYr.dad, data=analysis))$conf.int -> row9

rbind(row1,row2,row3,row4,row5,row6,row7,row8,row9,row10,row11,row12,row13,row14,
      row16,row17,row18,row19,row20,row21) -> cox.univ  

rm(row1,row2,row3,row4,row5,row6,row7,row8,row9,row10,row11,row12,row13,row14,
   row16,row17,row18,row19,row20,row21)

cox.unadj <- as_tibble(cox.univ) %>% 
  mutate(predictors=row.names(cox.univ), adj=0) %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)


# Cox regression - adjusted
cox.multi <- summary(coxph(Surv(time_pd, pd_yn) ~ sex + age.first.scz +
                             bip.pre.scz + anx.pre.scz + ptsd.pre.scz + adhd.pre.scz +
                             ed.pre.scz + sui.pre.scz + suds.pre.scz + ocd.pre.scz +
                             asd.pre.scz + mdd.pre.scz + ai.pre.scz + cancer.pre.scz +
                             congen.malform + intdis.pre.scz + 
                             large_munc_sczdx + relevel(infect.type,5) + EduYr.id + fhx.scz,
                           data=analysis))$conf.int

cox.adj <- as_tibble(cox.multi) %>% 
  mutate(predictors=row.names(cox.multi), adj=1)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

res <- rbind(cox.unadj, cox.adj)

res <- res %>%
  mutate(predictors = case_when(predictors=="sexM" ~ "Male sex",
                                predictors=="EduYr.id" ~ "EduYears",
                              predictors=="relevel(infect.type, 5)gastrointestinal"~"gastrointestinfect.pre.scz",
    predictors=="relevel(infect.type, 5)genital"~"genitalinfect.pre.scz",
                        predictors=="relevel(infect.type, 5)hepatitis"~"hepatitis.pre.scz",
                        predictors=="relevel(infect.type, 5)CNS"~"CNVinfect.pre.scz",
                        predictors=="relevel(infect.type, 5)otitis media"~"earinfect.pre.scz",
                       predictors== "relevel(infect.type, 5)respiratory"~"respiratoryinfec.pre.scz",
                        predictors=="relevel(infect.type, 5)sepsis"~"sepsis.pre.scz",
                       predictors== "relevel(infect.type, 5)skin"~"skininfect.pre.scz",
                       predictors== "relevel(infect.type, 5)urological"~"urologicalinfect.pre.scz",
    predictors=="large_munc_sczdx"~"urban.first.scz",
    predictors=="ai.pre.scz"~"autoimmune.pre.scz",
    TRUE~predictors))
 
# plot OR and 95%CI
# Create labels for plot
          
res$predictors <- factor(res$predictors, levels=rev(c("Male sex",
                                                      "age.first.scz",
                                                      "urban.first.scz",
                                                      "EduYears",
                                                      "fhx.scz",
                                                      "bip.pre.scz",
                                                      "mdd.pre.scz",
                                                      "anx.pre.scz",
                                                      "ptsd.pre.scz",
                                                      "adhd.pre.scz",
                                                      "asd.pre.scz",
                                                      "ed.pre.scz",
                                                      "sui.pre.scz",
                                                      "suds.pre.scz",
                                                      "ocd.pre.scz",
                                                      "congen.malform",
                                                      "intdis.pre.scz",
                                                      "autoimmune.pre.scz",
                                                      "cancer.pre.scz",
                                                      "gastrointestinfect.pre.scz",
                                                      "genitalinfect.pre.scz",
                                                      "hepatitis.pre.scz",
                                                      "CNVinfect.pre.scz",
                                                      "earinfect.pre.scz",
                                                      "respiratoryinfec.pre.scz",
                                                      "skininfect.pre.scz",
                                                      "sepsis.pre.scz",
                                                      "urologicalinfect.pre.scz"
                                                  )))

# put both unadjusted and adjusted estimates into facets, side by side
labels <- c(`0` = "unadjusted (N=13806)", `1` = "adjusted (N=13157, event=1072))")

fig2 <-ggplot(data=res) + # take away sex for now
  geom_pointrange(aes(x=predictors, y=HR, ymin=HR_95L, ymax=HR_95H, col=as.factor(adj))) +
  facet_grid(cols = vars(adj), labeller = labeller(adj=labels)) + 
  geom_hline(yintercept=1, lty=3) +  # add a dotted line at x=1 after flip
  coord_flip() +  # flip coordinates (puts labels on y axis)
  labs(title = "Predictors of premature mortality in SCZ (birth cohort: 1958 to 1993)",
       x="", y="Hazard Ratio (95% CI)") +
  theme_bw() +
  theme(legend.position="none") +
  scale_y_continuous(limits=c(0,8))

ggsave(file="~/Documents/projects/5.tryggve2/tryggve2/paper1/fig_prematuremort_24apr19.png",fig2, width=8, height=6)


```
### Step 10: Cox regression-Long hospitalisation
```{r}

summary(coxph(Surv(time_hsp, hsp_yn) ~ sex, data=analysis))$conf.int -> row1 
summary(coxph(Surv(time_hsp, hsp_yn) ~ age.first.scz, data=analysis))$conf.int -> row2 
summary(coxph(Surv(time_hsp, hsp_yn) ~ bip.pre.scz, data=analysis))$conf.int -> row3
summary(coxph(Surv(time_hsp, hsp_yn) ~ anx.pre.scz, data=analysis))$conf.int -> row4
summary(coxph(Surv(time_hsp, hsp_yn) ~ ptsd.pre.scz, data=analysis))$conf.int -> row5
summary(coxph(Surv(time_hsp, hsp_yn) ~ adhd.pre.scz, data=analysis))$conf.int -> row6
summary(coxph(Surv(time_hsp, hsp_yn) ~ ed.pre.scz, data=analysis))$conf.int -> row7
summary(coxph(Surv(time_hsp, hsp_yn) ~ sui.pre.scz, data=analysis))$conf.int -> row8
summary(coxph(Surv(time_hsp, hsp_yn) ~ suds.pre.scz, data=analysis))$conf.int -> row9
summary(coxph(Surv(time_hsp, hsp_yn) ~ ocd.pre.scz, data=analysis))$conf.int -> row10
summary(coxph(Surv(time_hsp, hsp_yn) ~ asd.pre.scz, data=analysis))$conf.int -> row11
summary(coxph(Surv(time_hsp, hsp_yn) ~ mdd.pre.scz, data=analysis))$conf.int -> row12
summary(coxph(Surv(time_hsp, hsp_yn) ~ ai.pre.scz, data=analysis))$conf.int -> row13
summary(coxph(Surv(time_hsp, hsp_yn) ~ cancer.pre.scz, data=analysis))$conf.int -> row14
#summary(coxph(Surv(time_hsp, hsp_yn) ~ infect.pre.scz, data=analysis))$conf.int -> row15
summary(coxph(Surv(time_hsp, hsp_yn) ~ congen.malform, data=analysis))$conf.int -> row16
summary(coxph(Surv(time_hsp, hsp_yn) ~ intdis.pre.scz, data=analysis))$conf.int -> row17
summary(coxph(Surv(time_hsp, hsp_yn) ~ large_munc_sczdx, data=analysis))$conf.int -> row18
summary(coxph(Surv(time_hsp, hsp_yn) ~ relevel(infect.type,5), data=analysis))$conf.int -> row19 
summary(coxph(Surv(time_hsp, hsp_yn) ~ EduYr.id, data=analysis))$conf.int -> row20
summary(coxph(Surv(time_hsp, hsp_yn) ~ fhx.scz, data=analysis))$conf.int -> row21
summary(coxph(Surv(time_hsp, hsp_yn) ~ birthyear, data=analysis))$conf.int -> row22

#summary(coxph(Surv(time_hsp, hsp_yn) ~ std.grade, data=analysis))$conf.int -> row7
#summary(coxph(Surv(time_hsp, hsp_yn) ~ EduYr.mom, data=analysis))$conf.int -> row8
#summary(coxph(Surv(time_hsp, hsp_yn) ~ EduYr.dad, data=analysis))$conf.int -> row9

rbind(row1,row2,row3,row4,row5,row6,row7,row8,row9,row10,row11,row12,row13,row14,
      row16,row17,row18,row19,row20,row21,row22) -> cox.univ  

rm(row1,row2,row3,row4,row5,row6,row7,row8,row9,row10,row11,row12,row13,row14,
   row16,row17,row18,row19,row20,row21,row22)

cox.unadj <- as_tibble(cox.univ) %>% 
  mutate(predictors=row.names(cox.univ), adj=0)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

# Cox regression - adjusted
cox.multi <- summary(coxph(Surv(time_hsp, hsp_yn) ~ sex + age.first.scz +
                             bip.pre.scz + anx.pre.scz + ptsd.pre.scz + adhd.pre.scz +
                             ed.pre.scz + sui.pre.scz + suds.pre.scz + ocd.pre.scz +
                             asd.pre.scz + mdd.pre.scz + ai.pre.scz + cancer.pre.scz +
                            congen.malform + intdis.pre.scz + 
                             large_munc_sczdx + relevel(infect.type,5) + EduYr.id + fhx.scz + birthyear,
                           data=analysis))$conf.int

cox.adj <- as_tibble(cox.multi) %>% 
  mutate(predictors=row.names(cox.multi), adj=1)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

res <- rbind(cox.unadj, cox.adj)

res <- res %>%
  mutate(predictors = case_when(predictors=="sexM" ~ "Male sex",
                                predictors=="EduYr.id" ~ "EduYears",
                              predictors=="relevel(infect.type, 5)gastrointestinal"~"gastrointestinfect.pre.scz",
    predictors=="relevel(infect.type, 5)genital"~"genitalinfect.pre.scz",
                        predictors=="relevel(infect.type, 5)hepatitis"~"hepatitis.pre.scz",
                        predictors=="relevel(infect.type, 5)CNS"~"CNVinfect.pre.scz",
                        predictors=="relevel(infect.type, 5)otitis media"~"earinfect.pre.scz",
                       predictors== "relevel(infect.type, 5)respiratory"~"respiratoryinfec.pre.scz",
                        predictors=="relevel(infect.type, 5)sepsis"~"sepsis.pre.scz",
                       predictors== "relevel(infect.type, 5)skin"~"skininfect.pre.scz",
                       predictors== "relevel(infect.type, 5)urological"~"urologicalinfect.pre.scz",
    predictors=="large_munc_sczdx"~"urban.first.scz",
    predictors=="ai.pre.scz"~"autoimmune.pre.scz",
    TRUE~predictors))
 
# plot OR and 95%CI
# Create labels for plot
          
res$predictors <- factor(res$predictors, levels=rev(c("Male sex",
                                                      "age.first.scz",
                                                      "urban.first.scz",
                                                      "EduYears",
                                                      "fhx.scz",
                                                      "bip.pre.scz",
                                                      "mdd.pre.scz",
                                                      "anx.pre.scz",
                                                      "ptsd.pre.scz",
                                                      "adhd.pre.scz",
                                                      "asd.pre.scz",
                                                      "ed.pre.scz",
                                                      "sui.pre.scz",
                                                      "suds.pre.scz",
                                                      "ocd.pre.scz",
                                                      "congen.malform",
                                                      "intdis.pre.scz",
                                                      "autoimmune.pre.scz",
                                                      "cancer.pre.scz",
                                                      "gastrointestinfect.pre.scz",
                                                      "genitalinfect.pre.scz",
                                                      "hepatitis.pre.scz",
                                                      "CNVinfect.pre.scz",
                                                      "earinfect.pre.scz",
                                                      "respiratoryinfec.pre.scz",
                                                      "skininfect.pre.scz",
                                                      "sepsis.pre.scz",
                                                      "urologicalinfect.pre.scz",
                                                      "birthyear"
                                                  )))

# put both unadjusted and adjusted estimates into facets, side by side
labels <- c(`0` = "unadjusted (N=13806)", `1` = "adjusted (N=13157, event=3910)")

fig2 <-ggplot(data=res) + # take away sex for now
  geom_pointrange(aes(x=predictors, y=HR, ymin=HR_95L, ymax=HR_95H, col=as.factor(adj))) +
  facet_grid(cols = vars(adj), labeller = labeller(adj=labels)) + 
  geom_hline(yintercept=1, lty=3) +  # add a dotted line at x=1 after flip
  coord_flip() +  # flip coordinates (puts labels on y axis)
  labs(title = "Predictors of long hospitalisation (100 days) in SCZ (birth cohort: 1958 to 1993)",
       x="", y="Hazard Ratio (95% CI)") +
  theme_bw() +
  theme(legend.position="none") +
  scale_y_continuous(limits=c(0,8))

ggsave(file="~/Documents/projects/5.tryggve2/tryggve2/paper1/fig_longHSP_24apr19.png",fig2, width=8, height=6)


```
### Step 11: Cox regression-Treatment resistance
```{r}

summary(coxph(Surv(time_trs, trs_yn) ~ sex, data=analysis))$conf.int -> row1 
summary(coxph(Surv(time_trs, trs_yn) ~ age.first.scz, data=analysis))$conf.int -> row2 
summary(coxph(Surv(time_trs, trs_yn) ~ infect.pre.scz, data=analysis))$conf.int -> row3
summary(coxph(Surv(time_trs, trs_yn) ~ psych_pre.scz, data=analysis))$conf.int -> row4
summary(coxph(Surv(time_trs, trs_yn) ~ z_edlevel, data=analysis))$conf.int -> row6
summary(coxph(Surv(time_trs, trs_yn) ~ fhx.scz, data=analysis))$conf.int -> row7
summary(coxph(Surv(time_trs, trs_yn) ~ std.grade, data=analysis))$conf.int -> row8

rbind(row1,row2,row3,row4,row6, row7,row8) -> cox.univ  

cox.unadj <- as_tibble(cox.univ) %>% 
  mutate(predictors=row.names(cox.univ), adj=0)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

# Cox regression - adjusted
cox.multi <- summary(coxph(Surv(time_trs, trs_yn) ~ 
                             sex + age.first.scz + infect.pre.scz +
                             psych_pre.scz + z_edlevel + std.grade +
                             fhx.scz, data=analysis))$conf.int
#z_edlevel 
cox.adj <- as_tibble(cox.multi) %>% 
  mutate(predictors=row.names(cox.multi), adj=1)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

res <- rbind(cox.unadj, cox.adj)

# plot OR and 95%CI
# Create labels for plot

res$predictors <- factor(res$predictors, levels=rev(c("age.first.scz",
                                                      "sexM",
                                                      "psych_pre.scz",
                                                      "infect.pre.scz",
                                                      "fhx.scz",
                                                      "z_edlevel",
                                                      "std.grade")))

# put both unadjusted and adjusted estimates into facets, side by side
labels <- c(`0` = "unadjusted (N=13561)", `1` = "adjusted (N=11679, event=2445)")

fig2 <-ggplot(data=res) + 
  geom_pointrange(aes(x=predictors, y=HR, ymin=HR_95L, ymax=HR_95H, col=as.factor(adj))) +
  facet_grid(cols = vars(adj), labeller = labeller(adj=labels)) + 
  geom_hline(yintercept=1, lty=3) +  # add a dotted line at x=1 after flip
  coord_flip() +  # flip coordinates (puts labels on y axis)
  labs(title = "Predictors of tx resistance in SCZ (birth cohort: 1958 to 1993)",
       x="", y="Hazard Ratio (95% CI)") +
  theme_bw() +theme(legend.position="none")

ggsave(file="~/Documents/projects/5.tryggve2/tryggve2/paper1/fig_trs_29mar19.png",fig2, width=8, height=6)


```
### Step 12: Cox regression-Composite outcome
```{r}

summary(coxph(Surv(time_any, outcome_yn) ~ sex, data=analysis))$conf.int -> row1 
summary(coxph(Surv(time_any, outcome_yn) ~ age.first.scz, data=analysis))$conf.int -> row2 
summary(coxph(Surv(time_any, outcome_yn) ~ bip.pre.scz, data=analysis))$conf.int -> row3
summary(coxph(Surv(time_any, outcome_yn) ~ anx.pre.scz, data=analysis))$conf.int -> row4
summary(coxph(Surv(time_any, outcome_yn) ~ ptsd.pre.scz, data=analysis))$conf.int -> row5
summary(coxph(Surv(time_any, outcome_yn) ~ adhd.pre.scz, data=analysis))$conf.int -> row6
summary(coxph(Surv(time_any, outcome_yn) ~ ed.pre.scz, data=analysis))$conf.int -> row7
summary(coxph(Surv(time_any, outcome_yn) ~ sui.pre.scz, data=analysis))$conf.int -> row8
summary(coxph(Surv(time_any, outcome_yn) ~ suds.pre.scz, data=analysis))$conf.int -> row9
summary(coxph(Surv(time_any, outcome_yn) ~ ocd.pre.scz, data=analysis))$conf.int -> row10
summary(coxph(Surv(time_any, outcome_yn) ~ asd.pre.scz, data=analysis))$conf.int -> row11
summary(coxph(Surv(time_any, outcome_yn) ~ mdd.pre.scz, data=analysis))$conf.int -> row12
summary(coxph(Surv(time_any, outcome_yn) ~ ai.pre.scz, data=analysis))$conf.int -> row13
summary(coxph(Surv(time_any, outcome_yn) ~ cancer.pre.scz, data=analysis))$conf.int -> row14
summary(coxph(Surv(time_any, outcome_yn) ~ congen.malform, data=analysis))$conf.int -> row16
summary(coxph(Surv(time_any, outcome_yn) ~ intdis.pre.scz, data=analysis))$conf.int -> row17
summary(coxph(Surv(time_any, outcome_yn) ~ large_munc_sczdx, data=analysis))$conf.int -> row18
summary(coxph(Surv(time_any, outcome_yn) ~ relevel(infect.type,5), data=analysis))$conf.int -> row19 
summary(coxph(Surv(time_any, outcome_yn) ~ EduYr.id, data=analysis))$conf.int -> row20
summary(coxph(Surv(time_any, outcome_yn) ~ fhx.scz, data=analysis))$conf.int -> row21
summary(coxph(Surv(time_any, outcome_yn) ~ birthyear, data=analysis))$conf.int -> row22

rbind(row1,row2,row3,row4,row5,row6,row7,row8,row9,row10,row11,row12,row13,row14,
      row16,row17,row18,row19,row20,row21,row22) -> cox.univ  

rm(row1,row2,row3,row4,row5,row6,row7,row8,row9,row10,row11,row12,row13,row14,
   row16,row17,row18,row19,row20,row21,row22)

cox.unadj <- as_tibble(cox.univ) %>% 
  mutate(predictors=row.names(cox.univ), adj=0)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

# Cox regression - adjusted
cox.multi <- summary(coxph(Surv(time_any, outcome_yn) ~ sex + age.first.scz +
                             bip.pre.scz + anx.pre.scz + ptsd.pre.scz + adhd.pre.scz +
                             ed.pre.scz + sui.pre.scz + suds.pre.scz + ocd.pre.scz +
                             asd.pre.scz + mdd.pre.scz + ai.pre.scz + cancer.pre.scz +
                             congen.malform + intdis.pre.scz + 
                             large_munc_sczdx + relevel(infect.type,5) + EduYr.id + fhx.scz + birthyear,
                           data=analysis))$conf.int

cox.adj <- as_tibble(cox.multi) %>% 
  mutate(predictors=row.names(cox.multi), adj=1)  %>%
  rename("HR"="exp(coef)", "HR_neg"="exp(-coef)", "HR_95L"="lower .95", "HR_95H"="upper .95") %>% 
  select(-HR_neg)

res <- rbind(cox.unadj, cox.adj)

res <- res %>%
  mutate(predictors = case_when(predictors=="sexM" ~ "Male sex",
                                predictors=="EduYr.id" ~ "EduYears",
                                predictors=="relevel(infect.type, 5)gastrointestinal"~"gastrointestinfect.pre.scz",
                                predictors=="relevel(infect.type, 5)genital"~"genitalinfect.pre.scz",
                                predictors=="relevel(infect.type, 5)hepatitis"~"hepatitis.pre.scz",
                                predictors=="relevel(infect.type, 5)CNS"~"CNVinfect.pre.scz",
                                predictors=="relevel(infect.type, 5)otitis media"~"earinfect.pre.scz",
                                predictors== "relevel(infect.type, 5)respiratory"~"respiratoryinfec.pre.scz",
                                predictors=="relevel(infect.type, 5)sepsis"~"sepsis.pre.scz",
                                predictors== "relevel(infect.type, 5)skin"~"skininfect.pre.scz",
                                predictors== "relevel(infect.type, 5)urological"~"urologicalinfect.pre.scz",
                                predictors=="large_munc_sczdx"~"urban.first.scz",
                                predictors=="ai.pre.scz"~"autoimmune.pre.scz",
                                TRUE~predictors))

# plot OR and 95%CI
# Create labels for plot

res$predictors <- factor(res$predictors, levels=rev(c("Male sex",
                                                      "age.first.scz",
                                                      "urban.first.scz",
                                                      "EduYears",
                                                      "fhx.scz",
                                                      "bip.pre.scz",
                                                      "mdd.pre.scz",
                                                      "anx.pre.scz",
                                                      "ptsd.pre.scz",
                                                      "adhd.pre.scz",
                                                      "asd.pre.scz",
                                                      "ed.pre.scz",
                                                      "sui.pre.scz",
                                                      "suds.pre.scz",
                                                      "ocd.pre.scz",
                                                      "congen.malform",
                                                      "intdis.pre.scz",
                                                      "autoimmune.pre.scz",
                                                      "cancer.pre.scz",
                                                      "gastrointestinfect.pre.scz",
                                                      "genitalinfect.pre.scz",
                                                      "hepatitis.pre.scz",
                                                      "CNVinfect.pre.scz",
                                                      "earinfect.pre.scz",
                                                      "respiratoryinfec.pre.scz",
                                                      "skininfect.pre.scz",
                                                      "sepsis.pre.scz",
                                                      "urologicalinfect.pre.scz",
                                                      "birthyear"
)))

# put both unadjusted and adjusted estimates into facets, side by side
labels <- c(`0` = "unadjusted (N=13806)", `1` = "adjusted (N=13157, event=5418)")

fig2 <-ggplot(data=res) + 
  geom_pointrange(aes(x=predictors, y=HR, ymin=HR_95L, ymax=HR_95H, col=as.factor(adj))) +
  facet_grid(cols = vars(adj), labeller = labeller(adj=labels)) + 
  geom_hline(yintercept=1, lty=3) +  # add a dotted line at x=1 after flip
  coord_flip() +  # flip coordinates (puts labels on y axis)
  labs(title = "Predictors of poor outcome in SCZ (birth cohort: 1958 to 1993)",
       x="", y="Hazard Ratio (95% CI)") +
  theme_bw() +
  theme(legend.position="none") +
  scale_y_continuous(limits=c(0,3))

ggsave(file="~/Documents/projects/5.tryggve2/tryggve2/paper1/fig_any_7May19.png",fig2, width=8, height=6)


```

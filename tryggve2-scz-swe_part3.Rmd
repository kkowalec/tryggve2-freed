---
title: "Tryggve2 - Schizophrenia - Sweden - Part 3 (outcomes)"
author: "Kaarina Kowalec, kaarina.kowalec@ki.se"
date: "November 2018"
output: 
  html_document: 
    fig_caption: yes
    theme: simplex
    highlight: zenburn
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Motivation and Overview

Examine variables associated with poor outcomes in schizophrenia, using first, the Swedish National Registers. In this report, I will present some initial coding for the analyses.

**Overview**

1. Import data
2. Create a dataframe with all necessary variables including exposures and outcomes
3. Analyses

**Exposures or Predictors**
1) Family of origin:
+ parental ages at birth ##LY
+ parental SES-education-occupation-income
+ birth order
+ family composition (number of parents/partners, parental criminality-incarceration, divorce, siblings, out-of-home placement)

2) Childhood trauma: ##LY
+ parental death
+ severe medical illness of parents/sibs

3) Education: done-kk
+ educational attainment
+ standardized testing in grade 9

4) Prior personal medical history:
+ comorbid disorders and medication use ##kk
+ prior personal medical history (somatic disorders) #kk
+ childhood hospitalization

5) Family history of psychiatric disorder ##kk
+ MD, BIP, psychosis, suicide in first-degree relatives

6) Genetic risk factors  NOT NOW
+ GRS of MDD, SCZ, BIP, IQ etc.

**Outcomes**
+ the number of psychiatric hospitalizations and outpatient contacts 
+ the number of somatic healthcare utilization
+ indication of 2nd or 3rd line treatments (pharmacological augmentation, ECT, TMS, DBS, clozapine) 
+ suicide or suicide attempt

***

### Step 0: Load R packages
```{r R packages}
library(tidyverse)
#library(dplyr)
library(data.table)
#library(ggplot2)
library(lubridate)
library(stringr)
library(skimr)

Sys.setenv(TZ="Europe/Stockholm")
```

### Step 1: Load data
REQUIRE EDITING on the file path
```{r specify file path}
# edit the file path where you have stored the part 1 data
data.f <- "/Users/luyi/CloudStation/WORK_2018/MyProjects_with_Pat/GAPS_MDD/DATA/FREED/DATA/scz.part2.RData"

# load the R data from step 1 and 2
load(data.f) 
```

### Step 2: Outcome 1 & 2: Suicide - attempts or completed
Suicide attempt must have occurred after the first SCZ date and only need first one (for now)
```{r Outcomes 1 and 2: attempted or completed suicides}
# attempts from hospital discharge register

#################################
# Suicides attempts #############
#################################

sui.a <- scz.hdr %>%
   filter((icd.version==8 & grepl("^E950|^E951|^E952$|^E9520|^E9521|^E9529|^E953|
                                   ^E954|^E955|^E956|^E957|^E958|^E959", diagnosis))
      | (icd.version==9 & grepl("^E95A|^E95B|^E95C|^E95D|^E95E|^E95F|^E95G|^E95H|
                                 ^E95W|^E95X", diagnosis))
      | (icd.version==10 & grepl("^X60|^X61|^X62|^X63|^X64|^X65|^X66|^X67|^X68|^X69|
                                  ^X70|^X71|^X72|^X73|^X74|^X75|^X76|^X77|^X78|^X79|^X80|^X81|
                                  ^X82|^X83|^X84", diagnosis)) ) %>%
  mutate(sui = 1,
         admit.date = ymd(as.character(admit.date))) %>%
  arrange(id, admit.date)

sui.a <- inner_join(first.scz.date,sui.a) # inner join together with scz cases to get date of first.scz.admit

sui.a <- sui.a %>%
  filter(admit.date > first_scz_date) %>% # remove sui admission before scz contact   
  arrange(id, admit.date) %>%
  group_by(id) %>%
  mutate(date.outcome1 = first(admit.date),
         outcome1 = 1) %>%
  slice(1) %>%
  select(id, date.outcome1, outcome1)

#################################
# Suicides completed ############
#################################

# completes from death register - need to go back and get this from COD - get entire COD for SCZ (or MDD)

scz.cod <- fread("/Volumes/Common/projects/S3/S3_Research/tryggve2/tryggve_psych_v_cod_scz.tsv", sep="\t") %>%
  as_tibble() %>%
  rename(id=LOPNR,
         dod=X_DODSDAT,
         icd.version=ICD_NR,
         death.cause=CAUSE,
         death.cause.nr=CAUSENR)

sui.c <- scz.cod %>%
   filter((icd.version==8 & grepl("^E950|^E951|^E952$|^E9520|^E9521|^E9529|^E953|
                                  ^E954|^E955|^E956|^E957|^E958|^E959", death.cause))
      | (icd.version==9 & grepl("^E95A|^E95B|^E95C|^E95D|^E95E|^E95F|^E95G|^E95H|^E95W|^E95X", death.cause))
      | (icd.version==10 & grepl("^X60|^X61|^X62|^X63|^X64|^X65|^X66|^X67|^X68|^X69|
                                  ^X70|^X71|^X72|^X73|^X74|^X75|^X76|^X77|^X78|^X79|^X80|^X81|
                                  ^X82|^X83|^X84", death.cause)) ) %>%
  mutate(sui.d = 1,
         death.date = ymd(as.character(dod))) %>%
  arrange(id, death.date)

sui.c <- inner_join(first.scz.date,sui.c) # inner join together with scz cases to get date of first.scz.admit

sui.c <- sui.c %>%
  filter(death.date > first_scz_date) %>% # remove sui death before scz contact **i know, theoretically, impossible
  arrange(id, death.date) %>%
  group_by(id) %>%
  mutate(date.outcome2 = first(death.date),
         outcome2 = 1) %>%
  slice(1) %>%
  select(id, date.outcome2, outcome2)

# merge outcome 1 and 2 with original SCZ dataframe

scz <- left_join(scz, sui.a)
scz <- left_join(scz, sui.c)

rm(sui.a, sui.c)
```


### Step 3: Outcome 3: Premature mortality
+ Mortality which occurs by age 56 years or earlier (any causes) (premature death=56 years as defined by Fazel, Lichtenstein, et al, Lancet Psychiatry 2014)
+ Could also take life expectancy in Sweden for both males and females in 2016 (82.2 years), less 25 years (expected number of years less for someone w SCZ) = 82-25 = 57 years
```{r Outcome 3: Premature mortality}
premature <- scz.cod %>%
  arrange(id, dod) %>%
  mutate(death.date = ymd(as.character(dod))) %>%
  group_by(id) %>%
  slice(1) %>%
  select(id,death.date)

premature <- inner_join(first.scz.date,premature) # inner join together with scz cases to get date of first.scz.admit

premature <- premature %>%
  filter(death.date > first_scz_date) %>% # remove deaths before scz contact **i know, theoretically, impossible
  arrange(id, death.date) %>%
  group_by(id) %>%
  filter(as.numeric((death.date - dob)/365.25) <= 56) %>%
  mutate(date.outcome3 = first(death.date),
        outcome3 = 1) %>%
  slice(1) %>%
  select(id, date.outcome3, outcome3)

# merge outcome 3 with original SCZ dataframe 

scz <- left_join(scz, premature)
rm(premature)
```

### Step 4: Outcome 4: Hospitalisations for SCZ

```{r Outcome 4: Long SCZ hospitalisations}
# need number of days hospitalisation
scz.hdr.ex <- fread("/Volumes/Common/projects/S3/S3_Research/tryggve2/tryggve_psych_v_hdr_ex_scz.tsv", sep="\t") %>%
  select(-PSVARD) %>%
  as_tibble() %>%
  rename(admit.num=X_PID,
         id=LOPNR,
         admit.date=DATUM,
         ward.code=MVO,
         inpatient=SOURCE,
         admit.days=VTID,
         #"psych.care"="PSVARD", # quotations bc character variable
         icd.version=ICD) %>%
  mutate(inpatient = ifelse(inpatient == 2, 0, 1), #recode such that inpatient == 1 and outpatient == 0
         admit.date = ymd(as.character(admit.date))) %>%
  filter(grepl("^9", ward.code)) 

# leave this for now 
# info for psych.care variable
# A	Voluntary (1982: 763)
# B	Voluntary inpatient, ongoing compulsory outpatient (1991: 1128)
# C	Voluntary inpatient, ongoing forensic outpatient (1991: 1129)
# D	Compulsory inpatient (1991: 1128)
# E	Forensic inpatient, with special discharge trial (1991:1129)
# F	Forensic inpatient, without special discharge trial (1991:1129)
# G	Forensic inpatient, other (1991:1129)
# H Compulsory outpatient (1991: 1128)
# I	Forensic outpatient, with special discharge trial (1991:1129)
# J	Forensic outpatient, without special discharge trial (1991:1129)
# K	Retention

# only want to look at SCZ specific admissions but want time in hospital
scz.hdr <- scz.hdr %>%
  filter((icd.version != 10 & substr(diagnosis,1,3) == "295") |
          (icd.version == 10 & substr(diagnosis,1,3) == "F20") |
           (icd.version == 10 & substr(diagnosis,1,3) == "F25")) %>%
  filter(inpatient==1) %>%
  arrange(admit.num, id)

scz.hdr.ex <- scz.hdr.ex %>%
  select(id,admit.num,ward.code,admit.days) %>%
  arrange(admit.num, id)

scz.hdr <- left_join(scz.hdr, scz.hdr.ex)

scz.hdr <- scz.hdr %>%
  filter(!is.na(ward.code))

scz.hdr <- inner_join(first.scz.date,scz.hdr) # inner join together with scz cases to get date of first.scz.admit

scz.hdr <- scz.hdr %>%
  mutate(admit.days_tiles = ntile(admit.days, 10))

#median value in highest decile is 602 days
#how many ppl fit this criteria? there are about 6500 people in each decile
# how about defining as first instance that someone has admission for 100 days

outcome4 <- scz.hdr %>%
  mutate(admit.date = ymd(as.character(admit.date))) %>%
  filter(admit.date > first_scz_date) %>% # remove hospitalisations before first scz contact or equal to first contact
  filter(admit.days > 100) %>% # keep any hospitalisations > 100 days
  arrange(id, admit.date) %>%
  group_by(id) %>%
  mutate(date.outcome4 = first(admit.date),
         outcome4 = 1) %>%
  slice(1) %>%
  select(id, date.outcome4, outcome4)


scz <- left_join(scz, outcome4)
rm(outcome4)

```
### Step 5: Outcome 5: Treatment resistance
```{r Outcome 5: Treatment resistance}
# combine yearly drug data
y05 <- fread("/Volumes/Common/projects/S3/S3_Research/tryggve2/drug/tryggve_psych_cloz_y05.tsv", sep="\t") %>%
  as_tibble() 
y06 <- fread("/Volumes/Common/projects/S3/S3_Research/tryggve2/drug/tryggve_psych_cloz_y06.tsv", sep="\t") %>%
  as_tibble() 
y07 <- fread("/Volumes/Common/projects/S3/S3_Research/tryggve2/drug/tryggve_psych_cloz_y07.tsv", sep="\t") %>%
  as_tibble() 
y08 <- fread("/Volumes/Common/projects/S3/S3_Research/tryggve2/drug/tryggve_psych_cloz_y08.tsv", sep="\t") %>%
  as_tibble() 
y09 <- fread("/Volumes/Common/projects/S3/S3_Research/tryggve2/drug/tryggve_psych_cloz_y09.tsv", sep="\t") %>%
  as_tibble() 
y10 <- fread("/Volumes/Common/projects/S3/S3_Research/tryggve2/drug/tryggve_psych_cloz_y10.tsv", sep="\t") %>%
  as_tibble() 
y11 <- fread("/Volumes/Common/projects/S3/S3_Research/tryggve2/drug/tryggve_psych_cloz_y11.tsv", sep="\t") %>%
  as_tibble() 
y12 <- fread("/Volumes/Common/projects/S3/S3_Research/tryggve2/drug/tryggve_psych_cloz_y12.tsv", sep="\t") %>%
  as_tibble() 
y13 <- fread("/Volumes/Common/projects/S3/S3_Research/tryggve2/drug/tryggve_psych_cloz_y13.tsv", sep="\t") %>%
  as_tibble() 
y14 <- fread("/Volumes/Common/projects/S3/S3_Research/tryggve2/drug/tryggve_psych_cloz_y14.tsv", sep="\t") %>%
  as_tibble() 

outcome5 <- rbind(y05,y06,y07,y08,y09,y10,y11,y12,y13,y14)
rm(y05,y06,y07,y08,y09,y10,y11,y12,y13,y14)

outcome5 <- outcome5 %>%
  rename(id=LOPNR,
         atc=ATC,
         date.redeem=EDATUM) %>%
  mutate(date.redeem = ymd(as.character(date.redeem)))

xoutcome5 <- inner_join(first.scz.date,outcome5) # inner join together with scz cases to get date of first.scz.admit

# remove anyone w clozapine prescription b4 1st scz contact or at first contact
xoutcome5 <- xoutcome5 %>% 
  arrange(id, date.redeem) %>%
  mutate(cloz.b4.scz = ifelse(date.redeem <= first_scz_date, 1, 0)) %>% 
  arrange(desc(cloz.b4.scz)) %>% 
  group_by(id) %>%
  slice(1) %>%
  filter(cloz.b4.scz == 0) %>%
  select(id) #select only ID because these are people who did not receive any CLOZ before SCZ dx

xoutcome5 <- inner_join(xoutcome5,outcome5) # to get back the individual prescription level
xoutcome5 <- inner_join(first.scz.date,xoutcome5) # inner join together with scz cases to get date of first.scz.admit

outcome5 <- xoutcome5 %>%
  arrange(id, date.redeem) %>%
  mutate(date.outcome5 = first(date.redeem),
         outcome5 = 1) %>%
  group_by(id) %>%
  slice(1) %>%
  select(id, date.outcome5, outcome5)

rm(xoutcome5)

scz <- left_join(scz, outcome5)

```


### Step 6: Outcome 6: Hospitalisation for somatic disease
Do only cardiovascular disease for now.
```{r Outcome 6: CVD disease}

# Cardiovascular disease 
#for icd 8 and 9: https://dimdi.de/static/de/klassi/icd-10-who/historie/icd-vorgaenger/icd-8/ICD-8-Systematik.htm
#for icd 10: use Death register publication by Brooke et al 2017 (J. Ludvigsson is co-author)
cvd <- scz.hdr %>%
   filter((icd.version==8 & grepl("^390|^391|^392|^393|^394|^395|^396|^397|^398|^400|^401|^402|^403|^404|^410|^411|^412|^413|^414|^42|^440|^441|
                                  ^442|^443|^444|^445|^446|^447|^448|^450|^451|^452|^453|^454|^455|^456|^457|^458", diagnosis))
      | (icd.version==9 & grepl("^390|^391|^392|^393|^394|^395|^396|^397|^398|^401|^402|^403|^404|^405|^410|^411|^412|^413|^414|^415|^416|^417|
                                ^418|^419|^42|^44|^451|^452|^453|^454|^455|^456|^457|^458|^459", diagnosis))
      | (icd.version==10 & grepl("^I0|^I1|^I2|^I3|^I4|^I5|^I7|^I8|^I9", diagnosis))) %>%
  mutate(cvd = 1,
         cvd.admit.date = ymd(as.character(admit.date))) 

cvd <- inner_join(first.scz.date,cvd) # inner join together with scz cases

outcome6 <- cvd %>%
  filter(cvd.admit.date > first_scz_date) %>% # remove hospitalisations before first scz contact or equal to first contact
  arrange(id, cvd.admit.date) %>%
  group_by(id) %>%
  mutate(date.outcome6 = first(cvd.admit.date),
         outcome6 = 1) %>%
  slice(1) %>%
  select(id, date.outcome6, outcome6)

scz <- left_join(scz, outcome6)
rm(outcome6)

```
### Step 7: Outcome 7 & 8: Disability, divorce
1.9 Income and civil status: from LISA register, on a per-year basis
+ Required Variables:
  + unique ID - rename as "id"  
  + civil - rename as "civil.status"
  + DISPINKPERSF - rename as "income"

Use below, as per C. Dalman BMJ 2016 paper on risk of SCZ in Sweden refugees:
* DISPINKPERSF/Disposable income. Individual, estimated from the total family value, 100 SEK (1990-2004)
* DISPINKPERSF04/Disposable income. Individual, estimated from the total family value, 100 SEK (2004-2013)
```{r read in income and civil levels}
lisa <- fread("/..tsv") %>%
  as_tibble()
# As per Christina Dalman BMJ 2016 paper on risk of SCZ in Sweden refugees, they used disposable income, estimated
# from total family value
# DISPINKPERSF/Disposable annual income. Individual, estimated from the total family value, 100 SEK (1990-2004). I.e. if the value is 970, then the individual made 97,000 kr annually?
# DISPINKPERSF04/Disposable income. Individual, estimated from the total family value, 100 SEK (2004-2013)

lisa %>% count(civil.status)

lisa %>% count(year)
# 14 years of data 1990-2013

summary(lisa$income)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
# -57691     773     970    1046    1198  359834 

# how can a negative value be possible?
# eliminate these for now

lisa <- lisa %>%
  filter(income >= 0)

# plot out income
income.sum <- lisa %>% 
  group_by(year) %>% 
  summarise(N=n(), income.mean = mean(income),income.sd = sd(income))

ggplot(data=income.sum, aes(x=as.integer(year), y=income.mean)) +
  geom_point() +
  labs(x="Assessment Year", y="Mean income")

# clear trend, thus apply standardisation - see below

# read in EU specific ‘poverty threshold’: below national 60%: 
# https://ec.europa.eu/eurostat/web/products-datasets/product?code=tessi014
# this value is set at 60 % of the national median equivalised disposable income (after social transfers). It is expressed in Purchase Parity Standards (PPS) in order to take into account differences in cost of living across EU Member States.
eu.povr <- fread("/Users/kaarinakowalec/Documents/Projects/5.tryggve2/tryggve2/paper1/tessi014.tsv",header=T) %>%
  as_tibble()

eu.povr <- eu.povr[30,] # select only SWEDEN ("SE") value and for single household

# Corresponds to #3, standardize income by birth year and sex 
# TO - DO would need all income measures for entire popultion

income.std <- lisa %>%
  group_by(birth.yr, sex) %>% 
  mutate(income.std_byr_sex = scale(income)) %>% 
  ungroup() %>% 
  filter(!is.na(income.std_byr_sex)) %>% # standardisation further generated some NAs? <- filter for now
  select(id, income.std_byr_sex) 

# can check whether standardisation is properly done using the following: 
income.std %>% 
  group_by(birth.yr, sex) %>% 
  summarise(mean(income.std_byr_sex), sd(income.std_byr_sex))

### civil status

civil <- lisa %>%
  group_by(id, civil.status) %>%
  summarise(n=n()) %>%
  mutate(num_civil_chg = n)


```

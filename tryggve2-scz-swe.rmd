---
title: "Tryggve2 - Schizophrenia - Sweden - "
author: "Kaarina Kowalec, kaarina.kowalec@ki.se"
date: "October 2018"
output: 
  html_document: 
    fig_caption: yes
    theme: simplex
    highlight: zenburn
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Motivation and Overview

NOTE: NOT RUN

Examine variables associated with poor outcomes in schizophrenia, using first, the Swedish National Registers. In this report, I will present some initial coding for the analyses.

**Overview**

1. Import data
2. Create a dataframe with all necessary variables including exposures and outcomes
3. Analyses

**Exposures or Predictors**
1) Family of origin:
+ parental ages at birth ##LY
+ parental SES-education-occupation-income
+ birth order
+ family composition (number of parents/partners, parental criminality-incarceration, divorce, siblings, out-of-home placement)

2) Childhood trauma: ##LY
+ parental death
+ severe medical illness of parents/sibs

3) Education: done-kk
+ educational attainment
+ standardized testing in grade 9

4) Prior personal medical history:
+ comorbid disorders and medication use ##kk
+ prior personal medical history (somatic disorders) #kk
+ childhood hospitalization

5) Family history of psychiatric disorder ##kk
+ MD, BIP, psychosis, suicide in first-degree relatives

6) Genetic risk factors  NOT NOW
+ GRS of MDD, SCZ, BIP, IQ etc.

**Outcomes**
+ the number of psychiatric hospitalizations and outpatient contacts 
+ the number of somatic healthcare utilization
+ indication of 2nd or 3rd line treatments (pharmacological augmentation, ECT, TMS, DBS, clozapine) 
+ suicide or suicide attempt

**TO DOs**

cut down this doc into 4 separate RMD (eventually):
outcome
exposure/risk factors
basics
analysis

***

### Step 1: Load data & packages

1. Hospital discharge data (hdr): all in-/out-patient hospitalisation codes, multiple lines per person, contains date of admission/discharge
2. Population register (pop): birth date, sex, birth country and Swedish birth county 
3. Death register (death): date of death, causes of death
4. Migration register (migrate): date of emigration/immigration
5. Multi-generation register (family): personnummer of index case and personnummer of child/parents
6. Medical birth register (birth): containing birth outcomes
7. Drug register (drug): All prescriptions redeemed between 7/2005-12/2014, with ATC codes/drug names)
8. Education (education): from LISA register; Svensk utbildningsnomenklatur (SUN) or Swedish education nomenclature
9. Grade 9 grades (grades): need?
10. Civil register (civil) - need

```{r warning=FALSE, message=FALSE}
library(dplyr)
library(data.table)
library(ggplot2)
library(lubridate)

Sys.setenv(TZ="Europe/Stockholm")

hdr <- fread("~/Documents/Projects/1.Tx.Resistance/CRIME3.S3/crime3-data/patient_dia_scz.txt", sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "admit.date"="DATUM", # date of admission
         "inpatient"="SOURCE", # inpatient (1) or outpatient (2)
         "icd.version"="ICD",
         "diagnosis"="DIA") %>% # ICD diagnostic code
  mutate(inpatient = ifelse(inpatient == 2, 0, 1)) %>% #recode such that inpatient == 1 and outpatient == 0
  select(-s3cnt) # extra variable from previous study, dont use

pop <- fread("~/pop.tsv", sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "sex"="KON", # 1 = male, 2 = female
         "birth.country"="FODELSEGRUPP",
         "swe.birth.county"="FODELSELAN") %>%
  mutate(swe.birth.county = ifelse(swe.birth.county == 2, 1, swe.birth.county), # account for recategorisation as per Amir
    swe.birth.county = ifelse(swe.birth.county == 11, 12, swe.birth.county),
    swe.birth.county = ifelse(swe.birth.county %in% c(15, 16), 14, swe.birth.county))

pop$birth.country <- as.factor(pop$birth.country)
levels(pop$birth.country) <-
  c(
    "Sweden",
    "Nordic not Sweden",
    "EU28 not Nordic",
    "Europe not EU28 not Nordic",
    "Africa",
    "North America",
    "South America",
    "Asia",
    "Oceania",
    "Soviet union"
  )

# urban vs rural birth?
levels(pop$birth.county) <-
  c("Stockholm County",
    "Uppsala",
    "Sodermanland",
    "Vastergotland",
    "Jonkoping",
    "Kronoberg",
    "Kalmar",
    "Gotland",
    "Blekinge",
    "Skane",
    "Halland",
    "Vastra Gotaland",
    "Varmland",
    "Orebro",
    "Vastmanland",
    "Dalarna",
    "Gavleborg",
    "Vasternorrland",
    "Jamtland",
    "Vasterbotten",
    "Norrbotten"
  )

  
death <- fread("~/death.tsv", sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "death.cause"="CAUSE",
         "icd.version"="ICD_NR",
         "dod"="X_DODSDAT")

migrate <- fread("~/migrate.tsv", sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "migrate.data"="MDATUM",
         "migrate.type"="MTYP") # (E=emigration, I=immigration)

family <- fread("~/family.tsv", sep="\t") %>%
  as_tibble() %>%
  rename("id"=="LOPNR",
         "mom.id"="LOPNRMOR",
         "dad.id"="LOPNRFAR",
         "kid.id"="LOPNRBARN")

birth <- fread("~/birth.tsv", sep="\t") %>%
  as_tibble() %>%
  rename("mom.id"="LOPNRMOR",
         "kid.id"="LOPNRBARN",
         "mom.age.at.birth"="MALDER")

education <- fread("~/education.tsv", sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "edlevel"="SUN2000NIVA")

civil <- fread("~/civil.tsv",sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "year"="AR",
         "civil.status"="CIVIL") %>%
  mutate(civil.status == case_when(civil.status == 1 ~ "Unmarried",
                                   civil.status == 2 ~ "Married man",
                                   civil.status == 3 ~ "Married woman, not cohabiting",
                                   civil.status == 4 | civil.status == "RP" ~ "Divorced",
                                   civil.status == 5 ~ "Widow/Widower",
                                   civil.status == 7 ~ "Married woman, cohabiting",
                                   civil.status == 8 ~ "Child, <18 years",
                                   civil.status == 9 ~ "Fosterchild, <18 years",
                                   civil.status == "EP" ~ "Surviving partner",
                                   civil.status == "G" ~ "Married",
                                   civil.status == "OG" ~ "Registered partner",
                                   civil.status == "SP" ~ "Divorced partner",
                                   civil.status == "â”€" ~ "Widow/Widower",
                                   TRUE ~ NA))

######################################
######### ONLY AVAILABLE IN SWEDEN ###
######################################

# drug register not need by other countries 
drug <- fread("~/drug.tsv", sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "num.pkg"="ANTAL",
         "atc"="ATC",
         "ddd"="DDDFORP",
         "dose"="DOSER", #free text
         "disp.date"="EDATUM", # (yyyy-mm-dd)
         "pkg.size"="FORPSTL",
         "admin.route"="LFORMGRUPP", #  +formula of medication, grouped: 7=cutaneous/transdermal, 14=rectal, 12=unspecified, 9=oral/fast
         "drug.prod"="PRODUKTNAMN", # product name
         "strength_alf"="STYRKA_ALF",
         "strength_enh"="STYRKA_ENH",
         "strength_num"="STYRKNUMERIC")

grades <- fread("~/grades.tsv", sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "grad.yr"="AVGAR",
         "avg.grade.fr88"="MEDELBETYG", # MEDELBETYG	Average grade (1988-1997, min-max=0,0-5,0)
         "merit.grade.fr98"="MERITVARDE") #  MERITVARDE	Merit rating (1998-, best 16 subjects, min-max=0-320)
```
### Step 2: Create data frame with SCZ cases, date of first and second SCZ admission and age at these dates

```{r message=FALSE}

scz <- hdr %>%
  filter((ICD != 10 & substr(DIA,1,3) == "295") | # use grep and refine codes over time
          (ICD == 10 & substr(DIA,1,3) == "F20") |
           (ICD == 10 & substr(DIA,1,3) == "F25")) %>%
  mutate(scz = 1,
         scz_date = ymd(as.character(DATUM))) %>% # date of admission with SCZ as discharge dx
  add_count(LOPNR) %>% 
  mutate(nsczcontacts = n, n=NULL) # n=null removes the original n variable

scz <- scz %>%
  arrange(LOPNR, scz_date) %>%
  group_by(LOPNR) %>%
  mutate(first_scz_date = first(scz_date),
         second_scz_date = nth(scz_date, 2),
         age.first.scz = as.numeric((first_scz_date - dob)/365.25),
         mutate(age.second.scz = as.numeric((second_scz_date - dob)/365.25))) %>%
  ungroup()

# if no second_scz_date, exclude them

## scz hospitalisations
## need to add MVO code == 9 (for psychiatric in/outpatient)

sczinpt <- scz %>%
  filter(SOURCE == 1) %>%
  add_count(LOPNR) %>%
  rename(nsczinpt = n) %>% 
  arrange(LOPNR) %>%
  group_by(LOPNR) %>%
  slice(1) %>%
  select(-X_PID, -X_DID, -DIA, -SOURCE, -DATUM, -ICD, -scz_date, -first_scz_date)

sczoutpt <- scz %>%
  filter(SOURCE == 2) %>%
  add_count(LOPNR) %>%
  rename(nsczoutpt = n) %>% 
  arrange(LOPNR) %>%
  group_by(LOPNR) %>%
  slice(1) %>%
  select(-X_PID, -X_DID, -DIA, -SOURCE, -DATUM, -ICD, -scz_date, -first_scz_date)

scz <- left_join(scz, sczinpt)

scz <- left_join(scz, sczoutpt, by = "LOPNR")

scz <- scz %>%
  mutate(nsczcontacts.x = ifelse(is.na(nsczcontacts.x), nsczcontacts.y, nsczcontacts.x)) %>%
  select(-nsczcontacts.y) %>%
  rename(nsczcontacts = nsczcontacts.x) %>%
  mutate(nsczoutpt = ifelse(is.na(nsczoutpt), 0, nsczoutpt)) %>%
  mutate(nsczinpt = ifelse(is.na(nsczinpt), 0, nsczinpt))


```



### Step 3: Demographics: sex, death, emigration

```{r}
###############################
# DOB #########################
###############################

# add 15 to date (14 to those in Feb, birth.yr = yyyymm)
scz$birth.yr <- as.character(scz$birth.yr)

scz <- scz %>%
  mutate(feb.birth = str_extract(birth.yr, "[:digit:]{4}02"))

scz$feb.birth <- sapply(scz$feb.birth, paste0, "14")

scz <- scz %>%
  mutate(feb.birth = gsub("NA14", NA, feb.birth))

scz$birth.yr <- sapply(scz$birth.yr, paste0, "15")

scz <- scz %>%
  mutate(birth.yr = ifelse(!is.na(feb.birth), feb.birth, birth.yr))
 
###############################
# Death #######################
###############################

death <- death %>%
  mutate(deathdate = ymd(as.character(X_DODSDAT))) %>%
  select(-X_DODSDAT)

scz <- left_join(scz, death) # join in data with main population

###############################
# Date of Emigration ##########
###############################

# select only those born in respective countries?

migrate <- migrate %>%
  filter(MTYP == "E")
  
migrate$MDATUM <- as.character(migrate$MDATUM)

migrate <- migrate %>%
  mutate(feb.birth = str_extract(MDATUM, "[:digit:]{4}02"))

migrate$feb.birth <- sapply(migrate$feb.birth, paste0, "14")

migrate <- migrate %>%
  mutate(feb.birth = gsub("NA14", NA, feb.birth))

migrate$MDATUM <- sapply(migrate$MDATUM, paste0, "15")

migrate <- migrate %>%
  mutate(MDATUM = ifelse(!is.na(feb.birth), feb.birth, MDATUM))

migrate <- migrate %>%
  mutate(emig.date = ymd(as.character(MDATUM))) %>%
  select(-MDATUM, -feb.birth)

migrate <- migrate %>%
  arrange(LOPNR, emig.date) %>%
  group_by(LOPNR) %>%
  mutate(emig.date = first(emig.date)) %>%
  ungroup()

migrate <- migrate %>%
  arrange(LOPNR) %>%
  group_by(LOPNR) %>%
  slice(1)

scz <- left_join(scz, migrate)
```


### Step 4: Exposure set 5: Family history of psychiatric disorder
+ MD, BIP, psychosis, suicide in first-degree relatives
```{r}
# Create 4 new lists : 1) mother, 2) father, 3) child, 4) sibs

mother <- parents %>%
  select(LOPNRMOR) %>%
  distinct(LOPNRMOR)

father <- parents %>%
  select(LOPNRFAR) %>%
  distinct(LOPNRFAR)

offspring <- kids %>%
  select(LOPNRBARN) %>%
  distinct(LOPNRBARN)

# take only relationships with mom and dad LOPNRs included
sibs <- parents %>%
  filter(!is.na(LOPNRFAR) & !is.na(LOPNRMOR)) %>%
  add_count(LOPNRFAR, LOPNRMOR) %>%
  filter(n > 1) %>%
  rename(sibs.aff.scz = n) %>%
  select(-LOPNRFAR, -LOPNRMOR)
  
# inner join w scz file with each of the 4 lists and see if any of these have SCZ/SAD; make variable say scz: yes or no

scz.scz.list <- scz %>%
  select(lopnr) %>%
  mutate(scz = 1)

mother.scz <- inner_join(mother, scz.scz.list, by = c("LOPNRMOR" = "lopnr"))
father.scz <- inner_join(father, scz.scz.list, by = c("LOPNRFAR" = "lopnr"))
kid.scz <- inner_join(offspring, scz.scz.list, by = c("LOPNRBARN" = "lopnr"))
sibs.scz <- inner_join(sibs, scz.scz.list, by = c("LOPNR"="lopnr"))

mother.scz <- mother.scz %>%
  rename(scz.mor = scz)

father.scz <- father.scz %>%
  rename(scz.far = scz)

kid.scz <- kid.scz %>%
  rename(scz.kid = scz)

sibs.scz <- sibs.scz %>%
  rename(scz.sib = scz) %>%
  select(-sibs.aff.scz)

# join back with kids and parents file 

parents <- left_join(parents, mother.scz, by = "LOPNRMOR")
parents <- left_join(parents, father.scz, by = "LOPNRFAR")
kids <- left_join(kids, kid.scz, by = "LOPNRBARN")

# might be interested at some point as to whether or not someone had a kid - so add another variable

kids <- kids %>%
  mutate(fecund = 1)

# remove lopnr specific to parents and kids

kids <- kids %>% 
  select(-LOPNRBARN)
parents <- parents %>%
  select(-LOPNRFAR, -LOPNRMOR)

# remove multiple entries in kids (i.e. >1 kid)

kids <- kids %>%
  arrange(LOPNR) %>%
  group_by(LOPNR) %>%
  slice(1)

# add variable that indicates family history yes or no

parents <- parents %>%
  mutate(fhx = ifelse((!is.na(scz.mor) | !is.na(scz.far)), 1, 0))

kids <- kids %>%
  mutate(fhx = ifelse(!is.na(scz.kid), 1, 0))

# merge parents and kids file

parents <- parents %>%
  rename(parents.fhx = fhx)
kids <- kids %>%
  rename(kids.fhx = fhx)

fhx <- full_join(parents, kids, by = "LOPNR")
fhx <- full_join(fhx, sibs.scz)

fhx <- fhx %>%
  mutate(fhx.scz.any = ifelse((parents.fhx == 1 | kids.fhx == 1 | scz.sib == 1), 1, 0))

fhx <- fhx %>%
  select(LOPNR,fhx.scz.any,fecund)
fhx <- fhx %>%
  mutate(fhx.scz.any = ifelse(is.na(fhx.scz.any), 0, fhx.scz.any))

# join scz with fhx

scz <- left_join(scz, fhx, by = c("lopnr"="LOPNR"))

scz <- scz %>%
  mutate(fhx.scz.any = ifelse(is.na(fhx.scz.any), 0, fhx.scz.any))

#########################################################################
############ Family history of any psychiatric disorder listed ##########
#########################################################################
# 1) strip loprn and create three new lists : 1) mother, 2) father, 3) child

mother <- fullparents %>%
  select(LOPNRMOR) %>%
  distinct(LOPNRMOR)

father <- fullparents %>%
  select(LOPNRFAR) %>%
  distinct(LOPNRFAR)

offspring <- fullkids %>%
  select(LOPNRBARN) %>%
  distinct(LOPNRBARN)
# sibs - take only LOPNRs where both mom and dad LOPNRs listed
sibs <- fullparents %>%
  filter(!is.na(LOPNRFAR) & !is.na(LOPNRMOR)) %>%
  add_count(LOPNRFAR, LOPNRMOR) %>%
  filter(n > 1) %>%
  select(-LOPNRFAR, -LOPNRMOR)


# 2) inner join w each disorder file with each of the 3 lists and see if any of these have the psych dis; make variable say scz: yes or no

adhd <- adhd %>%
  select(lopnr) %>%
  mutate(adhd = 1)
anorex <- anorex %>%
  select(lopnr) %>%
  mutate(anor = 1)
anxiet <- anxiet %>%
  select(lopnr) %>%
  mutate(anx = 1)
asd <- asd %>%
  select(lopnr) %>%
  mutate(asd = 1)
bip <- bip %>%
  select(lopnr) %>%
  mutate(bip = 1)
mdd <- mdd %>%
  select(lopnr) %>%
  mutate(mdd = 1)
ocd <- ocd %>%
  select(lopnr) %>%
  mutate(ocd = 1)
ptsd <- ptsd %>%
  select(lopnr) %>%
  mutate(ptsd = 1)
sud <- sud %>%
  select(lopnr) %>%
  mutate(sud = 1)
sui <- sui %>%
  select(lopnr) %>%
  mutate(sui = 1)

mother.adhd <- inner_join(mother, adhd, by = c("LOPNRMOR" = "lopnr"))
mother.anorex <- inner_join(mother, anorex, by = c("LOPNRMOR" = "lopnr"))
mother.anxiet <- inner_join(mother, anxiet, by = c("LOPNRMOR" = "lopnr"))
mother.asd <- inner_join(mother, asd, by = c("LOPNRMOR" = "lopnr"))
mother.bip <- inner_join(mother, bip, by = c("LOPNRMOR" = "lopnr"))
mother.mdd <- inner_join(mother, mdd, by = c("LOPNRMOR" = "lopnr"))
mother.ocd <- inner_join(mother, ocd, by = c("LOPNRMOR" = "lopnr"))
mother.ptsd <- inner_join(mother, ptsd, by = c("LOPNRMOR" = "lopnr"))
mother.sud <- inner_join(mother, sud, by = c("LOPNRMOR" = "lopnr"))
mother.sui <- inner_join(mother, sui, by = c("LOPNRMOR" = "lopnr"))

father.adhd <- inner_join(father, adhd, by = c("LOPNRFAR" = "lopnr"))
father.anorex <- inner_join(father, anorex, by = c("LOPNRFAR" = "lopnr"))
father.anxiet <- inner_join(father, anxiet, by = c("LOPNRFAR" = "lopnr"))
father.asd <- inner_join(father, asd, by = c("LOPNRFAR" = "lopnr"))
father.bip <- inner_join(father, bip, by = c("LOPNRFAR" = "lopnr"))
father.mdd <- inner_join(father, mdd, by = c("LOPNRFAR" = "lopnr"))
father.ocd <- inner_join(father, ocd, by = c("LOPNRFAR" = "lopnr"))
father.ptsd <- inner_join(father, ptsd, by = c("LOPNRFAR" = "lopnr"))
father.sud <- inner_join(father, sud, by = c("LOPNRFAR" = "lopnr"))
father.sui <- inner_join(father, sui, by = c("LOPNRFAR" = "lopnr"))

kid.adhd <- inner_join(offspring, adhd, by = c("LOPNRBARN" = "lopnr"))
kid.anorex <- inner_join(offspring, anorex, by = c("LOPNRBARN" = "lopnr"))
kid.anxiet <- inner_join(offspring, anxiet, by = c("LOPNRBARN" = "lopnr"))
kid.asd <- inner_join(offspring, asd, by = c("LOPNRBARN" = "lopnr"))
kid.bip <- inner_join(offspring, bip, by = c("LOPNRBARN" = "lopnr"))
kid.mdd <- inner_join(offspring, mdd, by = c("LOPNRBARN" = "lopnr"))
kid.ocd <- inner_join(offspring, ocd, by = c("LOPNRBARN" = "lopnr"))
kid.ptsd <- inner_join(offspring, ptsd, by = c("LOPNRBARN" = "lopnr"))
kid.sud <- inner_join(offspring, sud, by = c("LOPNRBARN" = "lopnr"))
kid.sui <- inner_join(offspring, sui, by = c("LOPNRBARN" = "lopnr"))

sib.adhd <- inner_join(sibs, adhd, by = c("LOPNR" = "lopnr"))
sib.anorex <- inner_join(sibs, anorex, by = c("LOPNR" = "lopnr"))
sib.anxiet <- inner_join(sibs, anxiet, by = c("LOPNR" = "lopnr"))
sib.asd <- inner_join(sibs, asd, by = c("LOPNR" = "lopnr"))
sib.bip <- inner_join(sibs, bip, by = c("LOPNR" = "lopnr"))
sib.mdd <- inner_join(sibs, mdd, by = c("LOPNR" = "lopnr"))
sib.ocd <- inner_join(sibs, ocd, by = c("LOPNR" = "lopnr"))
sib.ptsd <- inner_join(sibs, ptsd, by = c("LOPNR" = "lopnr"))
sib.sud <- inner_join(sibs, sud, by = c("LOPNR" = "lopnr"))
sib.sui <- inner_join(sibs, sui, by = c("LOPNR" = "lopnr"))


mother.adhd <- mother.adhd %>%
  rename(adhd.mor = adhd)
mother.anorex <- mother.anorex %>%
  rename(anorex.mor = anor)
mother.anxiet <- mother.anxiet %>%
  rename(anx.mor = anx)
mother.asd <- mother.asd %>%
  rename(asd.mor = asd)
mother.bip <- mother.bip %>%
  rename(bip.mor = bip)
mother.mdd <- mother.mdd %>%
  rename(mdd.mor = mdd)
mother.ocd <- mother.ocd %>%
  rename(ocd.mor = ocd)
mother.ptsd <- mother.ptsd %>%
  rename(ptsd.mor = ptsd)
mother.sud <- mother.sud %>%
  rename(sud.mor = sud)
mother.sui <- mother.sui %>%
  rename(sui.mor = sui)

father.adhd <- father.adhd %>%
  rename(adhd.far = adhd)
father.anorex <- father.anorex %>%
  rename(anorex.far = anor)
father.anxiet <- father.anxiet %>%
  rename(anx.far = anx)
father.asd <- father.asd %>%
  rename(asd.far = asd)
father.bip <- father.bip %>%
  rename(bip.far = bip)
father.mdd <- father.mdd %>%
  rename(mdd.far = mdd)
father.ocd <- father.ocd %>%
  rename(ocd.far = ocd)
father.ptsd <- father.ptsd %>%
  rename(ptsd.far = ptsd)
father.sud <- father.sud %>%
  rename(sud.far = sud)
father.sui <- father.sui %>%
  rename(sui.far = sui)

kid.adhd <- kid.adhd %>%
  rename(adhd.kid = adhd)
kid.anorex <- kid.anorex %>%
  rename(anorex.kid = anor)
kid.anxiet <- kid.anxiet %>%
  rename(anx.kid = anx)
kid.asd <- kid.asd %>%
  rename(asd.kid = asd)
kid.bip <- kid.bip %>%
  rename(bip.kid = bip)
kid.mdd <- kid.mdd %>%
  rename(mdd.kid = mdd)
kid.ocd <- kid.ocd %>%
  rename(ocd.kid = ocd)
kid.ptsd <- kid.ptsd %>%
  rename(ptsd.kid = ptsd)
kid.sud <- kid.sud %>%
  rename(sud.kid = sud)
kid.sui <- kid.sui %>%
  rename(sui.kid = sui)

sib.adhd <- sib.adhd %>%
  rename(adhd.sib = adhd)
sib.anorex <- sib.anorex %>%
  rename(anorex.sib = anor)
sib.anxiet <- sib.anxiet %>%
  rename(anx.sib = anx)
sib.asd <- sib.asd %>%
  rename(asd.sib = asd)
sib.bip <- sib.bip %>%
  rename(bip.sib = bip)
sib.mdd <- sib.mdd %>%
  rename(mdd.sib = mdd)
sib.ocd <- sib.ocd %>%
  rename(ocd.sib = ocd)
sib.ptsd <- sib.ptsd %>%
  rename(ptsd.sib = ptsd)
sib.sud <- sib.sud %>%
  rename(sud.sib = sud)
sib.sui <- sib.sui %>%
  rename(sui.sib = sui)

# 4) join back with kids and parents file 

fullparents <- left_join(fullparents, mother.adhd, by = "LOPNRMOR")
fullparents <- left_join(fullparents, mother.anorex, by = "LOPNRMOR")
fullparents <- left_join(fullparents, mother.anxiet, by = "LOPNRMOR")
fullparents <- left_join(fullparents, mother.asd, by = "LOPNRMOR")
fullparents <- left_join(fullparents, mother.bip, by = "LOPNRMOR")
fullparents <- left_join(fullparents, mother.mdd, by = "LOPNRMOR")
fullparents <- left_join(fullparents, mother.ocd, by = "LOPNRMOR")
fullparents <- left_join(fullparents, mother.ptsd, by = "LOPNRMOR")
fullparents <- left_join(fullparents, mother.sud, by = "LOPNRMOR")
fullparents <- left_join(fullparents, mother.sui, by = "LOPNRMOR")

fullparents <- left_join(fullparents, father.adhd, by = "LOPNRFAR")
fullparents <- left_join(fullparents, father.anorex, by = "LOPNRFAR")
fullparents <- left_join(fullparents, father.anxiet, by = "LOPNRFAR")
fullparents <- left_join(fullparents, father.asd, by = "LOPNRFAR")
fullparents <- left_join(fullparents, father.bip, by = "LOPNRFAR")
fullparents <- left_join(fullparents, father.mdd, by = "LOPNRFAR")
fullparents <- left_join(fullparents, father.ocd, by = "LOPNRFAR")
fullparents <- left_join(fullparents, father.ptsd, by = "LOPNRFAR")
fullparents <- left_join(fullparents, father.sud, by = "LOPNRFAR")
fullparents <- left_join(fullparents, father.sui, by = "LOPNRFAR")

fullparents <- left_join(fullparents, parents.scz, by = "LOPNR")

fullkids <- left_join(fullkids, kid.adhd, by = "LOPNRBARN")
fullkids <- left_join(fullkids, kid.anorex, by = "LOPNRBARN")
fullkids <- left_join(fullkids, kid.anxiet, by = "LOPNRBARN")
fullkids <- left_join(fullkids, kid.asd, by = "LOPNRBARN")
fullkids <- left_join(fullkids, kid.bip, by = "LOPNRBARN")
fullkids <- left_join(fullkids, kid.mdd, by = "LOPNRBARN")
fullkids <- left_join(fullkids, kid.ocd, by = "LOPNRBARN")
fullkids <- left_join(fullkids, kid.ptsd, by = "LOPNRBARN")
fullkids <- left_join(fullkids, kid.sud, by = "LOPNRBARN")
fullkids <- left_join(fullkids, kid.sui, by = "LOPNRBARN")
fullkids <- left_join(fullkids, kid.scz, by = "LOPNR")


fullkids <- fullkids %>%
  mutate(kid.fhx.any = case_when(adhd.kid == 1 | 
                                     anorex.kid == 1 |
                                     anx.kid == 1 |
                                      asd.kid == 1 |
                                     bip.kid == 1 |
                                      mdd.kid == 1 |
                                     ocd.kid == 1 |
                                      ptsd.kid == 1 |
                                     sud.kid == 1 |
                                     sui.kid == 1 |
                                      scz.kid == 1 ~ 1,
                                   TRUE ~ 0
                                     ))
 

fullkids <- fullkids %>%
  filter(kid.fhx.any == 1) %>%
  arrange(LOPNR) %>%
  group_by(LOPNR) %>%
  slice(1) %>%
  select(LOPNR,kid.fhx.any)

# bip only
#fullkids <- fullkids %>%
 # filter(bip.kid == 1) %>%
#  arrange(LOPNR) %>%
 # group_by(LOPNR) %>%
  #slice(1) %>%
  #select(LOPNR,bip.kid)

fullparents <- fullparents %>%
  mutate(parent.fhx.any = case_when(adhd.mor == 1 | adhd.far == 1 |
                                    anorex.mor == 1 | anorex.far ==1 |
                                    anx.mor == 1 | anx.far == 1 | 
                                    asd.mor == 1 | asd.far == 1 |
                                    bip.mor == 1 | bip.far == 1 |
                                    mdd.mor == 1 | mdd.far == 1 |
                                    ocd.mor == 1 | ocd.far == 1 |
                                    ptsd.mor == 1 | ptsd.far == 1 |
                                    sud.mor == 1 | sud.far == 1 |
                                    sui.mor == 1| sui.far == 1 |
                                    scz.mor == 1 |scz.far == 1 ~ 1,
                                   TRUE ~ 0
                                     )) 
fullparents <- fullparents %>%
       filter(parent.fhx.any == 1) %>%
  select(LOPNR,parent.fhx.any)
#bip only
#fullparents <- fullparents %>%
 #      filter(bip.mor == 1 | bip.far ==1) %>%
  #  mutate(parent.fhx.bip = case_when(bip.mor == 1 | bip.far == 1 ~ 1,
   #                                TRUE ~ 0
    #                                 )) %>%
  #           select(LOPNR,parent.fhx.bip)


fullkids <- fullkids %>%
       filter(kid.fhx.any == 1) %>%
  select(LOPNR,kid.fhx.any)

# Join sibs

sibs <- left_join(sibs, sib.adhd, by = "LOPNR")
sibs <- left_join(sibs, sib.anorex, by = "LOPNR")
sibs <- left_join(sibs, sib.anxiet, by = "LOPNR")
sibs <- left_join(sibs, sib.asd, by = "LOPNR")
sibs <- left_join(sibs, sib.bip, by = "LOPNR")
sibs <- left_join(sibs, sib.mdd, by = "LOPNR")
sibs <- left_join(sibs, sib.ocd, by = "LOPNR")
sibs <- left_join(sibs, sib.ptsd, by = "LOPNR")
sibs <- left_join(sibs, sib.sud, by = "LOPNR")
sibs <- left_join(sibs, sib.sui, by = "LOPNR")
sibs <- left_join(sibs, sibs.scz, by = "LOPNR")


# 7) add variable that indicates family history yes or no
sibs <- sibs %>%
  mutate(sibs.fhx.any = case_when(adhd.sib == 1 | 
                                  anorex.sib == 1 |
                                  anx.sib == 1 |  
                                  asd.sib == 1 |
                                  bip.sib == 1 | 
                                  mdd.sib == 1 |
                                  ocd.sib == 1 | 
                                  ptsd.sib == 1 | 
                                  sud.sib == 1 | 
                                  sui.sib == 1 |
                                  scz.sib == 1 ~ 1,
                                   TRUE ~ 0
                                     )) 
sibs <- sibs %>%
  select(LOPNR, sibs.fhx.any) %>%
  filter(sibs.fhx.any == 1)
# 8) merge parents kids sibs file

other.fhx <- full_join(fullparents, fullkids, by = "LOPNR")
other.fhx <- full_join(other.fhx, sibs, by = "LOPNR")

other.fhx <- other.fhx %>%
  mutate(fhx.other.any = case_when(parent.fhx.any == 1 | kid.fhx.any | sibs.fhx.any ~ 1,
                                   TRUE ~ 0
                                     ))
         
other.fhx.2 <- other.fhx %>%
  select(LOPNR, fhx.other.any)
#bip only
other.fhx <- full_join(fullparents, fullkids, by = "LOPNR")
other.fhx <- full_join(other.fhx, sibs, by = "LOPNR")

other.fhx <- other.fhx %>%
  mutate(fhx.bip = case_when(parent.fhx.bip == 1 | bip.kid | bip.sib ~ 1,
                                   TRUE ~ 0
                                     ))
         
other.fhx <- other.fhx %>%
  select(LOPNR, fhx.bip)

# 9) join scz with fhx

scz <- left_join(scz, other.fhx, by=c("lopnr"="LOPNR"))

scz <- scz %>%
  mutate(fhx.other.any = ifelse(is.na(fhx.other.any), 0, fhx.other.any))
scz <- scz %>%
  mutate(fhx.bip = ifelse(is.na(fhx.bip), 0, fhx.bip))



```

### Step 5: Exposure set 1: Family of origin
+ parental ages at birth
+ parental SES-education-occupation-income
+ birth order
+ family composition (number of parents/partners, parental criminality-incarceration, divorce, siblings, out-of-home placement)
```{r}
# parental ages at birth
# mother from Medical Birth Register:+ MALDER	Mothers age at child birth (years).
maternal.age <-
# father from link to multigeneration register to get father then link to population register
paternal.age <-

# parental SES-education-occupation-income
# parent education - linking from above education register + multigen reg

# birth order
# family composition (number of parents/partners, divorce, siblings, out-of-home placement)
# multigeneration register for number of parents, kids
  
  
  
```


### Step 6: Exposure set 2: Childhood trauma
+ parental death: cause of death + multigen that occurs < 18 year
+ severe medical illness = "severe" would be? age < 18 year?
```{r}


```
### Step 7: Exposure set 3: Education - done
+ standardized testing in grade 9
+ educational attainment
```{r}
#################
#### GRADES #####
#################

# find if any duplicates - i.e. individuals had > 1 assessment - select first assessment only
grades.dup <- grades %>%
  group_by(LOPNR) %>%
  filter(n()>1)

# in duplicates, select first assesment for any that have >1 assessment and assign a dummy variable to indicate ones to keep
grades.dup <- grades.dup %>%
  arrange(LOPNR) %>%
  group_by(LOPNR) %>%
  slice(1) %>%
  mutate(dup = 1)

grades.dup.1 <- grades %>%
  group_by(LOPNR) %>%
  filter(n()>1)

join <- left_join(grades.dup.1, grades.dup)

join <- join %>%
  mutate(dup = ifelse(is.na(dup), 0, dup))

grades <- left_join(grades, join)

grades <- grades %>%
  filter(is.na(dup) | dup == 1) %>%
  select(-dup)

# split between two measure of grading
# note: if avg.grade is = 0 this could be either failed or not participated
# ie you CANNOT tell the difference

########## 1988 to 1997 ##################
# standardize avg.grade.fr88 grades88to97
# (1988-1997, min-max=0,0-5,0)

grades88to97 <- grades %>%
  filter(grad.yr >= 1988 & grad.yr <= 1997) %>%
  group_by(grad.yr) %>%
  mutate(z_avg.grade88to97 = scale(avg.grade.fr88, center = TRUE, scale = TRUE)) %>%
  ungroup()

# check distribution
hist(grades88to97$z_avg.grade88to97)
# note: there are 5068 (see below) with "0" recorded for grade
# these are either did not participate or failed

grades88to97 %>% filter(avg.grade.fr88 == 0) %>% summarise(n=n())

########################################

########## 1998 ####################
# Standardize avg.grade.fr98 grades98
# Merit rating (1998-, best 16 subjects, min-max=0-320)

grades98toCurrent <- grades %>%
  filter(grad.yr >= 1998)

grades98toCurrent <- grades98toCurrent %>%
  group_by(grad.yr) %>%
  mutate(z_avg.grade98toCur = scale(merit.grade.fr98, center = TRUE, scale = TRUE)) %>%
  ungroup()

# check distribution
hist(grades98toCurrent$z_avg.grade98toCur)
########################################

# merge back together
grades.2 <- full_join(grades88to97, grades98toCurrent)

# any duplicates? there are 9 dups - leave in
grades.2 %>% distinct(lopnr) %>% summarise(n=n())

# how many missing grade year? none 
grades.2 %>% filter(is.na(grad.yr)) %>% summarise(n=n())

# combine two measures into one
grades.2 <- grades.2 %>%
  rename(std.grade = z_avg.grade98toCur) %>%
  mutate(std.grade = ifelse(is.na(std.grade),z_avg.grade88to97, std.grade))

# how many missing grades? 0 missing
grades.2 %>% filter(is.na(std.grade)) %>% summarise(n=n())
hist(grades.2$std.grade)

### merge with studypop file
studypop <- left_join(studypop, sub)

#############################

############################# 
######## Education ##########
############################# 
x <- x %>%
  mutate(edlevel.2 = case_when(edlevel == 320 |
                               edlevel == 322 |
                               edlevel == 323 |
                               edlevel == 326 |
                               edlevel == 327 |
                               edlevel == 330 | 
                               edlevel == 332 |
                               edlevel == 333 | 
                               edlevel == 336 | 
                               edlevel == 337 ~ "UpperSecondary",
                             edlevel == 410 | 
                               edlevel == 412 | 
                               edlevel == 413 | 
                               edlevel == 415 |
                               edlevel == 417 |
                               edlevel == 530 | 
                               edlevel == 532 | 
                               edlevel == 536 |
                               edlevel == 537 |
                               edlevel == 520 | 
                               edlevel == 522 |
                               edlevel == 525 | 
                               edlevel == 526 | 
                               edlevel == 527 | 
                               edlevel == 535 | 
                               edlevel == 540 |
                               edlevel == 545 |
                               edlevel == 546 |
                               edlevel == 547 | 
                               edlevel == 550 | 
                               edlevel == 555 |
                               edlevel == 556 | 
                               edlevel == 557 | 
                               edlevel == 600 | 
                               edlevel == 620 | 
                               edlevel == 640 ~ "FurtherEd",
                             edlevel == 100 |
                               edlevel == 102 | 
                               edlevel == 106 |
                               edlevel == 200 | 
                               edlevel == 204 | 
                               edlevel == 206 | 
                               edlevel == 310 | 
                               edlevel == 312 | 
                               edlevel == 313 | 
                               edlevel == 316 | 
                               edlevel == 317 ~ "Compulsory",
                             TRUE ~ "NA"))


```


### Step 8: Exposure set 4: Prior personal or psychiatric history
**only those with a date before first treatment contact**
+ comorbid psych disorders: psych (adhd, ed, anx, asd, bip, mdd, ocd, ptsd, suds)
+ comorbid somatic disorders: autoimmune, infections, cancer, CVD
+ medication use
```{r}
# adhd
adhd <- hdr %>% 
  filter(  (icd.version==9 & grepl("^314|^314A|^314B|^314C|^314J|^314W|^314X", diagnosis))
           | (icd.version==10 & grepl("^F90|^F900|^F901|^F908", diagnosis)) 
  ) %>%
  mutate(adhd = 1,
         date = ymd(as.character(admit.date))) %>%
  arrange(id, date) %>%
  group_by(id) %>%
  mutate(first.adhd.date = first(date)) %>%
  slice(1) %>%
  select(id,adhd,first.adhd.date)


# mdd need codes from LY
mdd <- hdr %>% 
  filter(  (icd.version==8 & grepl("", diagnosis)) |
             (icd.version==9 & grepl("", diagnosis)) |
             (icd.version==10 & grepl("", diagnosis)) 
  ) %>%
  mutate(mdd = 1,
         date = ymd(as.character(admit.date))) %>%
  arrange(id, date) %>%
  group_by(id) %>%
  mutate(first.mdd.date = first(date)) %>%
  slice(1) %>%
  select(id,mdd,first.mdd.date)

# bip
bip <- hdr %>% 
  filter((icd.version==8 & grepl("^2961|^2963|^2968", diagnosis)) |
    (icd.version==9 & grepl("^296|^269A|^269C|^2691|^296D|^2694|^296E|^2965|^296F|^2966|^296G|^2697|^269H|^2691|^26989|^269W|^26999|^269X", diagnosis)) |
    (icd.version==10 & grepl("^F30$|^F301|^F302|^F308|^F309|^F31|^F310|^F311|^F312|^F313|^F314|^F315|^F316|^F317|^F318|^F319", diagnosis))
    ) %>%
  mutate(bip = 1,
         date = ymd(as.character(admit.date))) %>%
  arrange(id, date) %>%
  group_by(id) %>%
  mutate(first.bip.date = first(date)) %>%
  slice(1) %>%
  select(id,bip,first.bip.date)

# anxiety
anx <- hdr %>% 
  filter(  (icd.version==8 & grepl("^300|^3000|^3002", diagnosis)) |
             (icd.version==9 & grepl("^300|^300A|^300C", diagnosis)) |
             (icd.version==10 & grepl("^F40|^F400|^F401|^F402|^F408|^F409|^F41|^F410|^F411|^F412|^F413|^F418|^F419", diagnosis)) 
  ) %>%
  mutate(anx = 1,
         date = ymd(as.character(admit.date))) %>%
  arrange(id, date) %>%
  group_by(id) %>%
  mutate(first.anx.date = first(date)) %>%
  slice(1) %>%
  select(id,anx,first.anx.date)

# ptsd
ptsd <- hdr %>% 
  filter(  (icd.version==8 & grepl("^307", diagnosis)) |
             (icd.version==9 & grepl("^308|^308A|^308B|^308C|^308D|^308E|^308X|^309|^309A|^309B|^309C|^309D|^309E|^309W|^309X", diagnosis)) |
             (icd.version==10 & grepl("^F43|^F430|^F431|^F432|^F438|^F439", diagnosis)) 
  ) %>%
  mutate(ptsd = 1,
         date = ymd(as.character(admit.date))) %>%
  arrange(id, date) %>%
  group_by(id) %>%
  mutate(first.ptsd.date = first(date)) %>%
  slice(1) %>%
  select(id,ptsd,first.ptsd.date)

# eating disorders  
ed <- hdr %>%
  filter(  (icd.version==8 & grepl("^7840|^3065", diagnosis))
           | (icd.version==9 & grepl("^307B|^307F", diagnosis))
           | (icd.version==10 & grepl("^F50|^F500|^F501|^F502|^F503|^F509", diagnosis)) 
  ) %>%
  mutate(ed = 1,
         date = ymd(as.character(admit.date))) %>%
  arrange(id, date) %>%
  group_by(id) %>%
  mutate(first.ed.date = first(date)) %>%
  slice(1) %>%
  select(id,ed,first.ed.date)

# substance use disorder
suds <- hdr %>%
  filter(  (icd.version==8 & grepl("^303|^3030|^3031|^3032|^3039|^304|^3040|^3041|^3042|^3043|^3044|^3045|^3046|^3047|^3048|^3049", diagnosis))
           | (icd.version==9 & grepl("^303|^303A|^303X|^304|^304A|^304B|^304C|^304D|^304D|^304E|^304F|^304G|^304H|^304W|^304X|^305A|^305X", diagnosis))
           | (icd.version==10 & grepl("^F10|^F100|^F101|^F102|^F103|^F104|^F105|^F106|^F107|^F108|^F109|^F11|^F110|^F111|^F112|^F113|^F114|^F115|^F116|^F117|^F118|^F119|
                               F19|^F190|^F191|^F192|^F192|^F194|^F195|^F196|^F197|^F198|^F199", diagnosis)) 
  ) %>%
  mutate(suds = 1,
         date = ymd(as.character(admit.date))) %>%
  arrange(id, date) %>%
  group_by(id) %>%
  mutate(first.suds.date = first(date)) %>%
  slice(1) %>%
  select(id,suds,first.suds.date)

# suicide attempts
sui <- hdr %>%
   filter((icd.version==8 & grepl("^E950|^E951|^E952$|^E9520|^E9521|^E9529|^E953|^E954|^E955|^E956|^E957|^E958|^E959", diagnosis))
      | (icd.version==9 & grepl("^E95A|^E95B|^E95C|^E95D|^E95E|^E95F|^E95G|^E95H|^E95W|^E95X", diagnosis))
      | (icd.version==10)) %>%
  mutate(sui = 1,
         date = ymd(as.character(admit.date))) %>%
  arrange(id, date) %>%
  group_by(id) %>%
  mutate(first.sui.date = first(date)) %>%
  slice(1) %>%
  select(id,sui,first.sui.date)

# ocd
ocd <- hdr %>%
   filter((icd.version==8 & grepl("^3003", diagnosis))
      | (icd.version==9 & grepl("^300D", diagnosis))
      | (icd.version==10 & grepl("^F42|^F420|^F421|^F422|^F428|^F429", diagnosis))) %>%
  mutate(ocd = 1,
         date = ymd(as.character(admit.date))) %>%
  arrange(id, date) %>%
  group_by(id) %>%
  mutate(first.ocd.date = first(date)) %>%
  slice(1) %>%
  select(id,ocd,first.ocd.date)

#########################################
###### MERGE ALL PSYCH DISORDERS ########
#########################################

psych.comorbid <- rbind(mdd,bip,anx,ptsd,adhd,ed,sui,suds,ocd)
rm(mdd,bip,anx,ptsd,adhd,ed,sui,suds,ocd)

#########################################
# MERGE with SCZ base file and select only those preceeding date of first SCZ contact
#########################################

x <- left_join(scz,psych.comorbid)

x <- x %>%
  filter(first.ocd.date >= first.scz.date |
           first.ptsd.date >= first.scz.date |
           first.suds.date >= first.scz.date |
           first.ed.date >= first.scz.date |
           first.anx.date >= first.scz.date |
           first.mdd.date >= first.scz.date |
           first.bip.date >= first.scz.date |
           first.adhd.date >= first.scz.date |
           first.asd.date >= first.scz.date
           ) 

#########################################
## Prior personal medical history (somatic disorders)
#########################################

# Autoimmune diseases from Song et al JAMA 2018 (autoimmune / PTSD overlap; Unnurs group)

# Diabetes mellitus, insulin dependent icd-8: 250, icd-9: 250, 242A, icd-10: E10
# Autoimmune thyroid disease ICD8: 242.00, 242.09, 244, 245.03; ICD9: 242A, 242X, 244W, 244X, 245C, 245W; ICD10: E03.5, E03.9, E05.0, E05.5, E05.9, E06.3, E06.5
# Addisonâ€™s disease ICD8: 255.1	ICD9: 255E, ICD10:	E27.1, E27.2
# Autoimmune polyglandular syndrome	8: 258.10; 9:	258B; 10:	E31.0
# Reactive arthritis (Reiterâ€™s syndrome)	8: 099.3, 711.1	9: 099D, 711A	10: M02.3, M02.8, M02.9
# Rheumatoid arthritis	8: 712.00, 712.10, 712,20, 712,39, 712.38	9: 714A-D, 719D; 10: M05, M06, M08.0, M08.1, M08.2, M08.3, M08.4
# Ankylosing spondylitis	8: 712.4; 9: 720A; 10:	M45
# Polyarteritis nodosa and related condition (Incl. Kawasaki, Churg-Strauss syndrome, etc.)	8: 446, 9:	446A, 446B, 10:	M30
# Thrombotic microangiopathy	8: -; 9:	446G	10: M31.1
# Granulomatosis with polyangiitis (Wegenersâ€™s granulomatosis) 8:	446.20, 9:	446E, 10:	M31.3
# Microscopic polyangiitis 8/9:none; 10:	M31.7
# Henoch-Schonlein purpura	8:287.00; 9:	287A, 10:	D69.0
# Giant cell arteritis/ Polymyalgia rheumatica	8: 446.30,446.31,446.39,717.9	9: 446F, 725	10: M35.3, M31.5, M31.6
# Systemic lupus erythematosus	8: 734.1; 9:	710A; 10:	M32
# Polymyositis/dermatomyositis	8: 716.10, 716.00	,9: 710E, 710D; 10: M33.0, M33.1, M33.2, M33.9
# Systematic sclerosis (scleroderma)	8: 710.0, 734.0; 9:710B; 10:	M34
# SjÃ¶grenâ€™s syndrome	8:734.90,9:	710C, 10:	M35.0
# Mixed connective tissue disease	8:734.98, 734.91, 734.99;	9: 710X, 710W;	10: M35.1
# Behcetâ€™s syndrome	8:136.0;9:	136B; 10:	M35.2
# Pemphigus vulgaris	8: 694.00; 9:	694E; 10:	L10.0
# Bullous pemphigoid	8:694.05; 9:	694F;	10: L12
# Dermatitis herpetiformis	8:693.99; 9:	694A; 10:	L13.0
# Psoriasis	8:696	696A, 9:696B; 10: L40
# Alopecia areata 8:704.00	; 9:704A; 10:	L64
# Vitiligo	8:709.05	709A	L80
# Pernicious anemia	281.0	281A	D51.0
# Autoimmune hemolytic anemia	283.90, 283.92	283A	D59.0, D59.1
# Idiopathic thrombocytopenic purpura	287.3	287D	D69.3
# Acute disseminated encephalomyelitis	-	-	G04
# Anti-NMDA receptor encephalitis	-	-	G13.1
# Multiple sclerosis	340	340	G35
# Neuromyelitis optica and ADEM	341	341A	G36
# Guillain-BarrÃ© syndrome	354.01	357A	G61.0, G61.1, G61.8, G61.9
# Myasthenia gravis	733.0	358A	G70.0
# Primary biliary cirrhosis	-	571G	K74.3
# Crohnâ€™s disease	563.00	555	K50
# Ulcerative colitis	563.10, 569.02	556	K51
# Coeliac disease	269.00, 269.98	579A	K90.0
# Acute rheumatic fever and chorea	390-392	390-392	I00, I01.0, I01.1, I01.2, I01.8, I01.9, I02.0, I02.9
# Sarcoidosis	135	135	D86
# IgA nephropaty	580,582	580,582	N00,N01,N03,N05


autoimmune <- hdr %>%
   filter((icd.version==8 & grepl("^250|^242|^244|^245|^255|^099|^711|^712|^446|^287|^717|^734|^716|^710|
                                  ^734|^136|^694|^693|^696|^696A|^704|^709|^281|^283|^287|^340|^341|^354|^733
                                  |^563|^569|^269|^390|^391|^392|^135|^580|^582", diagnosis))
      | (icd.version==9 & grepl("^250|^242A|^242X|^244W|^244X|^245C|^245W|^255E|^099D|^711A|^714A|^714B|
                                ^714C|^714D|^720A|^725|^446A|^446B|^446G|^446E|^446F|^287A|^710A|^710B|
                                ^710E|^710D|^710C|^710X|^710W|^136B|^694E|^694F|^694A|^696B|^704A|709A|^281A|^283A
                                |^287D|^340|^341A|^357A|^358A|^517G|^555|^556|^579A|^390|^391|^392|^135|^580|^582", diagnosis))
      | (icd.version==10 & grepl("^E10|^E03|^E05|^E06|^E27|^M02|^M05|^M06|^M08|^M45|^M30|^M31|^M32|^M33|
                                 ^M34|^M35|^D69|^L10|^L12|^L13|^L40|^L64|^L80|^D51|^D59|^D69|^G04|^G13|^G35|^G36|^G61
                                 |^G70|^K74|^K50|^K51|^K90|^I00|^I01|^I02|^D86|^N00|^N01|^N03|^N05", diagnosis))) %>%
  mutate(ai = 1,
         date = ymd(as.character(admit.date))) %>%
  arrange(id, date) %>%
  group_by(id) %>%
  mutate(first.ai.date = first(date)) %>%
  slice(1) %>%
  select(id,ai,first.ai.date)


# ICD-10 only, need ICD 8 and 9

# Cardiovascular disease	I00-I59, I70-I99



# Stroke	I60-I69



# Cancer	C00-C97 (broad codes)
# Malignant neoplasms	ICD-9: 153.4, 162.3, 174.0, 183; ICD-10: C03, C06, C09, C15-C22, C24, C25, C30, C32, C34, C37, C38, C43, C44, C49, C50, C53, C54-C57, C61, C64, C65, C67, C69, C71, C73, C74, C76-C80
# Leukemia	ICD-9: 204; ICD-10: C92, C95
# Hodgkin's and non-Hodgkin's disease	ICD-10: C81-C83, C85
# Multiple myeloma and malignant plasma cell neoplasms	ICD-10: C90
# Carcinoma in situ of breast	ICD-10: D059
# Polycythemia vera	ICD-10: D459
# Myelodysplastic syndromes	ICD-10: D469
# Other neoplasms of uncertain or unknown behavior of lymphoid, hematopoietic, and related tissue	ICD-10: D471, D474, D479, D485


# Infections and parasitic conditions	A00-B99




# Medication use

```

### Step 9: Exposure set 6: Genetic risk factors
+ GRS of MDD, SCZ, BIP, IQ etc.

wait
```{r}

```

### Step 10: Cohort selection and observation period
```{r}

study <- x %>% 
  filter(birth.country == "Sweden" &
           !is.na(b.countyID) &
           substr(as.character(first_scz_date),1,4) %in% c(1973:2014) & age.second.scz >= 18) %>%
  summarise(n=n())


# add flag for died or emigrated during observation time

trsx <- trsx %>%
  mutate(deathdate = ymd(deathdate),
         emig.date = ymd(emig.date),
         drug.death = as.numeric((deathdate - drugdate)/365.25),
         drug.emig = as.numeric((emig.date - drugdate)/365.25),
         fu.indicator = ifelse(!is.na(drug.emig), 1,
                               ifelse(!is.na(drug.death), 2, 0)))

trsx$fu.indicator <- as.factor(trsx$fu.indicator)
levels(trsx$fu.indicator) <- c("end of drug reg", "emigrated", "died")


# how many and filter out those who emigrated or died before drug start

x <- scz %>% 
  filter(birth.country == "Sweden" &
           !is.na(b.countyID) &
           as.numeric(substr(as.character(birth.yr),1,4) %in% c(1942:1990)))

x %>%
  filter(drug.death <= 0) %>%
  summarise(n=n())
x %>%
  filter(drug.emig <= 0) %>%
  summarise(n=n())

x <- x %>%
  filter(drug.emig > 0 | is.na(drug.emig)) %>%
  filter(drug.death > 0 | is.na(drug.death))

x$deathdate <- as.character(x$deathdate)
x$emig.date <- as.character(x$emig.date)

x <- scz %>%
  mutate(fu.date = ifelse((is.na(emig.date) & !is.na(deathdate)), deathdate,
                          ifelse(!is.na(emig.date) & is.na(deathdate), emig.date,
                          ifelse(!is.na(emig.date) & !is.na(deathdate), emig.date, "2014-12-31"))))

# some have fu.dates past 2014-12-31
# reason is that some registers (death and migration) have linkage past that point
# edit these to state "2014-12-31"

x <- x %>%
  mutate(fu.date = ifelse(str_detect(fu.date, "2015"), "2014-12-31", fu.date))

x %>% filter(fu.date > "2014-12-31") %>% summarise(n=n())

# check good

x <- x %>%
  mutate(fu.date = ymd(fu.date),
         deathdate = ymd(deathdate),
         emig.date = ymd(emig.date))

x <- x %>%
  mutate(obs.time = as.numeric((fu.date - drugdate)/365.25))

# add flag for died or emigrated during observation time

x <- x %>%
  mutate(fu.indicator = ifelse(!is.na(drug.emig), 1,
                               ifelse(!is.na(drug.death), 2, 0)))


x$fu.indicator <- as.factor(x$fu.indicator)
levels(x$fu.indicator) <- c("end of drug reg", "emigrated", "died")

x %>% group_by(fu.indicator) %>% summarise(n=n())
x %>% summarise(n=n(), median_obstime = median(obs.time), mean_obstime = mean(obs.time))

```

### SPLIT below to new RMD
### Step 11: Outcomes

need dates for all of these:
+ the number of psychiatric hospitalizations and outpatient contacts - have from hospital discharge register
+ the number of somatic healthcare utilization - have from hospital discharge register:
  + somatic defintion?
+ indication of 2nd or 3rd line treatments (pharmacological augmentation, ECT, TMS, DBS, clozapine) - drug reg for clozapine not sure about ECT/TMS/DBS
+ suicide completed (death reg) or suicide attempt (HDR)

```{r}
# after the first-Scz-date (month/year)-use 15 as 

```




### Step 12: Analysis: Logistic regression
```{r}
# make sure all variables have no missing data (i.e., assign 'na' if not known)

# Build the clozapine model - univariable
clo_uni_model <- glm(clo ~ relevel(sex,2), data = scz, family = "binomial")
summary(clo_uni_model)
sex<-as.data.frame(exp(cbind("Odds ratio" = coef(clo_uni_model), confint.default(clo_uni_model, level = 0.95)))) # if want to do Forest Plot


# Build the clozapine model - multivariable
clo_model_adj <- glm(clo ~ relevel(sex,2) + age.cohort.entry + sun2000niva.3 + psychinpt + psychoutpt + mdd + bip + sui + sud + weeksAdequate + INJweeks + POLYPHARMweeks + relevel(totalINJ_c,5) + totalORAL_c2 + fhx.scz.any + fhx.bip, data = scz, family = "binomial")
summary(clo_model_adj)
clo_multi_model <-as.data.frame(exp(cbind("Odds ratio" = coef(clo_model_adj), confint.default(clo_model_adj, level = 0.95))))


write.table(clo_multi_model,file="~/x.tsv") #edit in excel

         
#################################################
### FOREST PLOT FOR LOGISTIC REGRESSION #########
#################################################
       
# plot OR and 95%CI
# Create labels for plot
clo_uni <- fread("~/Documents/Projects/1.Tx.Resistance/CRIME3/data/crime3-univar-OR-clovsno.csv") %>%
  as_tibble()

clo_multi <- fread("~/Documents/Projects/1.Tx.Resistance/CRIME3/data/crime3-multivar-OR-clovsno.csv") %>%
  as_tibble() %>%
  rename(aOR=OR,
         aupper=upper,
         alower=lower)

clo <- full_join(clo_uni,clo_multi)

clo$Variable <- factor(clo$Variable, levels=rev(clo$Variable))
clo$adjust <- as.factor(clo$adjust)

dodge <- position_dodge(width=.5)

fp <- ggplot(data=clo) +
        geom_pointrange(aes(x=Variable, y=OR, ymin=lower, ymax=upper, color="Unadjusted"), position=dodge) + 
        geom_pointrange(aes(x=Variable, y=aOR, ymin=alower, ymax=aupper, color="Adjusted"), position=dodge) + 
        geom_hline(yintercept=1, lty=3) +  # add a dotted line at x=1 after flip
        coord_flip() +  # flip coordinates (puts labels on y axis)
        xlab("") + 
        ylab("Odds Ratio (95% CI)") +
        theme_bw() 

print(fp)
ggsave(file="~/CRIME3-logreg-clo.png",fp, width=8, height=5)


```
  
  
  
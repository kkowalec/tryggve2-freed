---
title: "Tryggve2 - Schizophrenia - Sweden - "
author: "Kaarina Kowalec, kaarina.kowalec@ki.se"
date: "October 2018"
output: 
  html_document: 
    fig_caption: yes
    theme: simplex
    highlight: zenburn
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Motivation and Overview

NOTE: NOT RUN

Examine variables associated with poor outcomes in schizophrenia, using first, the Swedish National Registers. In this report, I will present some initial coding for the analyses.

**Overview**

1. Import data
2. Create a dataframe with all necessary variables including exposures and outcomes
3. Analyses

**Exposures or Predictors**
1) Family of origin:
+ parental ages at birth ##LY
+ parental SES-education-occupation-income
+ birth order
+ family composition (number of parents/partners, parental criminality-incarceration, divorce, siblings, out-of-home placement)

2) Childhood trauma: ##LY
+ parental death
+ severe medical illness of parents/sibs

3) Education: done-kk
+ educational attainment
+ standardized testing in grade 9

4) Prior personal medical history:
+ comorbid disorders and medication use ##kk
+ prior personal medical history (somatic disorders) #kk
+ childhood hospitalization

5) Family history of psychiatric disorder ##kk
+ MD, BIP, psychosis, suicide in first-degree relatives

6) Genetic risk factors  NOT NOW
+ GRS of MDD, SCZ, BIP, IQ etc.

**Outcomes**
+ the number of psychiatric hospitalizations and outpatient contacts 
+ the number of somatic healthcare utilization
+ indication of 2nd or 3rd line treatments (pharmacological augmentation, ECT, TMS, DBS, clozapine) 
+ suicide or suicide attempt

**TO DOs**

cut down this doc into 4 separate RMD (eventually):
outcome
exposure/risk factors
basics
analysis

***

### Step 0: Load R packages
```{r R packages}
library(dplyr)
library(data.table)
library(ggplot2)
library(lubridate)

Sys.setenv(TZ="Europe/Stockholm")
```

### Step 1: Load data

Essential registers:
1. Hospital discharge data (hdr): all in-/out-patient hospitalisation codes, multiple lines per person, contains date of admission/discharge
2. Population register (pop): birth date, sex, birth country and Swedish birth county 
3. Death register (death): date of death, causes of death
4. Migration register (migrate): date of emigration/immigration
5. Multi-generation register (family): personnummer of index case and personnummer of child/parents
   - SWE: two files, parent & child
6. Medical birth register (birth): containing birth outcomes
7. Education (education): from LISA register; Svensk utbildningsnomenklatur (SUN) or Swedish education nomenclature

Other registers:
8. Grade 9 grades (grades): need?
9. Drug register (drug): All prescriptions redeemed between 7/2005-12/2014, with ATC codes/drug names)
10. Civil register (civil) - need

Add full path for each dataset <- REQUIRE EDITING on the file path
```{r specify file path}
# Required:
hdr.f <- "/Volumes/projects/S3/S3_Research/tryggve2/tryggve_psych_v_npr.tsv"
pop.f <- "/Volumes/projects/S3/S3_Research/tryggve2/tryggve_psych_v_indiv.tsv"
death.f <- "/Volumes/projects/S3/S3_Research/tryggve2/tryggve_psych_v_death.tsv"
migrate.f <- "/Volumes/projects/S3/S3_Research/tryggve2/tryggve_psych_v_migrate.tsv"
parent.f <- "/Volumes/projects/S3/S3_Research/tryggve2/tryggve_psych_v_parent.tsv"
child.f <- "/Volumes/projects/S3/S3_Research/tryggve2/tryggve_psych_v_child.tsv"
birth.f <- "/Volumes/projects/S3/S3_Research/tryggve2/tryggve_psych_v_mbr.tsv"
education.f <- "/Volumes/projects/S3/S3_Research/tryggve2/tryggve_psych_v_education.tsv"

# Other:
grades.f <- "/Volumes/projects/S3/S3_Research/tryggve2/tryggve_psych_v_grades.tsv"

```
Read in register data & Recode variables <- REQUIRE EDITING on the original variable names!

1.1 Hospital discharge data (hdr)
+ Required Variables:  
    + unique ID - rename as "id"  
    + date of admission - rename as "admit.date"
    + SOURCE: inpatient (=1) / outpatient (=2) - recode & rename as "inpatient" (inpatient=1; outpatient=0)
    + ICD version - rename as "icd.version"
    + ICD code - rename as "diagnosis"
```{r Read in hospital discharge register}
hdr <- fread(hdr.f, sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "admit.date"="DATUM", # date of admission
         "inpatient"="SOURCE", # inpatient (1) or outpatient (2)
         "icd.version"="ICD",
         "diagnosis"="DIA") %>% # ICD diagnostic code
  mutate(inpatient = ifelse(inpatient == 2, 0, 1)) #recode such that inpatient == 1 and outpatient == 0
```

1.2 Population register (pop)
+ Required Variables:  
  + unique ID - rename as "id"  
  + Sex (1 = male, 2 = female) - rename as "sex"  
  + Birth country - rename as "birth.country"
    + Sweden
    + Nordic not Sweden
    + EU28 not Nordic
    + Europe not EU28 not Nordic
    + Africa
    + North America
    + South America
    + Asia
    + Oceania
    + Soviet union
  + Birth county - rename as "birth.county" <-  skip
  + Birth year and month (yyyymm) - add 15th as day of the month & rename as "birth.date"
```{r read in population register}
pop <- fread(pop.f, sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "sex"="KON", # 1 = male, 2 = female
         "birth.country"="FODELSEGRUPP",
         "birth.county"="FODELSELAN",
         "birth.date"="FODELSEDATUM") %>%
  select(-birth.county) # remove birth county
  mutate(birth.date = paste(as.character(birth.date),"15",sep=""))  # add 15th as day of the month
# Q for KK: skip the following?? 
#  mutate(swe.birth.county = ifelse(swe.birth.county == 2, 1, swe.birth.county), # account for recategorisation as per Amir
#    swe.birth.county = ifelse(swe.birth.county == 11, 12, swe.birth.county),
#    swe.birth.county = ifelse(swe.birth.county %in% c(15, 16), 14, swe.birth.county))

# Q for KK: skip the following?? -NO
pop$birth.country <- as.factor(pop$birth.country)
levels(pop$birth.country) <-
  c(
    "Sweden",
    "Nordic not Sweden",
    "EU28 not Nordic",
    "Europe not EU28 not Nordic",
    "Africa",
    "North America",
    "South America",
    "Asia",
    "Oceania",
    "Soviet union"
  )

```

1.3 Death register (death)
+ Required Variables:  
  + unique ID - rename as "id"  
  + date of death (yyyymmdd) - rename as "dod"
```{r read in cause of death register}
death <- fread(death.f, sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "dod"="X_DODSDATUM")

# "death.cause"="CAUSE",
# "icd.version"="ICD_NR",
```

1.4 Migration register (migrate): date of emigration/immigration
+ Required Variables:
  + unique ID - rename as "id"  
  + Migration date (yyyymm) - add 15th as day of the month & rename as  "migration date"
  + Migration type (E=emigration, I=immigration) - rename as "migrate.type"
```{r read in migration register}
migrate <- fread(migrate.f, sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "migrate.date"="MDATUM",
         "migrate.type"="MTYP") %>% # (E=emigration, I=immigration)
  mutate(migrate.date = paste(as.character(migrate.date),"15",sep=""))
```

1.5 Multi-generation register (parent + child): personnummer of index case and personnummer of child/parents
+ Required Variables:
  + unique ID - rename as "id"  
  + ID of mother - rename as "mom.id"  
  + ID of father - rename as "dad.id"  
  + ID of child - rename as "kid.id"  
```{r read in multigeneration register}
parent <- fread(parent.f, sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "mom.id"="LOPNRMOR",
         "dad.id"="LOPNRFAR")

child <- fread(child.f, sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "kid.id"="LOPNRBARN")
```

1.6. Medical birth register (birth): containing birth outcomes
+ Required Variables:
  + Individual number (child) - rename as "kid.id"  
  + Individual number (mother) - rename as "mom.id"  
  + Mothers age at child birth (years) - rename as "mom.age.at.birth"  
```{r read in medical birth register}
birth <- fread(birth.f, sep="\t") %>%
  as_tibble() %>%
  rename("mom.id"="LOPNRMOR",
         "kid.id"="LOPNRBARN",
         "mom.age.at.birth"="MALDER")
```

1.7 Education (education): from LISA register
+ Required Variables:
  + unique ID - rename as "id"  
  + highest education level - rename as "edlevel"  
```{r read in education levels}
education <- fread(education.f, sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "edlevel"="SUN2000NIVA")
```

1.8 Grade 9 grades (grades)
+ Required Variables:
  + unique ID - rename as "id"  
  + graduation year - rename as "grad.yr"
  + ... <- TO FILL IN
```{r read in 9th grade scores} 
grades <- fread(grades.f, sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "grad.yr"="AVGAR",
         "avg.grade.fr88"="MEDELBETYG", # MEDELBETYG	Average grade (1988-1997, min-max=0,0-5,0)
         "merit.grade.fr98"="MERITVARDE") #  MERITVARDE	Merit rating (1998-, best 16 subjects, min-max=0-320)
```

Other registers <- SKIP FOR NOW 
```{r read in other}
civil <- fread("~/civil.tsv",sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "year"="AR",
         "civil.status"="CIVIL") %>%
  mutate(civil.status == case_when(civil.status == 1 ~ "Unmarried",
                                   civil.status == 2 ~ "Married man",
                                   civil.status == 3 ~ "Married woman, not cohabiting",
                                   civil.status == 4 | civil.status == "RP" ~ "Divorced",
                                   civil.status == 5 ~ "Widow/Widower",
                                   civil.status == 7 ~ "Married woman, cohabiting",
                                   civil.status == 8 ~ "Child, <18 years",
                                   civil.status == 9 ~ "Fosterchild, <18 years",
                                   civil.status == "EP" ~ "Surviving partner",
                                   civil.status == "G" ~ "Married",
                                   civil.status == "OG" ~ "Registered partner",
                                   civil.status == "SP" ~ "Divorced partner",
                                   civil.status == "â”€" ~ "Widow/Widower",
                                   TRUE ~ NA))

# ONLY AVAILABLE IN SWEDEN
# drug register not need by other countries 
drug <- fread("~/drug.tsv", sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR",
         "num.pkg"="ANTAL",
         "atc"="ATC",
         "ddd"="DDDFORP",
         "dose"="DOSER", #free text
         "disp.date"="EDATUM", # (yyyy-mm-dd)
         "pkg.size"="FORPSTL",
         "admin.route"="LFORMGRUPP", #  +formula of medication, grouped: 7=cutaneous/transdermal, 14=rectal, 12=unspecified, 9=oral/fast
         "drug.prod"="PRODUKTNAMN", # product name
         "strength_alf"="STYRKA_ALF",
         "strength_enh"="STYRKA_ENH",
         "strength_num"="STYRKNUMERIC")

```

### Step 2: Select SCZ cohort

2.1 Apply ICD codes to select SCZ cases 
```{r extract SCZ cases}
scz <- hdr %>%
  filter((icd.version != 10 & substr(diagnosis,1,3) == "295") |
          (icd.version == 10 & substr(diagnosis,1,3) == "F20") |
           (icd.version == 10 & substr(diagnosis,1,3) == "F25")) %>%
  mutate(scz = 1, # add disease status
         scz_date = ymd(admit.date)) %>% # turn the date (character now) into R date object
  add_count(id) %>%  # record the number of diagnoses per individual into variable "n"
  mutate(nsczcontacts = n, n=NULL) # n=null removes the original n variable
```

2.2 Record dates of first and second SCZ admission
```{r record first/second dx dates}
scz <- scz %>%
  arrange(id, scz_date) %>% # sort by ID, and dx date
  group_by(id) %>%  # group by ID
  mutate(first_scz_date = first(scz_date),  # record the date of first dx
         second_scz_date = nth(scz_date, 2)) %>%  # record the date of second dx
#         age.first.scz = as.numeric((first_scz_date - dob)/365.25),
#          age.second.scz = as.numeric((second_scz_date - dob)/365.25)
  ungroup()  # ungroup by ID

# if no second_scz_date, exclude them
```

2.3 Divide inpatient/outpatient dx
```{r inpatient vs outpatient}
# scz hospitalisations
sczinpt <- scz %>%
  filter(inpatient == 1) %>%
  add_count(id) %>%
  rename(nsczinpt = n) %>% 
  arrange(id) %>%
  group_by(id) %>%
  slice(1) %>%
  select(id, nsczinpt)

# scz outpatient visits
sczoutpt <- scz %>%
  filter(inpatient == 0) %>%
  add_count(id) %>%
  rename(nsczoutpt = n) %>% 
  arrange(id) %>%
  group_by(id) %>%
  slice(1) %>%
  select(id, nsczoutpt)

## need to add MVO code == 9 (for psychiatric in/outpatient) <- SKIP FOR NOW

# add back together
scz <- left_join(scz, sczinpt)
scz <- left_join(scz, sczoutpt, by = "id")

# change the NAs in inp/outp counts into 0
scz <- scz %>%
  mutate(nsczoutpt = ifelse(is.na(nsczoutpt), 0, nsczoutpt)) %>%
  mutate(nsczinpt = ifelse(is.na(nsczinpt), 0, nsczinpt))

```

### Step 3: Demographics: sex, death, emigration

3.1 Merge SCZ cohort with population register 
Add sex and birthdate to the SCZ
```{r}
scz.pop <- left_join(scz, pop, by="id") %>% 
  mutate(birth.date = ymd(birth.date)) %>% # birth date as date object 
  mutate(age.first.scz = as.integer((first_scz_date - birth.date)/365.25), # age at the first & second dx (as integer)
         age.second.scz = as.integer((second_scz_date - birth.date)/365.25)) 



###############################
# DOB #########################
###############################

# add 15 to date (14 to those in Feb, birth.yr = yyyymm)
scz$birth.yr <- as.character(scz$birth.yr)

scz <- scz %>%
  mutate(feb.birth = str_extract(birth.yr, "[:digit:]{4}02"))

scz$feb.birth <- sapply(scz$feb.birth, paste0, "14")

scz <- scz %>%
  mutate(feb.birth = gsub("NA14", NA, feb.birth))

scz$birth.yr <- sapply(scz$birth.yr, paste0, "15")

scz <- scz %>%
  mutate(birth.yr = ifelse(!is.na(feb.birth), feb.birth, birth.yr))
 
###############################
# Death #######################
###############################

death <- death %>%
  mutate(deathdate = ymd(as.character(X_DODSDAT))) %>%
  select(-X_DODSDAT)

scz <- left_join(scz, death) # join in data with main population

###############################
# Date of Emigration ##########
###############################

# select only those born in respective countries?

migrate <- migrate %>%
  filter(MTYP == "E")
  
migrate$MDATUM <- as.character(migrate$MDATUM)

migrate <- migrate %>%
  mutate(feb.birth = str_extract(MDATUM, "[:digit:]{4}02"))

migrate$feb.birth <- sapply(migrate$feb.birth, paste0, "14")

migrate <- migrate %>%
  mutate(feb.birth = gsub("NA14", NA, feb.birth))

migrate$MDATUM <- sapply(migrate$MDATUM, paste0, "15")

migrate <- migrate %>%
  mutate(MDATUM = ifelse(!is.na(feb.birth), feb.birth, MDATUM))

migrate <- migrate %>%
  mutate(emig.date = ymd(as.character(MDATUM))) %>%
  select(-MDATUM, -feb.birth)

migrate <- migrate %>%
  arrange(LOPNR, emig.date) %>%
  group_by(LOPNR) %>%
  mutate(emig.date = first(emig.date)) %>%
  ungroup()

migrate <- migrate %>%
  arrange(LOPNR) %>%
  group_by(LOPNR) %>%
  slice(1)

scz <- left_join(scz, migrate)
```

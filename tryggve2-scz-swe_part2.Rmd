---
title: "Tryggve2 - schizophrenia - Sweden (part 2)"
author: "Kaarina Kowalec, kaarina.kowalec@ki.se"
date: "November 2018"
output: 
  html_document: 
    fig_caption: yes
    theme: simplex
    highlight: zenburn
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Motivation and Overview

NOTE: NOT RUN

Examine variables associated with poor outcomes in schizophrenia, using first, the Swedish National Registers. In this report, I will present some initial coding for the analyses.

**Overview**

1. Import data
2. Create a dataframe with all necessary variables including exposures and outcomes
3. Analyses

**Exposures or Predictors**
1) Family of origin:
+ parental ages at birth ##LY
+ parental SES-education-occupation-income
+ birth order
+ family composition (number of parents/partners, parental criminality-incarceration, divorce, siblings, out-of-home placement)

2) Childhood trauma: ##LY
+ parental death
+ severe medical illness of parents/sibs

3) Education: done-kk
+ educational attainment
+ standardized testing in grade 9

4) Prior personal medical history:
+ comorbid disorders and medication use ##kk
+ prior personal medical history (somatic disorders) #kk
+ childhood hospitalization
+ congenital malformations

5) Family history of psychiatric disorder ##kk
+ MD, BIP, psychosis, suicide in first-degree relatives

6) Genetic risk factors  NOT NOW
+ GRS of MDD, SCZ, BIP, IQ etc.

**Outcomes**
+ the number of psychiatric hospitalizations and outpatient contacts 
+ the number of somatic healthcare utilization
+ indication of 2nd or 3rd line treatments (pharmacological augmentation, ECT, TMS, DBS, clozapine) 
+ suicide or suicide attempt

***

### Step 0: Load R packages
```{r R packages}
library(tidyverse)
library(data.table)
library(lubridate)
library(skimr)

Sys.setenv(TZ="Europe/Stockholm")
```

### Step 1: Load data
REQUIRE EDITING on the file path
```{r specify file path}
# edit the file path where you have stored the part 1 data
data.f <- "/Users/luyi/CloudStation/WORK_2018/MyProjects_with_Pat/GAPS_MDD/DATA/FREED/DATA/scz.part1.RData"

# load the R data
load(data.f) 
```

### Step 2: Per-diagnoses to per-individual 
REQUIRE CHECKING ICD codes 
```{r collapse to per-individual}
# 1. before collapsing the records, apply 2 criteria: 
#    1) refine ICD codes
    # ICD-8: 295, 2950-2954, 2956-2959, i.e. to remove 2955 (latent SCZ)
    # ICD-9: 295A-295E, 295G, 295H, 295W, 295X, i.e. just drop 295F (latent SCZ, other codes do not exit)
    # ICD-10: F20 (SCZ), F25 (SAD), F231 (Acute polymorphic psychotic disorder with symptoms of schizophrenia) & F232 (Acute schizophrenia-like psychotic disorder)
#    2) ≥2 diagnoses 

# select specific ICD codes
scz.v2 <- scz %>% 
  filter(
    (icd.version!=10 & grepl("^295$|^2950|^2951|^2952|^2953|^2954|^2956|^2957|^2958|^2959|^295A|^295B|^295C|^295D|^295E|^295G|^295H|^295W|^295X", diagnosis)) | 
    (icd.version==10 & grepl("^F20$|^F200|^F201|^F202|^F203|^F204|^F205|^F206|^F208|^F209|^F25$|^F250|^F251|^F252|^F258|^F259|^F231|^F232", diagnosis)) # apply the criteria #1
  )

# collapse to per-individual record and not per-admission
scz.perind <- scz.v2 %>% 
  arrange(id,scz_date) %>% 
  group_by(id) %>%
  slice(1) %>%
  filter(nsczcontacts >= 2) %>% # apply the criteria #2
  select(-admit.date:-icd.version, -scz_date) %>%
  ungroup()

rm(scz.v2)

# a quick summary of numeric variables
scz.perind %>% select_if(is.numeric) %>% skimr::skim()

# make list of scz cases and date of first contact for comparison with psych disorders below
first.scz.date <- scz.perind %>%
  select(id, first_scz_date, dob)
  
```

### Step 3: Exposure - Prior psychiatric history
REQUIRE CHECKING ICD codes of psych disorders

Need to start with making a list of any one with a psych disorder in Sweden because will need for family history of psychiatric disorders.

We are only selecting those with a date (1) before first treatment contact and (2) before age 15 years (indicating childhood)

+ comorbid psych disorders/conditions: psych (adhd, asd, anx, bip, ed, mdd, ocd, ptsd, suds, suicides, id)
+ medication use (wait on this-not sure which drugs to focus on)

1. ADHD
```{r ADHD}

# first extract all individuals with ADHD diagnosis 
adhd <- hdr %>% 
  filter(  (icd.version==9 & grepl("^314|^314A|^314B|^314C|^314J|^314W|^314X", diagnosis)) # no icd codes for ADHD prior to ICD version 9
           | (icd.version==10 & grepl("^F90|^F900|^F901|^F908", diagnosis)) 
  ) %>%
  mutate(adhd = 1,
         admit.date = ymd(admit.date)) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  add_count(id) %>%  # record the number of diagnoses per individual into variable "n"
  rename(nadhdcontacts = n) %>% # rename n 
  mutate(first.adhd.date = first(admit.date)) %>% # record the first ADHD diagnosis date 
  slice(1) %>% 
  select(id,adhd,nadhdcontacts, first.adhd.date)

# then merge with individuals with SCZ 
scz.adhd <- inner_join(first.scz.date,adhd, by="id") %>% # inner join together with scz cases
  mutate(age.first.adhd = as.integer((first.adhd.date - dob)/365.25),
         adhd.childhood = ifelse(age.first.adhd <= 15, 1, 0), # only those with adhd dx before age 15 years
         adhd.pre.scz = ifelse(first.adhd.date < first_scz_date, 1, 0)  #  only those with adhd dx before scz contact
         ) %>%
  select(id,age.first.adhd,nadhdcontacts, adhd.childhood,adhd.pre.scz)

```
2. ASD
```{r ASD}
# first extract all individuals with ASD diagnosis 
asd <- hdr %>% 
  filter(  (icd.version==9 & grepl("^299A", diagnosis)) # no icd codes for asd prior to version 9
           | (icd.version==10 & grepl("^F840|^F841|^F845", diagnosis)) 
  ) %>%
  mutate(asd = 1,
         admit.date = ymd(admit.date)) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  add_count(id) %>%  # record the number of diagnoses per individual into variable "n"
  rename(nasdcontacts = n) %>% # rename n 
  mutate(first.asd.date = first(admit.date)) %>% # record the first diagnosis date
  slice(1) %>%
  select(id,asd,nasdcontacts,first.asd.date)

# then merge with individuals with SCZ 
scz.asd <- inner_join(first.scz.date,asd, by="id") %>% # inner join together with scz cases
  mutate(age.first.asd = as.integer((first.asd.date - dob)/365.25),
         asd.childhood = ifelse(age.first.asd <= 15, 1, 0), # only those with dx before age 15 years
         asd.pre.scz = ifelse(first.asd.date < first_scz_date, 1, 0)  #  only those with dx before scz contact
         ) %>%
  select(id, age.first.asd, nasdcontacts, asd.childhood, asd.pre.scz)

```
3. Anxiety
```{r Anxiety}
# first extract all individuals with anxiety diagnosis 
anx <- hdr %>% 
  filter(  (icd.version==8 & grepl("^300|^3000|^3002", diagnosis)) |
             (icd.version==9 & grepl("^300|^300A|^300C", diagnosis)) |
             (icd.version==10 & grepl("^F40|^F400|^F401|^F402|^F408|^F409|^F41|^F410|^F411|^F412|^F413|^F418|^F419", diagnosis)) 
  ) %>%
  mutate(anx = 1,
         admit.date = ymd(admit.date)) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  add_count(id) %>%  # record the number of diagnoses per individual into variable "n"
  rename(nanxcontacts = n) %>% # rename n 
  mutate(first.anx.date = first(admit.date)) %>%
  slice(1) %>%
  select(id, anx, nanxcontacts, first.anx.date)

# then merge with individuals with SCZ 
scz.anx <- inner_join(first.scz.date,anx, by="id") %>%  # inner join together with scz cases
  mutate(age.first.anx = as.integer((first.anx.date - dob)/365.25),
         anx.childhood = ifelse(age.first.anx <= 15, 1, 0), # only those with anx dx before age 15 years
         anx.pre.scz = ifelse(first.anx.date < first_scz_date, 1, 0)  #  only those with anx dx before scz contact
  ) %>%
  select(id, age.first.anx,nanxcontacts, anx.childhood, anx.pre.scz)

```
4. Bipolar
```{r Bipolar}
# first extract all individuals with bipolar diagnosis 
bip <- hdr %>%
  filter( ((icd.version==8) & grepl('^2961|^2963|^2968',diagnosis)) |
          ((icd.version==9) & grepl('^296|^269A|^269C|^2691|^296D|^2694|^296E|^2965|^296F|^2966|^296G|^2697|^269H|^2691|^26989|^269W|^26999|^269X',diagnosis)) | 
            ((icd.version==10) & grepl('^F30$|^F301|^F302|^F308|^F309|^F31|^F310|^F311|^F312|^F313|^F314|^F315|^F316|^F317|^F318|^F319',diagnosis)) ) %>%
  mutate(bip = 1,
         admit.date = ymd(admit.date)) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  add_count(id) %>%  # record the number of diagnoses per individual into variable "n"
  rename(nbipcontacts = n) %>% # rename n 
  mutate(first.bip.date = first(admit.date)) %>%
  slice(1) %>%
  select(id, bip, nbipcontacts, first.bip.date)

# then merge with individuals with SCZ 
scz.bip <- inner_join(first.scz.date,bip, by="id") %>%# inner join together with scz cases
  mutate(age.first.bip = as.integer((first.bip.date - dob)/365.25),
         bip.childhood = ifelse(age.first.bip <= 15, 1, 0), # only those with bip dx before age 15 years
         bip.pre.scz = ifelse(first.bip.date < first_scz_date, 1, 0)  #  only those with bip dx before scz contact
  ) %>%
  select(id, age.first.bip, nbipcontacts, bip.childhood, bip.pre.scz)
```
5. Eating disorder
```{r ED}
# first extract all individuals with eating disorder diagnosis 
ed <- hdr %>%
  filter(  (icd.version==8 & grepl("^7840|^3065", diagnosis))
           | (icd.version==9 & grepl("^307B|^307F", diagnosis))
           | (icd.version==10 & grepl("^F50|^F500|^F501|^F502|^F503|^F509", diagnosis))) %>%
  mutate(ed = 1,
         admit.date = ymd(admit.date)) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  add_count(id) %>%  # record the number of diagnoses per individual into variable "n"
  rename(nedcontacts = n) %>% # rename n 
  mutate(first.ed.date = first(admit.date)) %>%
  slice(1) %>%
  select(id, ed, nedcontacts, first.ed.date)

# then merge with individuals with SCZ 
scz.ed <- inner_join(first.scz.date,ed, by="id") %>% # inner join together with scz cases
  mutate(age.first.ed = as.integer((first.ed.date - dob)/365.25),
         ed.childhood = ifelse(age.first.ed <= 15, 1, 0), # only those with ed dx before age 15 years
         ed.pre.scz = ifelse(first.ed.date < first_scz_date, 1, 0)  #  only those with ed dx before scz contact
  ) %>%
  select(id, age.first.ed,nedcontacts, ed.childhood, ed.pre.scz)
```
6. Major depression
```{r MDD}
# first extract all individuals with depression diagnosis 
mdd <- hdr %>% 
  filter(  (icd.version==8 & grepl("^2960|^3004", diagnosis)) |
            (icd.version==9 & grepl("^296B|^311", diagnosis)) |
             (icd.version==10 & grepl("^F32|^F320|^F321|^F322|^F323|^F328|^F329|^F33|^F330|^F331|^F332|^F333|^F334|^F338|^F339", diagnosis)) 
  ) %>%
  mutate(mdd = 1,
       admit.date = ymd(admit.date)) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  add_count(id) %>%  # record the number of diagnoses per individual into variable "n"
  rename(nmddcontacts = n) %>% # rename n 
  mutate(first.mdd.date = first(admit.date)) %>%
  slice(1) %>%
  select(id, mdd, nmddcontacts, first.mdd.date)

# then merge with individuals with SCZ 
scz.mdd <- inner_join(first.scz.date,mdd, by="id") %>% # inner join together with scz cases
  mutate(age.first.mdd = as.integer((first.mdd.date - dob)/365.25),
         mdd.childhood = ifelse(age.first.mdd <= 15, 1, 0), # only those with mdd dx before age 15 years
         mdd.pre.scz = ifelse(first.mdd.date < first_scz_date, 1, 0)) %>% #  only those with mdd dx before scz contact
  select(id, age.first.mdd,nmddcontacts, mdd.childhood, mdd.pre.scz)

```
7. Obsessive-Compulsive Disorder
```{r OCD}
# first extract all individuals with OCD diagnosis 
ocd <- hdr %>%
   filter((icd.version==8 & grepl("^3003", diagnosis))
      | (icd.version==9 & grepl("^300D", diagnosis))
      | (icd.version==10 & grepl("^F42|^F420|^F421|^F422|^F428|^F429", diagnosis))) %>%
  mutate(ocd = 1,
         admit.date = ymd(admit.date)) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  add_count(id) %>%  # record the number of diagnoses per individual into variable "n"
  rename(nocdcontacts = n) %>% # rename n 
  mutate(first.ocd.date = first(admit.date)) %>%
  slice(1) %>%
  select(id, ocd, nocdcontacts, first.ocd.date)

# then merge with individuals with SCZ 
scz.ocd <- inner_join(first.scz.date,ocd, by="id") %>% # inner join together with scz cases
  mutate(age.first.ocd = as.integer((first.ocd.date - dob)/365.25),
         ocd.childhood = ifelse(age.first.ocd <= 15, 1, 0), # only those with ocd dx before age 15 years
         ocd.pre.scz = ifelse(first.ocd.date < first_scz_date, 1, 0)  ) %>% #  only those with ocd dx before scz contact
  select(id,age.first.ocd, nocdcontacts, ocd.childhood, ocd.pre.scz)
```
8. Post-traumatic stress disorder
```{r PTSD}
# first extract all individuals with PTSD diagnosis 
ptsd <- hdr %>% 
  filter(  (icd.version==8 & grepl("^307", diagnosis)) |
             (icd.version==9 & grepl("^308|^308A|^308B|^308C|^308D|^308E|^308X|^309|^309A|^309B|^309C|^309D|^309E|^309W|^309X", diagnosis)) |
             (icd.version==10 & grepl("^F43|^F430|^F431|^F432|^F438|^F439", diagnosis)) ) %>%
  mutate(ptsd = 1,
         admit.date = ymd(admit.date)) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  add_count(id) %>%  # record the number of diagnoses per individual into variable "n"
  rename(nptsdcontacts = n) %>% # rename n 
  mutate(first.ptsd.date = first(admit.date)) %>%
  slice(1) %>%
  select(id, ptsd, nptsdcontacts, first.ptsd.date)

# then merge with individuals with SCZ 
scz.ptsd <- inner_join(first.scz.date,ptsd, by="id") %>% # inner join together with scz cases
  mutate(age.first.ptsd = as.integer((first.ptsd.date - dob)/365.25),
         ptsd.childhood = ifelse(age.first.ptsd <= 15, 1, 0), # only those with ptsd dx before age 15 years
         ptsd.pre.scz = ifelse(first.ptsd.date < first_scz_date, 1, 0) ) %>% #  only those with ptsd dx before scz contact
  select(id, age.first.ptsd, nptsdcontacts, ptsd.childhood, ptsd.pre.scz)

```
9. Substance use disorder
```{r SUD}
# first extract all individuals with SUD diagnosis 
suds <- hdr %>%
  filter(  (icd.version==8 & grepl("^303|^3030|^3031|^3032|^3039|^304|^3040|^3041|^3042|^3043|^3044|^3045|^3046|^3047|^3048|^3049", diagnosis))
           | (icd.version==9 & grepl("^303|^303A|^303X|^304|^304A|^304B|^304C|^304D|^304D|^304E|^304F|^304G|^304H|^304W|^304X|^305A|^305X", diagnosis))
           | (icd.version==10 & grepl("^F10|^F100|^F101|^F102|^F103|^F104|^F105|^F106|^F107|^F108|^F109|^F11|^F110|^F111|^F112|^F113|^F114|^F115|^F116|^F117|^F118|^F119|
                               F19|^F190|^F191|^F192|^F192|^F194|^F195|^F196|^F197|^F198|^F199", diagnosis)) ) %>%
  mutate(suds = 1,
         admit.date = ymd(admit.date)) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  add_count(id) %>%  # record the number of diagnoses per individual into variable "n"
  rename(nsudcontacts = n) %>% # rename n 
  mutate(first.suds.date = first(admit.date)) %>%
  slice(1) %>%
  select(id, suds, nsudcontacts, first.suds.date)

# then merge with individuals with SCZ 
scz.suds <- inner_join(first.scz.date,suds, by="id") %>% # inner join together with scz cases
  mutate(age.first.suds = as.integer((first.suds.date - dob)/365.25),
         suds.childhood = ifelse(age.first.suds <= 15, 1, 0), # only those with suds dx before age 15 years
         suds.pre.scz = ifelse(first.suds.date < first_scz_date, 1, 0)  #  only those with suds dx before scz contact
  ) %>%
  select(id, age.first.suds,nsudcontacts, suds.childhood, suds.pre.scz)
```
10. Suicide
```{r suicide}
# first extract all individuals with suicide attempts?  
sui <- scz.hdr %>%
   filter((icd.version==8 & grepl("^E950|^E951|^E952$|^E9520|^E9521|^E9529|^E953|^E954|^E955|^E956|^E957|^E958|^E959", diagnosis))
      | (icd.version==9 & grepl("^E95A|^E95B|^E95C|^E95D|^E95E|^E95F|^E95G|^E95H|^E95W|^E95X", diagnosis))
      | (icd.version==10 & grepl("^X60|^X61|^X62|^X63|^X64|^X65|^X66|^X67|^X68|^X69|^X70|^X71|^X72|^X73|^X74|^X75|^X76|^X77|^X78|^X79|^X80|^X81|^X82|^X83|^X84", diagnosis)) ) %>%
  mutate(sui = 1,
         admit.date = ymd(admit.date)) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  add_count(id) %>%  # record the number of diagnoses per individual into variable "n"
  rename(nsuicontacts = n) %>% # rename n 
  mutate(first.sui.date = first(admit.date)) %>%
  slice(1) %>%
  select(id, sui, nsuicontacts, first.sui.date)

# then merge with individuals with SCZ 
scz.sui <- inner_join(first.scz.date,sui, by="id") %>% # inner join together with scz cases
  mutate(age.first.sui = as.integer((first.sui.date - dob)/365.25),
         sui.childhood = ifelse(age.first.sui <= 15, 1, 0), # only those with sui dx before age 15 years
         sui.pre.scz = ifelse(first.sui.date < first_scz_date, 1, 0)  #  only those with sui dx before scz contact
  ) %>%
  select(id, age.first.sui,nsuicontacts, sui.childhood, sui.pre.scz)
```
11. Intellectual disability
```{r intellectual disability}
# first extract all individuals with intellectual disability  
int.dis <- hdr %>%
   filter((icd.version==8 & grepl("^310|^311|^312|^313|^314|^315", diagnosis))
      | (icd.version==9 & grepl("^317|^318|^319", diagnosis))
      | (icd.version==10 & grepl("^F70|^F71|^F72|^F73|^F74|^F75|^F76|^F77|^F78|^F79", diagnosis)) ) %>%
  mutate(int.dis = 1,
         admit.date = ymd(admit.date)) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  add_count(id) %>%  # record the number of diagnoses per individual into variable "n"
  rename(nintdiscontacts = n) %>% # rename n 
  mutate(first.intdis.date = first(admit.date)) %>%
  slice(1) %>%
  select(id, int.dis, nintdiscontacts, first.intdis.date)

# then merge with individuals with SCZ 
scz.intdis <- inner_join(first.scz.date,int.dis, by="id") %>% # inner join together with scz cases
  mutate(age.first.intdis = as.integer((first.intdis.date - dob)/365.25),
         intdis.childhood = ifelse(age.first.intdis <= 15, 1, 0), # only those with int.dis dx before age 15 years
         intdis.pre.scz = ifelse(first.intdis.date < first_scz_date, 1, 0)  #  only those with int.dis dx before scz contact
  ) %>%
  select(id, age.first.intdis, nintdiscontacts, intdis.childhood, intdis.pre.scz)
```

12. Merge all psych comorbidity
```{r All psych comorbidity}

psych.comorbid <- full_join(scz.bip, scz.anx, by = "id")
psych.comorbid <- full_join(psych.comorbid, scz.ptsd, by = "id")
psych.comorbid <- full_join(psych.comorbid, scz.adhd, by = "id")
psych.comorbid <- full_join(psych.comorbid, scz.ed, by = "id")
psych.comorbid <- full_join(psych.comorbid, scz.suds, by = "id")
psych.comorbid <- full_join(psych.comorbid, scz.ocd, by = "id")
psych.comorbid <- full_join(psych.comorbid, scz.asd, by = "id")
psych.comorbid <- full_join(psych.comorbid, scz.mdd, by = "id")
psych.comorbid <- full_join(psych.comorbid, scz.sui, by = "id") 
psych.comorbid <- full_join(psych.comorbid, scz.intdis, by = "id") 

rm(scz.bip,scz.anx,scz.ptsd,scz.adhd,scz.ed,scz.sui,scz.suds,scz.ocd,scz.asd,scz.mdd,scz.intdis) # remove original dataframes
 
```
13. Merge with SCZ per-indiv records & apply exclusion criteria
```{r merge with SCZ ind}
scz.perind <- left_join(scz.perind, psych.comorbid, by = "id")
rm(psych.comorbid)

# replace the NAs in comorbidity columns as 0
scz.perind <- scz.perind %>%
  mutate_at(vars(nbipcontacts:intdis.pre.scz),funs(replace(., is.na(.),0)))

# Exclusion criteria for SCZ cases
# For Bipolar disorder, need to exclude SCZ cases w BIP as the dominant 
# diagnosis (SCZ/SAD ≤ 5 and BIP contacts ≥ 5)  and
# Illicit drug or alcohol dependent predominated (SCZ/SAD ≤ 5 and 
# SUDS contacts ≥ 50) 

scz.perind <- scz.perind %>%
  mutate(case.exclu = case_when(nbipcontacts >= 5 & nsczcontacts <= 5 ~ "bip.main.dx",
                                nsczcontacts <= 5 & nsudcontacts >= 50 ~ "suds.main.dx",
                                TRUE ~ NA_character_)) %>%
  filter(is.na(case.exclu)) # keep only those where bip / suds not prominent
 
```
13. Medication use  --- wait until decide on specific drugs


### Step 4: Exposure - Family history of psychiatric disorder

To get at family history of psychiatric disorders, 
1) we first need lists of individuals with 11 disorders (adhd, asd, anx, bip, ed, mdd, ocd, ptsd, scz, suds, suicides)
2) create 4 new familial relationships: 1) mother, 2) father, 3) child, 4) full sibs
3) inner join w SCZ/SAD patient list with each of the 4 familial relationships and see if any have the disorders - prior to the index person's onset!!

1. FHx of SCZ <- NEED REVIEW
```{r linking SCZ patients with parents & children}
# add an indicator of SCZ first
scz.list <- scz %>%
  select(id) %>%
  mutate(scz=1)

# create list of 'parent' and 'child' with index ID being those w SCZ
scz.parent<- inner_join(scz.list, parent, by = "id")
scz.kid <- inner_join(scz.list, child, by = "id")

# list of mother IDs
mother <- scz.parent %>%
  select(mom.id) %>%
  distinct(mom.id) %>% 
  filter(!is.na(mom.id)) # remove the NA

# list of father IDs
father <- scz.parent %>%
  select(dad.id) %>%
  distinct(dad.id) %>% 
  filter(!is.na(dad.id)) # remove the NA

# list of kids IDs
kid <- scz.kid %>%
  select(kid.id) %>%
  distinct(kid.id)

# list of sib IDs
# first, pull out parents IDs 
tmp <- scz.parent %>% 
  filter(!is.na(dad.id) & !is.na(mom.id)) %>% 
  select(id, dad.id, mom.id) %>% 
  rename(index.id = id)
# then, merge with MGR to find out full siblings
sib <- left_join(tmp, parent, by=c("dad.id", "mom.id")) %>% 
  group_by(dad.id, mom.id) %>% 
  filter(index.id != id) %>% # remove the same person, i.e. only extract the siblings of the index person
  rename(sib.id = id, 
         id = index.id ) %>% 
  ungroup() %>%
  select(sib.id) %>%
  distinct()

```

```{r mother SCZ status}
# link mother's ID with SCZ list
mother.scz <- inner_join(mother, scz.list, by = c("mom.id" = "id")) %>%  
  rename(mom.scz = scz)

# get link between mother child
mother.scz <- left_join(mother.scz, parent, by = "mom.id")  # can have multiple records (mother had several children)

# get info on index person's scz
mother.scz <- left_join(mother.scz, scz.list, by = "id") 

mother.scz <- mother.scz %>%
  arrange(mom.id,desc(mom.scz)) %>% # so that "slice(1)" below selects mom.scz=1 if multiple kids 
  group_by(mom.id) %>%
  slice(1) %>%
  select(mom.scz, mom.id, id)
```

```{r father SCZ status}
# link father's ID with SCZ list
father.scz <- inner_join(father, scz.list, by = c("dad.id" = "id")) %>%
  rename(dad.scz = scz)

# get link between father child
father.scz <- left_join(father.scz, parent, by = "dad.id") # can have multiple records (mother had several children)

# get info on index person's scz
father.scz <- left_join(father.scz, scz.list, by = "id") # get info from child scz

father.scz <- father.scz %>%
  arrange(dad.id,desc(dad.scz)) %>% # so that "slice(1)" below selects dad.scz=1 if multiple kids 
  group_by(dad.id) %>%
  slice(1) %>%
  select(dad.scz, dad.id, id)
```

```{r kid SCZ status}
# link kid's ID with SCZ list
kids.scz <- inner_join(kid, scz.list, by = c("kid.id" = "id")) %>%
  rename(kid.scz = scz)

# get link betweenkid and index person
kids.scz <- left_join(kids.scz, child, by = "kid.id") 

# get info on index person's scz
kids.scz <- left_join(kids.scz, scz.list, by = "id")

kids.scz <- kids.scz %>%
  arrange(kid.id,desc(kid.scz)) %>% # so that "slice(1)" below selects kid.scz=1 if both parents
  group_by(kid.id) %>%
  slice(1) %>%
  select(kid.scz, kid.id, id)
```

```{r full sib SCZ status}
sibs.scz <- scz.parent %>% 
  filter(!is.na(dad.id) & !is.na(mom.id)) %>% # take only relationships with mom and dad ids available
  add_count(dad.id, mom.id) %>% # group by both parent's ids
  filter(n > 1) %>% # select individuals with same parents, i.e. full sibs
  rename(sibs.scz = n)

sibs.scz <- sibs.scz %>%
  arrange(dad.id, mom.id, sibs.scz) %>%
  group_by(id) %>%
  slice(1) %>%
  mutate(sibs.scz = 1) %>%
  select(id, sibs.scz) 

```

```{r derive FHx of SCZ}
# join back with kids and parents file 
scz.parent <- left_join(scz.parent, mother.scz, by = c("mom.id", "id"))
scz.parent <- left_join(scz.parent, father.scz, by = c("dad.id", "id"))
scz.kid <- left_join(scz.kid, kids.scz, by = c("kid.id", "id"))

# might be interested at some point as to whether or not someone had a kid - so add another variable 'fecund'
scz.kid <- scz.kid %>%
  mutate(fecund = 1) %>% 
  select(id, kid.scz, fecund) %>%
  arrange(id, desc(kid.scz)) %>% # remove multiple entries in kids (i.e. >1 kid)
  group_by(id) %>%
  slice(1)

#scz.parent$mom.scz <- as.integer(scz.parent$mom.scz)
#scz.parent$dad.scz <- as.integer(scz.parent$dad.scz)

# merge parents and kids scz 
fhx <- full_join(scz.parent, scz.kid,by="id")
fhx <- full_join(fhx, sibs.scz,by="id")

# add variable that indicates family history yes or no
scz.fhx <- fhx %>%
  mutate(fhx.scz = case_when(mom.scz==1 | dad.scz==1 | kid.scz==1 | sibs.scz==1 ~ 1,
                         mom.scz==0 | dad.scz==0 | kid.scz==0 | sibs.scz==0 ~ 0,
                         TRUE ~ NA_real_)) %>%  
  select(id,fhx.scz,fecund) # drop unwanted columns

# filter duplicates in case any 
scz.fhx <- scz.fhx %>%
  arrange(id,desc(fhx.scz)) %>%
  group_by(id) %>%
  slice(1) %>%
  select(id,fhx.scz,fecund)
  
# check the fhx compared with each relative's status using the following line
# table(scz.fhx$mom.scz, scz.fhx$fhx.scz, exclude=NULL)
```

```{r merge with SCZ ind}
# finally, merge with the main database of SCZ patients
scz <- left_join(scz, scz.fhx, by = "id")

## cleaning up

# keep fhx just in case need more details, but rename as 'fhx.scz.wide'
fhx -> fhx.scz.wide

# remove unwanted dataframes
rm(scz.fhx, mother.scz, father.scz, kids.scz, scz.parent, scz.kid, sibs.scz, fhx, mother,parent,child,father,kid,sib,tmp)  

```

2. FHx of other psych disorders <- GET BACK TO THIS
Note: 
1) lists of individuals with other psych disorders (adhd, asd, anx, bip, ed, mdd, ocd, ptsd, scz, suds, suicides) are ready, see Step 3. 
2) the 4 relationships are ready too, see Chunk 17 - linking SCZ patients with parents & children
3) do similar as did for FHx of SCZ

2.1 FHx of ADHD
2.2 FHx of ASD
2.3 FHx of Anxiety
2.4 FHx of Bipolar
2.5 FHx of Eating disorder
2.6 FHx of Major depression
2.7 FHx of Obsessive-Compulsive Disorder
2.8 FHx of Post-traumatic stress disorder
2.9 FHx of Substance use disorder
2.10 FHx of Suicide

### Step 5: Exposure - Prior medical history
We are only selecting those with a date (1) before first treatment contact and (2) before age 15 years (indicating childhood):
+ comorbid somatic disorders: autoimmune, infections, cancer, CVD
+ medication use (wait on this-not sure which drugs to focus on)
```{r year 9 grade}
# generate a list of SCZ cases IDs, export this list and import to SAS (or where ever the original register files are) and extract the full hospital discharge register for only those SCZ cases

scz.list <- scz %>%
  select(id)

scz.hdr <- fread("~/tryggve_psych_v_hdr_scz.tsv", sep="\t") %>%
  as_tibble() %>%
  rename(id=LOPNR,
         admit.date=DATUM, # date of admission
         inpatient=SOURCE, # inpatient (1) or outpatient (2)
         icd.version=ICD, # icd version - 8, 9 or 10
         diagnosis=DIA,# ICD diagnostic code
         admit.num=X_PID, # per individual ID per admission
         dx.code.num=X_DID) %>% # primary vs. other ICD dx codes, i.e. H01 = primary, all others = secondary
  mutate(inpatient = ifelse(inpatient == 2, 0, 1)) #recode such that inpatient == 1 and outpatient == 0


# make list of scz cases and date of first contact for comparison with psych disorders below
first.scz.date <- scz %>%
  select(id, first_scz_date, dob)

#########################################
## Prior personal medical history (somatic disorders)
#########################################

# Autoimmune diseases from Song et al JAMA 2018 (autoimmune / PTSD overlap; Unnur V. group)

# Diabetes mellitus, insulin dependent icd-8: 250, icd-9: 250, 242A, icd-10: E10
# Autoimmune thyroid disease ICD8: 242.00, 242.09, 244, 245.03; ICD9: 242A, 242X, 244W, 244X, 245C, 245W; ICD10: E03.5, E03.9, E05.0, E05.5, E05.9, E06.3, E06.5
# Addison’s disease ICD8: 255.1	ICD9: 255E, ICD10:	E27.1, E27.2
# Autoimmune polyglandular syndrome	8: 258.10; 9:	258B; 10:	E31.0
# Reactive arthritis (Reiter’s syndrome)	8: 099.3, 711.1	9: 099D, 711A	10: M02.3, M02.8, M02.9
# Rheumatoid arthritis	8: 712.00, 712.10, 712,20, 712,39, 712.38	9: 714A-D, 719D; 10: M05, M06, M08.0, M08.1, M08.2, M08.3, M08.4
# Ankylosing spondylitis	8: 712.4; 9: 720A; 10:	M45
# Polyarteritis nodosa and related condition (Incl. Kawasaki, Churg-Strauss syndrome, etc.)	8: 446, 9:	446A, 446B, 10:	M30
# Thrombotic microangiopathy	8: -; 9:	446G	10: M31.1
# Granulomatosis with polyangiitis (Wegeners’s granulomatosis) 8:	446.20, 9:	446E, 10:	M31.3
# Microscopic polyangiitis 8/9:none; 10:	M31.7
# Henoch-Schonlein purpura	8:287.00; 9:	287A, 10:	D69.0
# Giant cell arteritis/ Polymyalgia rheumatica	8: 446.30,446.31,446.39,717.9	9: 446F, 725	10: M35.3, M31.5, M31.6
# Systemic lupus erythematosus	8: 734.1; 9:	710A; 10:	M32
# Polymyositis/dermatomyositis	8: 716.10, 716.00	,9: 710E, 710D; 10: M33.0, M33.1, M33.2, M33.9
# Systematic sclerosis (scleroderma)	8: 710.0, 734.0; 9:710B; 10:	M34
# Sjögren’s syndrome	8:734.90,9:	710C, 10:	M35.0
# Mixed connective tissue disease	8:734.98, 734.91, 734.99;	9: 710X, 710W;	10: M35.1
# Behcet’s syndrome	8:136.0;9:	136B; 10:	M35.2
# Pemphigus vulgaris	8: 694.00; 9:	694E; 10:	L10.0
# Bullous pemphigoid	8:694.05; 9:	694F;	10: L12
# Dermatitis herpetiformis	8:693.99; 9:	694A; 10:	L13.0
# Psoriasis	8:696	696A, 9:696B; 10: L40
# Alopecia areata 8:704.00	; 9:704A; 10:	L64
# Vitiligo	8:709.05	709A	L80
# Pernicious anemia	281.0	281A	D51.0
# Autoimmune hemolytic anemia	283.90, 283.92	283A	D59.0, D59.1
# Idiopathic thrombocytopenic purpura	287.3	287D	D69.3
# Acute disseminated encephalomyelitis	-	-	G04
# Anti-NMDA receptor encephalitis	-	-	G13.1
# Multiple sclerosis	340	340	G35
# Neuromyelitis optica and ADEM	341	341A	G36
# Guillain-Barré syndrome	354.01	357A	G61.0, G61.1, G61.8, G61.9
# Myasthenia gravis	733.0	358A	G70.0
# Primary biliary cirrhosis	-	571G	K74.3
# Crohn’s disease	563.00	555	K50
# Ulcerative colitis	563.10, 569.02	556	K51
# Coeliac disease	269.00, 269.98	579A	K90.0
# Acute rheumatic fever and chorea	390-392	390-392	I00, I01.0, I01.1, I01.2, I01.8, I01.9, I02.0, I02.9
# Sarcoidosis	135	135	D86
# IgA nephropathy	580,582	580,582	N00,N01,N03,N05

autoimmune <- scz.hdr %>%
   filter((icd.version==8 & grepl("^250|^242|^244|^245|^255|^099|^711|^712|^446|^287|^717|^734|^716|^710|
                                  ^734|^136|^694|^693|^696|^696A|^704|^709|^281|^283|^287|^340|^341|^354|^733
                                  |^563|^569|^269|^390|^391|^392|^135|^580|^582", diagnosis))
      | (icd.version==9 & grepl("^250|^242A|^242X|^244W|^244X|^245C|^245W|^255E|^099D|^711A|^714A|^714B|
                                ^714C|^714D|^720A|^725|^446A|^446B|^446G|^446E|^446F|^287A|^710A|^710B|
                                ^710E|^710D|^710C|^710X|^710W|^136B|^694E|^694F|^694A|^696B|^704A|709A|^281A|^283A
                                |^287D|^340|^341A|^357A|^358A|^517G|^555|^556|^579A|^390|^391|^392|^135|^580|^582", diagnosis))
      | (icd.version==10 & grepl("^E10|^E03|^E05|^E06|^E27|^M02|^M05|^M06|^M08|^M45|^M30|^M31|^M32|^M33|
                                 ^M34|^M35|^D69|^L10|^L12|^L13|^L40|^L64|^L80|^D51|^D59|^D69|^G04|^G13|^G35|^G36|^G61
                                 |^G70|^K74|^K50|^K51|^K90|^I00|^I01|^I02|^D86|^N00|^N01|^N03|^N05", diagnosis))) %>%
  mutate(ai = 1,
         admit.date = ymd(as.character(admit.date))) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  mutate(first.ai.date = first(admit.date)) %>%
  slice(1) %>%
  select(id,ai,first.ai.date)

autoimmune <- inner_join(first.scz.date,autoimmune) # inner join together with scz cases

autoimmune <- autoimmune %>%
  mutate(age.first.ai = as.numeric((first.ai.date - dob)/365.25),
         ai.childhood = ifelse(age.first.ai <= 15, 1, 0), # only those with ai dx before age 15 years
         ai.pre.scz = ifelse(first.ai.date < first_scz_date, 1, 0)  #  only those with ai dx before scz contact
  ) %>%
  select(id,ai.childhood,ai.pre.scz)

scz <- left_join(scz, autoimmune)
rm(autoimmune)
scz <- scz %>%
  mutate(ai.childhood=ifelse(is.na(ai.childhood),0,ai.childhood),
         ai.pre.scz=ifelse(is.na(ai.pre.scz),0,ai.pre.scz))
         
# Cardiovascular disease 
#for icd 8 and 9: https://dimdi.de/static/de/klassi/icd-10-who/historie/icd-vorgaenger/icd-8/ICD-8-Systematik.htm
#for icd 10: use Death register publication by Brooke et al 2017 (J. Ludvigsson is co-author)
cvd <- scz.hdr %>%
   filter((icd.version==8 & grepl("^390|^391|^392|^393|^394|^395|^396|^397|^398|^400|^401|^402|^403|^404|^410|^411|^412|^413|^414|^42|^440|^441|
                                  ^442|^443|^444|^445|^446|^447|^448|^450|^451|^452|^453|^454|^455|^456|^457|^458", diagnosis))
      | (icd.version==9 & grepl("^390|^391|^392|^393|^394|^395|^396|^397|^398|^401|^402|^403|^404|^405|^410|^411|^412|^413|^414|^415|^416|^417|
                                ^418|^419|^42|^44|^451|^452|^453|^454|^455|^456|^457|^458|^459", diagnosis))
      | (icd.version==10 & grepl("^I0|^I1|^I2|^I3|^I4|^I5|^I7|^I8|^I9", diagnosis))) %>%
  mutate(cvd = 1,
         admit.date = ymd(as.character(admit.date))) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  mutate(first.cvd.date = first(admit.date)) %>%
  slice(1) %>%
  select(id,cvd,first.cvd.date)

cvd <- inner_join(first.scz.date,cvd) # inner join together with scz cases

cvd <- cvd %>%
  mutate(age.first.cvd = as.numeric((first.cvd.date - dob)/365.25),
         cvd.childhood = ifelse(age.first.cvd <= 15, 1, 0), # only those with cvd dx before age 15 years
         cvd.pre.scz = ifelse(first.cvd.date < first_scz_date, 1, 0)  #  only those with cvd dx before scz contact
  ) %>%
  select(id,cvd.childhood,cvd.pre.scz)

scz <- left_join(scz, cvd)
rm(cvd)
scz <- scz %>%
  mutate(cvd.childhood=ifelse(is.na(cvd.childhood),0,cvd.childhood),
         cvd.pre.scz=ifelse(is.na(cvd.pre.scz),0,cvd.pre.scz))

# Stroke	I60-I69 
stroke <- scz.hdr %>%
   filter((icd.version==8 & grepl("^430|^431|^432|^433|^434|^435|^436|^437|^438", diagnosis))
      | (icd.version==9 & grepl("^430|^431|^432|^433|^434|^435|^436|^437|^438", diagnosis))
      | (icd.version==10 & grepl("^I6", diagnosis))) %>%
  mutate(strk = 1,
         admit.date = ymd(as.character(admit.date))) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  mutate(first.strk.date = first(admit.date)) %>%
  slice(1) %>%
  select(id,strk,first.strk.date)

stroke <- inner_join(first.scz.date,stroke) # inner join together with scz cases

stroke <- stroke %>%
  mutate(age.first.strk = as.numeric((first.strk.date - dob)/365.25),
         strk.childhood = ifelse(age.first.strk <= 15, 1, 0), # only those with stroke dx before age 15 years
         strk.pre.scz = ifelse(first.strk.date < first_scz_date, 1, 0)  #  only those with stroke dx before scz contact
  ) %>%
  select(id,strk.childhood,strk.pre.scz)

scz <- left_join(scz, stroke)
rm(stroke)
scz <- scz %>%
  mutate(strk.childhood=ifelse(is.na(strk.childhood),0,strk.childhood),
         strk.pre.scz=ifelse(is.na(strk.pre.scz),0,strk.pre.scz))

# Cancer/(broad codes)	ICD8: 140-163,170-174,180-228,230-239
# Cancer/(broad codes)	ICD9: 140-165,170-176,179-208,210-239
# Cancer  ICD10 C00-C97 
cancer <- scz.hdr %>%
   filter((icd.version==8 & grepl("^14|^15|^160|^161|^162|^163|^170|^171|^172|^173|^174|^18|^19|
                                  ^20|^21|^220|^221|^222|^223|^224|^225|^226|^227|^228|^23", diagnosis))
      | (icd.version==9 & grepl("^14|^15|^160|^161|^162|^163|^164|^165|^170|^171|^172|^173|^174|^175|^176|^179|^18|^19|
                                  ^200|^201|^202|^203|^204|^205|^206|^207|^208|^21|^22|^230|^231|^232|^233|^234|^235|^236|^237|^238|^239", diagnosis))
      | (icd.version==10 & grepl("^C0|^C1|^C2|^C3|^C4|^C5|^C6|^C7|^C8|^C9", diagnosis))) %>%
  mutate(cancer = 1,
         admit.date = ymd(as.character(admit.date))) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  mutate(first.cancer.date = first(admit.date)) %>%
  slice(1) %>%
  select(id,cancer,first.cancer.date)

cancer <- inner_join(first.scz.date,cancer) # inner join together with scz cases

cancer <- cancer %>%
  mutate(age.first.cancer = as.numeric((first.cancer.date - dob)/365.25),
         cancer.childhood = ifelse(age.first.cancer <= 15, 1, 0), # only those with cancer dx before age 15 years
         cancer.pre.scz = ifelse(first.cancer.date < first_scz_date, 1, 0)  #  only those with cancer dx before scz contact
  ) %>%
  select(id,cancer.childhood,cancer.pre.scz)

scz <- left_join(scz, cancer)
rm(cancer)
scz <- scz %>%
  mutate(cancer.childhood=ifelse(is.na(cancer.childhood),0,cancer.childhood),
         cancer.pre.scz=ifelse(is.na(cancer.pre.scz),0,cancer.pre.scz))

# Infections and parasitic conditions	
# Köhler-Forsberg O, Petersen L, Gasse C, et al. 
# A nationwide study in Denmark of the association
# between treated infections and the subsequent risk of treated mental disorders in children and
# adolescents.
# JAMA Psychiatry. Published online December 5, 2018

infect <- scz.hdr %>%
  filter((icd.version!=10 & grepl("^038|^070|^000|^001|^002|^003|^004|^005|^006|^007|^008|^009|
                                  ^540|^680|^681|^682|^683|^684|^685|^686|^050|^051|^052|^053|^054|
                                  ^055|^056|^057|^110|^111|^035|^46|^47|^480|^481|^482|^483|
                                  ^484|^485|^486|^580|^590|^59500|^59501|^612|^620|^622|^381|^382|
                                  ^041|^042|^043|^031|^320|^322|^392|^474|^4509|^0451|^0452|^0453|^0454|^0455|
                                  ^0456|^0457|^0458|^0459|^46|^32300|^07199|
                                  ^07202|^07501|^07929|^09049|^05201|^05302|^05403|^05501|^05601|
                                  ^03609|^02701|^06209|^0621|^0622|^0623|^0624|^0625|^0626|^0627|^0628|
                                  ^0629|^063|^064|^065|^0949", diagnosis))
         | (icd.version==10 & grepl("^A40|^A41|^B15|^B16|^B17|^B18|^B19|^A00|^A01|^A02|^A03|^A04|^A05|^A06|^A07|^A08|^A09|^K35|
                                    ^L00|^L01|^L02|^L03|^L04|^L05|^L06|^L07|^L08|^B00|^B01|^B02|^B03|^B04|^B05|^B06|^B07|^B08|^B09|^A46|
                                    ^J0|^J10|^J11|^J12|^J13|^J14|^J15|^J16|^J17|^J18|^N00|^N10|^N300|^N390|
                                    ^N518B|^N70|^N71|^N72|^N76|^N770D|^N771B|^N771L|^H65|^H66|^H67|
                                    ^I02|^G00|^G01|^G02|^G03|^G04|^G05|^G06|^G07|^A17|^A8|^B003|^B004|^B010|^B011|^B020|^B021|^B050|
                                    ^B051|^B060|^B261|^B262|^B375|^B451|^B582|^B602|^A022C|^A548A|^A548D|^A521A|^A521B|^A229C|
                                    ^A321|^A504|^A390|^E236A", diagnosis))) %>%
  mutate(infect = 1,
         admit.date = ymd(as.character(admit.date))) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  mutate(first.infect.date = first(admit.date)) %>%
  arrange(id, first.infect.date) %>%
  mutate(infect.type = case_when( (icd.version!="10" & grepl("^038",diagnosis)) |
                                    (icd.version=="10" & grepl("^A40|^A41",diagnosis)) ~ "sepsis",
                                  (icd.version!="10" & grepl("^070",diagnosis)) |
                                    (icd.version=="10" & grepl("^B15|^B16|^B17|^B18|^B19",diagnosis)) ~ "hepatitis",
                                  (icd.version!="10" & grepl("^000|^001|^002|^003|^004|^005|^006|^007|^008|^009|^540",diagnosis)) | 
                                    (icd.version=="10" & grepl("^A00|^A01|^A02|^A03|^A04|^A05|^A06|^A07|^A08|^A09|^K35",diagnosis)) ~ "gastrointestinal",
                                  (icd.version!="10" & grepl("^680|^681|^682|^683|^684|^685|^686|^050|^051|^052|^053|
                                                                  ^054|^055|^056|^057|^110|^111|^035",diagnosis)) |
                                    (icd.version=="10" & grepl("^L00|^L01|^L02|^L03|^L04|^L05|^L06|^L07|^L08|
                                                                    ^B00|^B01|^B02|^B03|^B04|^B05|^B06|^B07|^B08|^B09|^A46",diagnosis)) ~ "skin",
                                  (icd.version!="10" & grepl("^46|^47|^480|^481|^482|^483|^484|^485|^486",diagnosis)) |
                                    (icd.version=="10" & grepl("^J0|^J10|^J11|^J12|^J13|^J14|^J15|^J16|^J17|^J18",diagnosis)) ~ "respiratory",
                                  (icd.version!="10" & grepl("^580|^590|^59500|^59501",diagnosis)) |
                                    (icd.version=="10" & grepl("^N00|^N10|^N300|^N390",diagnosis)) ~ "urological",
                                  (icd.version!="10" & grepl("^612|^620|^622",diagnosis)) |
                                    (icd.version=="10" & grepl("^N518B|^N70|^N71|^N72|^N76|^N770D|^N771B|^N771L",diagnosis)) ~ "genital", 
                                  (icd.version!="10" & grepl("^381|^382",diagnosis)) |
                                    (icd.version=="10" & grepl("^H65|^H66|^H67",diagnosis)) ~ "otitis media", 
                                  (icd.version!="10" & grepl("^041|^042|^043|^031|^320|^322|^392|^474|^4509|^0451|^0452|^0453|^0454|^0455|
                                                                  ^0456|^0457|^0458|^0459|^46|^32300|
                                                                  ^07199|^07202|^07501|^07929|^09049|^05201|^05302|^05403|
                                                                  ^05501|^05601|^03609|^02701|^06209|^0621|^0622|^0623|^0624|^0625|
                                                                  ^0626|^0627|^0628|^0629|^063|^064|^065|^0949",diagnosis)) |
                                    (icd.version=="10" & grepl("^I02|^G00|^G01|^G02|^G03|^G04|^G05|^G06|^G07|^A17|^A8|^B003|
                                                                  ^B004|^B010|^B011|^B020|^B021|^B050|^B051|^B060|^B261|^B262|
                                                                  ^B375|^B451|^B582|^B602|^A022C|^A548A|^A548D|^A521A|^A521B|^A229C|
                                                                  ^A321|^A504|^A390|^E236A",diagnosis)) ~ "CNS")  
         ) %>%
  slice(1) %>%
  select(id,infect,first.infect.date,infect.type)

infect <- left_join(first.scz.date,infect) #  join together with scz cases

infect <- infect %>%
  mutate(age.first.infect = as.numeric((first.infect.date - dob)/365.25),
         #infect.childhood = ifelse(age.first.infect <= 15, 1, 0), # only those with infect dx before age 15 years
         infect.pre.scz = ifelse(first.infect.date < first_scz_date, 1, 0)) %>%  #  only those with infect dx before scz contact
 filter(infect.pre.scz ==1) %>%
 select(id,infect.pre.scz,infect.type)

scz <- left_join(scz, infect)
scz <- scz %>%
  mutate(#infect.childhood=ifelse(is.na(infect.childhood),0,infect.childhood),
         infect.pre.scz=ifelse(is.na(infect.pre.scz),0,infect.pre.scz),
         infect.type=ifelse(is.na(infect.type),NA,infect.type))

rm(infect)

```
### Step 6: Exposure - Education
+ Year 9 grades
+ Educational attainment

```{r year 9 grade}
# check summary of year 9 grade by year
grades %>% 
  group_by(grad.yr) %>% 
  summarise(mean(avg.grade.fr88), sum(is.na(avg.grade.fr88)), mean(merit.grade.fr98), sum(is.na(merit.grade.fr98)))
# so the variable 'avg.grade.fr88' is grading system used in between 1988-1997
#   - better to know how many subjects were the average grade based off <- find out more.
# and the varialbe 'merit.grade.fr98' is grading system used in 1998+

# need to: 
# 0) divide the dataset into 2 subsets according to the two grading systems
# 1) (only for the old grading system) the range of 'avg.grade.fr88' should be 1-5, not 0-5, 0s should be set as missing 
# 2) keep only one record for each individual (i.e. remove other records for duplicate IDs)
# 3) standardise the grades by year

# for years between 1988-1997
grades.1 <- grades %>% 
  filter(grad.yr <= 1997) %>%  # correspond to #0 in the above list (part1)
  mutate(avg.grade.fr88 = ifelse(avg.grade.fr88==0, NA, avg.grade.fr88)) %>% # correspond to #1 
  filter(!is.na(avg.grade.fr88)) %>%  # keep only non-missing records
  arrange(id, grad.yr) %>% # order by ID & year
  group_by(id) %>% # group by ID
  slice(1) %>% # correspond to #2. This will keep record from the earliest year if spanning multiple years, random if same year
  ungroup() %>% # remove ID-grouping
  group_by(grad.yr) %>% # change grouping variable to be the assessment year
  mutate(grade.std_yr = scale(avg.grade.fr88)) %>% # correspond to #3. For each assessment year (group variable), apply 'scale' funcation to the score, i.e. to standardise the score by each year, and then rename as 'grade.std_yr' (grade standardised by year)
  ungroup() %>% # remove year-grouping
  select(id, grad.yr, grade.std_yr) # select only the required column 
# complex codes above, but have tested bits by bits, so it should work. 
 
# for years between 1998-
grades.2 <- grades %>% 
  filter(grad.yr >= 1998) %>%  # correspond to #0 in the above list (part2)
#  mutate(avg.grade.fr88 = ifelse(avg.grade.fr88==0, NA, avg.grade.fr88)) %>% # correspond to #1 - skip b/c not required for merit.grade.fr98
  filter(!is.na(merit.grade.fr98)) %>%  # keep only non-missing records
  arrange(id, grad.yr) %>% # order by ID & year
  group_by(id) %>% # group by ID
  slice(1) %>% # correspond to #2. This will keep record from the earliest year if spanning multiple years, random if same year
  ungroup() %>% # remove ID-grouping
  group_by(grad.yr) %>% # change grouping variable to be the assessment year
  mutate(grade.std_yr = scale(merit.grade.fr98)) %>% # correspond to #3. For each assessment year (group variable), apply 'scale' funcation to the score, i.e. to standardise the score by each year, and then rename as 'grade.std_yr' (grade standardised by year)
  ungroup() %>% # remove year-grouping
  select(id, grad.yr, grade.std_yr) # select only the required column 

# combine the two parts
grades.std <- bind_rows(grades.1, grades.2) %>% 
  # remove further duplicate ID if any
  arrange(id, grad.yr) %>%
  group_by(id) %>% 
  slice(1) %>%
  ungroup() %>% 
  select(id, grade.std_yr)

# check the histogram of the Year 9 grades which has been standardised by year
# n.b. not necessarily a normal distribution as we've standardised by each year (only normally distributed within each year)
hist(grades.std$grade.std_yr) 

```

```{r merge grade with SCZ ind}
# finally, merge with the main database of SCZ patients
scz.perind <- left_join(scz.perind, grades.std, by = "id")

# cleaning up
# remove unwanted data frames
rm(grades.1, grades.2, grades.std)

```

```{r educational attainement}
# Background: specific coding for education level in Sweden: www.scb.se/statistik/UF/UF0506/SUN2000English%20version.doc
# The first digit gives a broad indication of the level of education and corresponds to ‘level’ in ISCED 97. 
# first digit in ISCED 97                                       conversion to EduYear (see below for details)
# 6	Postgraduate education                                      -> EduYear = 22
# 5	Post-secondary education, two years or longer               -> EduYear = 19
# 4	Post-secondary education, less than two years               -> EduYear = 15
# 3	Upper secondary education                                   -> EduYear = 13
# 2	Primary and lower secondary education, 9 (or 10) years      -> EduYear = 10
# 1	Primary and lower secondary education, less than 9 years    -> EduYear = 7
# (0	Pre-primary education)
# 999 empty/missing

# How to convert ISCED to EduYears?
# a) convert according to the duration specified for each code (3-digits), see the .doc file for more details
# b) use the international standard, e.g. the one used in the educational attainment GWAS https://www.nature.com/articles/nature17671 (Okbay A, et al. Nature 2016). esp. S.Tab 1.2 for conversion and S.Tab 1.3 for descriptions on Swedish data (twingene, salty)
# Use b) for now, see the above conversion

# examine the distinct levels of education and the counts in each level
education %>% count(edlevel)

# Need to: 
# 1) set 999 as missing
# 2) take the first digit in the 'edlevel' variable, and recategorize according to the conversion above
# 3) standardise the converted EduYear by birth year and sex

# need birth year and sex from population register
pop <- fread(pop.f, sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR","sex"="KON", # 1 = male, 2 = female
         "birth.country"="FODELSEGRUPP", # country of birth
         "birth.county"="FODELSELAN", # county of birth in each country
         "dob"="FODELSEDATUM") %>%
  select(-birth.county) %>% # drop birth county
  mutate(swe.born = case_when(birth.country == 0 ~ 1,birth.country != 0 ~ 0)) %>% # add an indicator of Sweden born (1=SWE, 0=non-SWE, NAs=unknown)
  mutate(dob = paste(as.character(dob),"15",sep=""))  # add 15th as day of the month

education <- left_join(education, pop, by="id")

# recategoris
education <- education %>%
  mutate(edlevel = as.integer(substr(edlevel, 1, 1))) %>% # correspond to #2 above, take the first digits in 'edlevel'
  mutate(EduYear = case_when(edlevel == 1 ~ 7,  # correspond to #2 above, recategorize
                             edlevel == 2 ~ 10,
                             edlevel == 3 ~ 13,
                             edlevel == 4 ~ 15,
                             edlevel == 5 ~ 19,
                             edlevel == 6 ~ 22,
                             edlevel == 9 ~ NA_real_, # correspond to #1, set 9 code as missing
                             TRUE ~ NA_real_)) %>% # all other coding (if any) will be set as missing
  filter(!is.na(EduYear) & !is.na(dob) & !is.na(sex)) %>%  # select only those with non-missing values in EduYear & in population register (b/c cannot apply #3 on missing data)
  filter(swe.born == 1) %>% # also select only those born in SWE
  mutate(birth.yr = substr(dob, 1, 4)) # extract the birth year
  
# before applying #3, check summary statistics of mean EduYears stratified by birthyr and sex (and swe.born)
edu.sum <- education %>% 
  group_by(birth.yr, sex) %>% 
  summarise(N=n(), EduYear.mean = mean(EduYear),EduYear.sd = sd(EduYear))

# quick plotting
# Note: do not plot beyond 1980, as many born after 1980 have not completed all education yet (mean EduYear starts to dip after this year)
ggplot(data=edu.sum, aes(x=as.integer(birth.yr), y= EduYear.mean, group = sex)) +
  geom_line(aes(color=as.factor(sex))) +
  geom_point(aes(color=as.factor(sex))) +
  labs(title = "Trend of mean EduYears by birth cohort (whole SWE population, stratified by sex)",
    x="Birth Year", y="Mean EduYear") +
  scale_x_continuous(limits = c(1911, 1980)) + 
  scale_colour_manual("Sex", labels = c("male","female"), values = 1:2)  
# clear trend, thus apply standardisation

### Corresponds to #3, standardize EduYear by birth year and sex
education.std <- education %>%
  group_by(birth.yr, sex) %>% 
  mutate(EduYr.std_byr_sex = scale(EduYear, center = TRUE, scale = TRUE)) %>% 
  ungroup() %>% 
  filter(!is.na(EduYr.std_byr_sex)) %>% # standardisation further generated some NAs? <- filter for now
  select(id, EduYr.std_byr_sex, birth.yr, sex) 

# can check whether standardisation is properly done using the following: 
education.std %>% 
  group_by(birth.yr, sex) %>% 
  summarise(mean(EduYr.std_byr_sex), sd(EduYr.std_byr_sex))

education.std <- education.std %>%
  select(id,EduYr.std_byr_sex)

# add in parental information to get parent educational attainment
scz.list <- scz %>%
  select(id) %>%
  mutate(scz=1)

scz.list <- left_join(scz.list,parent) # get MGR and parent info from previous 

# join in education metrics for index case (id)
scz.list <- left_join(scz.list,education.std, by=c("id"="id")) %>%
  rename(EduYr.id=EduYr.std_byr_sex)

# join in education metrics for mom of index case (mom.id)
scz.list <- left_join(scz.list,education.std, by=c("mom.id"="id")) %>%
  rename(EduYr.mom=EduYr.std_byr_sex)

# join in education metrics for dad of index case (dad.id)
scz.list <- left_join(scz.list,education.std, by=c("dad.id"="id")) %>%
  rename(EduYr.dad=EduYr.std_byr_sex)

scz.list <- scz.list %>%
  select(id, EduYr.id:EduYr.dad)

scz <- left_join(scz,scz.list)

rm(education,education.std,parent,pop,scz.list)

```

```{r merge edu year with SCZ ind}
# finally, merge with the main database of SCZ patients
scz <- left_join(scz, education.std, by = "id")

# cleaning up
# remove unwanted data frames
rm(education.std,education,pop,edu.sum)

```

### Step 7: Exposure - Family of origin
+ parental ages at birth
+ parental SES-education-occupation-income
+ birth order
+ family composition (number of parents/partners, parental criminality-incarceration, divorce, siblings, out-of-home placement)
```{r parental age at birth}

# need pre-defined dataset: scz.parent, which incl. variables of id, dob, dad.id, mom.id 
# (here does not need scz.kid)

# paternal age at child birth: 
parent.age <- left_join(scz.parent, pop, by=c( "dad.id" = "id")) # merge with population register to get dob for the dad
parent.age <- parent.age %>%
  select(id,dob.x:mom.id,dob.y) %>% # drop unwanted
  rename(index.dob = dob.x) %>% # index person's dob
  mutate(dad.dob = ymd(dob.y, truncated = 2)) %>% # father's dob
  mutate(paternal_age = as.integer((index.dob - dad.dob)/365.25)) # calculate father's age

# maternal age at child birth: 
parent.age <- left_join(parent.age, pop, by=c( "mom.id" = "id")) %>% # merge with population register to get dob for the mom
  select(id:paternal_age,dob) %>% 
  mutate(mom.dob = ymd(dob, truncated = 2)) %>% # mother's dob
  mutate(maternal_age = as.integer((index.dob - mom.dob)/365.25)) # calculate mother's age

# check summary statistics of mean maternal/paternal age stratified by birthyr 
parentage.sum <- parent.age %>% 
  mutate(birth.yr = substr(index.dob, 1, 4)) %>% # grab birth year
  group_by(birth.yr) %>% 
  summarise(
    N=n(), 
    paternal_age.mean = mean(paternal_age, na.rm=T),
    maternal_age.mean = mean(maternal_age, na.rm=T))

# reformat 
parentage.sum.2 <- parentage.sum %>%
  gather(key, mean , -birth.yr, -N) %>% 
  separate(key, c("parent", "tmp"), "\\.") %>% 
  select(-tmp)

# quick plotting
ggplot(data=parentage.sum.2, aes(x=as.integer(birth.yr), y= mean, group = parent)) +
  geom_line(aes(color=as.factor(parent))) +
  geom_point(aes(color=as.factor(parent))) +
  labs(title = "Parental age at child birth (SCZ/SAD patients as index)",
       x="Birth Year", y="Mean parental age at child birth") +
  scale_x_continuous(limits = c(1932, 1990)) +
  scale_y_continuous(limits = c(20, 37)) +
  theme(legend.title=element_blank()) 
# looks like parental age is fairly stable over the birth years. 
# no need to standardise by birth year. 


```

```{r merge parental age with SCZ ind}
# finally, merge with the main database of SCZ patients
parent.age <- parent.age %>% select(id,paternal_age,maternal_age)

scz.perind <- 
  left_join(scz.perind, parent.age, by = "id") 
# cleaning up
# remove unwanted data frames
rm(parentage.sum, parentage.sum.2)

```
### Step 8: Exposure - Childhood trauma
+ parental death: cause of death + multigen that occurs <= 15 year (to be consistent with previous definition of psych comorbidity during childhood)
+ severe medical illness = "severe" would be? age <= 15 years
```{r Childhood trauma}

# need pre-defined dataset: scz.parent, which incl. variables of id, dob, dad.id, mom.id 

# need to read in CauseDeath register again
death <- fread("~/death.tsv", sep="\t") %>%
  as_tibble() %>%
  rename("id"="LOPNR","dod"="X_DODSDATUM")


# index person's age at father's death: 
parent.death <- left_join(scz.parent, death, by=c( "dad.id" = "id")) %>% # merge with cause of death register to get dod for the dad
  select(id,dob:dod) %>% # drop unwanted
  rename(index.dob = dob) %>% # index person's date of birth
  mutate(dad.dod = ymd(dod), dod=NULL) %>% # father's date of death
  mutate(age_fatherdied = as.integer((dad.dod -index.dob )/365.25), # calculate index person's age when father died
         fatherdied.childhood = ifelse(age_fatherdied <= 15, 1, 0)) # decide whether father died at index's childhood, bf 15 yo 

# index person's age at mother's death: 
parent.death <- left_join(parent.death, death, by=c( "mom.id" = "id")) %>% # merge with cause of death register to get dod for the mom
  mutate(mom.dod = ymd(dod), dod=NULL) %>% # mother's date of death
  mutate(age_motherdied = as.integer((mom.dod -index.dob )/365.25), # calculate index person's age when mother died
         motherdied.childhood = ifelse(age_motherdied <= 15, 1, 0)) # decide whether mother died at index's childhood, bf 15 yo 

# define parental bereavement as childhood trauma
parent.death %<>% 
  # if either parent died before index person was 15 years old, then parental.breavement = 1
  # if neither of the parents died before index was 15, then parental.breavement = 0   # ???*CORRECT*:if any of the 4 relatives has no SCZ (Note: after the first condition was applied, this basically grabs those status of 0s or NAs), then fhx = 0
  # otherwise NAs
  mutate(parental.breavement = case_when(motherdied.childhood==1 | fatherdied.childhood==1 ~ 1,
                                         motherdied.childhood==0 & fatherdied.childhood==0 ~ 0,
                                         TRUE ~ NA_real_)) %>% 
  select(id, parental.breavement)

# need to check the cross-table
table(parent.death$parental.breavement, exclude=NULL)


```

```{r merge parental bereavement with SCZ ind}
# finally, merge with the main database of SCZ patients
scz.perind <- 
  left_join(scz.perind, parent.death, by = "id")

# cleaning up
# remove unwanted data frames
rm(parent.death)

```

```{r congenital malformations}
# add in congenital malformations
# load in medical birth data of child born
# needed a separate linkage of medical birth register b/c needed list of those born
# with congenital malform, and did not need info on mom

malf <- fread ("~/tryggve_psych_v_mbr_congenital.tsv") %>%
  as_tibble() %>%
  rename(id = LOPNRBARN,  # id of child born
           congen.malform=MISSB) %>% # had a congenital malformation yes (1) or no (0) or N/A
  filter(!is.na(congen.malform)) # only keep those with a valid yes or no

# combine with congenital malformations listed in Patient Register
# The codes used to identify congenital abnormalities were 740–759 in ICD-9 and Q00 to Q99 in ICD-10. 
# same as MISSB variable from MBR
# for this variable only, we dont care when diagnosed (i.e. before of after SCZ ok)

malf.2 <- scz.hdr %>%
   filter((icd.version!=10 & grepl("^74|^75", diagnosis))
      | (icd.version==10 & grepl("^Q", diagnosis))) %>%
  mutate(congen.malform = 1) %>%
  arrange(id, admit.date) %>%
  group_by(id) %>%
  slice(1) %>%
  select(id,congen.malform)

malf.3 <- full_join(malf,malf.2) # join both sources of congenital malformation data, some repeated

malf.3 <- malf.3 %>%
  arrange(id, desc(congen.malform)) %>% # remove duplicates, want record stating ever had congenital
  #malformation, discard record = 0 congenital malform
  group_by(id) %>%
  slice(1)

scz <- left_join(scz, malf.3) %>%
    mutate(congen.malform=ifelse(is.na(congen.malform),0,congen.malform))

rm(malf,malf.2,malf.3)



```

### Step 8: Exposure - Urbanicity at SCZ dx

+ does urban living at time of SCZ dx have an effect on SCZ poor outcomes?

+ living in a less urban area at time of SCZ dx is associated with Treatment Resistance as per
Wimberley et al 2016 Lancet Psych (opposite of SCZ risk)

+ split by Capital area (capital and suburb to the capital), Provincial area (>10 000 inhabitants) 
and Rural area

```{r urbanicity}
#how to categorize?
# available for 1982-2013
# SAMSNAMN = name of SAMS area
sams_code <- fread ("~/sams_areacodes.tsv", encoding="Latin-1") %>% # to parse Swedish letters correctly
  as_tibble() %>% 
  rename(yr=AR,
         sams=SAMS)
large_mun <- fread ("~/large_municipalities.csv") %>% # list from Amir Sariaslan
  as_tibble()

# extract county,first two digits of SAMS code - not enough - only gives county
# need further

sams_code <- sams_code %>%
  mutate(county=str_extract(sams, "[:digit:]{2}"),
         sams_mun = str_extract(sams, "[:digit:]{4}"))

sams_code$county <- as.integer(sams_code$county)

# get kommun names
kommun <- fread("~/kommunlankod.csv",sep=",") %>%
  as_tibble() 

sams_code <- left_join(sams_code,kommun, by=c("county"="Code"))

# some values are missing (e.g. 2, 15,16,11) b/c categorization has changed over time
# missing values are accurate

# AR	Year (yyyy)
# LOPNR	Individual number
# SAMS-area (ccmmnnnn, cc=county, ccmm=municipality)
sams <- fread ("~/tryggve_psych_v_sams_scz.tsv") %>%
  as_tibble() %>%
  select(id, AR, SAMS) %>%
  rename(yr=AR,
         sams=SAMS)

# join together
sams_scz <- left_join(sams,sams_code, by=c("sams","yr"))

# add flag for large mun
large_mun <- large_mun %>%
  mutate(large_municipalities_y = 1)

sams_scz <- left_join(sams_scz, large_mun, by=c("sams_mun"="large_municipalities"))
sams_scz <- sams_scz %>%
  mutate(large_municipalities_y = ifelse(is.na(large_municipalities_y),0,large_municipalities_y))
# join in date of first scz

sams_scz <- left_join(sams_scz,first.scz.date)

sams_scz <- sams_scz %>%
  mutate(first_scz_yr = substr(first_scz_date,1,4),
         dob_yr = substr(dob,1,4))

sams_scz$first_scz_yr <- as.integer(sams_scz$first_scz_yr)
sams_scz$dob_yr <- as.integer(sams_scz$dob_yr)

sams_scz <- sams_scz %>%
  mutate(time = yr-first_scz_yr) %>% # calc time b/w SAMS assessment and year of SCZ dx
  filter(time == "-1" | time == "1") %>% # take only those w SAMS within 1 year of dx
  arrange(id) %>% # select only 1 measure pp
  group_by(id) %>% # select only 1 measure pp
  slice(1) %>%
  select(id,SAMSNAMN,REGFAM,GRUPP, large_municipalities_y) # select needed variables

# samsname is essentially useless - there are >4000 types

# REGFAM
#    1     2     3     4     5 
#24926 18343  5568  1311  1065

# GRUPP
#    1     2     3     4     5     6     7     8     9    10 
# 11653  6238 15365  1148  3177  1364  4630  1098  4440  2100 

sams_scz <- sams_scz %>%
  select(id,large_municipalities_y) %>%
  rename(large_munc_sczdx=large_municipalities_y)

# link w SCZ files

scz <- left_join(scz,sams_scz)

rm(sams,sams_code,kommun,sams_scz,xscz,large_mun)

```
  
### Check missing data in all exposures
```{r missingness}
# check missing data on each variable
scz.perind %>% purrr::map_df(~ sum(is.na(.))) %>% gather(variable, N_missing)

```

### SAVE ALL THE DATA 
```{r save data}
save.image(file = "/Users/luyi/CloudStation/WORK_2018/MyProjects_with_Pat/GAPS_MDD/DATA/FREED/DATA/scz.part2.RData",compress = TRUE)
```
